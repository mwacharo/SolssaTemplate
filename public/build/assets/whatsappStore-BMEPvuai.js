import{E as L,i as y}from"./app-DXB07-fc.js";import{n as R}from"./toast-CJ1Ro0Yj.js";var x,$;function j(){if($)return x;$=1;let s={comma(e){return s.split(e,[","],!0)},space(e){let t=[" ",`
`,"	"];return s.split(e,t)},split(e,t,a){let r=[],i="",c=!1,d=0,p=!1,g="",u=!1;for(let l of e)u?u=!1:l==="\\"?u=!0:p?l===g&&(p=!1):l==='"'||l==="'"?(p=!0,g=l):l==="("?d+=1:l===")"?d>0&&(d-=1):d===0&&t.includes(l)&&(c=!0),c?(i!==""&&r.push(i.trim()),i="",c=!1):i+=l;return(a||i!=="")&&r.push(i.trim()),r}};return x=s,s.default=s,x}j();const z=L("whatsapp",{state:()=>({dialog:!1,conversation:[],replyMessage:"",showEmojiPicker:!1,attachment:{image:null,audio:null},messages:[],contacts:[],orders:[],templates:[],riders:[],agents:[],selectedRiders:[],selectedAgents:[],selectedContacts:[],selectedOrders:[],selectedTemplate:null,messageText:"",currentPage:1,perPage:20,totalMessages:0,totalOrders:0,loading:{conversation:!1,messages:!1,contacts:!1,orders:!1,templates:!1,sending:!1,importing:!1,savingTemplate:!1,deletingTemplate:!1,uploadingOrders:!1},showImportDialog:!1,showNewMessageDialog:!1,showTemplateDialog:!1,showOrderImportDialog:!1,showOrderMessageDialog:!1,activeTab:"messages",search:"",filterType:"all",filterStatus:"all",orderFilters:{status:"all",product:"",agent:"",zone:"",createdDateStart:null,createdDateEnd:null,deliveryDateStart:null,deliveryDateEnd:null,vendorRecallStart:null,vendorRecallEnd:null},errorMessage:"",successMessage:"",stats:{sent:0,delivered:0,read:0,failed:0,pending:0,totalOrders:0,pendingOrders:0,deliveredOrders:0},whatsappStatus:"Connected",csvFile:null,orderFile:null,orderTemplates:[]}),getters:{hasAttachment:s=>!!(s.attachment.image||s.attachment.audio),filteredContacts:s=>{if(!Array.isArray(s.contacts))return[];let e=[...s.contacts];return s.filterType!=="all"&&(e=e.filter(t=>t.type===s.filterType)),s.filterStatus!=="all"&&(e=e.filter(t=>t.status===s.filterStatus)),e},filteredOrders:s=>{if(!Array.isArray(s.orders))return[];let e=[...s.orders];return s.orderFilters.status!=="all"&&(e=e.filter(t=>t.status===s.orderFilters.status)),s.orderFilters.product&&(e=e.filter(t=>{var a;return(a=t.product_name)==null?void 0:a.toLowerCase().includes(s.orderFilters.product.toLowerCase())})),s.orderFilters.agent&&(e=e.filter(t=>{var a;return(a=t.agent_name)==null?void 0:a.toLowerCase().includes(s.orderFilters.agent.toLowerCase())})),s.orderFilters.zone&&(e=e.filter(t=>{var a;return(a=t.zone)==null?void 0:a.toLowerCase().includes(s.orderFilters.zone.toLowerCase())})),s.orderFilters.createdDateStart&&(e=e.filter(t=>{const a=new Date(t.created_at),r=new Date(s.orderFilters.createdDateStart);return a>=r})),s.orderFilters.createdDateEnd&&(e=e.filter(t=>{const a=new Date(t.created_at),r=new Date(s.orderFilters.createdDateEnd);return a<=r})),s.orderFilters.deliveryDateStart&&s.orderFilters.deliveryDateEnd&&(e=e.filter(t=>{if(!t.delivery_date)return!1;const a=new Date(t.delivery_date),r=new Date(s.orderFilters.deliveryDateStart),i=new Date(s.orderFilters.deliveryDateEnd);return a>=r&&a<=i})),s.orderFilters.vendorRecallStart&&s.orderFilters.vendorRecallEnd&&(e=e.filter(t=>{if(!t.vendor_recall_date)return!1;const a=new Date(t.vendor_recall_date),r=new Date(s.orderFilters.vendorRecallStart),i=new Date(s.orderFilters.vendorRecallEnd);return a>=r&&a<=i})),e},filteredMessages:s=>{if(!s.search||!Array.isArray(s.messages))return s.messages;const e=s.search.toLowerCase();return s.messages.filter(t=>{var a,r,i,c,d;return((a=t.content)==null?void 0:a.toLowerCase().includes(e))||((r=t.status)==null?void 0:r.toLowerCase().includes(e))||((i=t.recipient_name)==null?void 0:i.toLowerCase().includes(e))||((c=t.recipient_phone)==null?void 0:c.toLowerCase().includes(e))||((d=t.order_number)==null?void 0:d.toLowerCase().includes(e))})},validWhatsappContacts:s=>Array.isArray(s.contacts)?s.contacts.filter(e=>e.whatsapp||e.alt_phone||e.phone):[],totalPages:s=>Math.ceil(s.totalMessages/s.perPage),totalOrderPages:s=>Math.ceil(s.totalOrders/s.perPage),allTemplates:s=>[...s.templates,...s.orderTemplates]},actions:{setDialog(s){this.dialog=s},appendEmoji(s){this.replyMessage+=s},setAttachmentImage(s){this.attachment.image=s},setAttachmentAudio(s){this.attachment.audio=s},resetAttachment(){this.attachment.image=null,this.attachment.audio=null},toggleEmojiPicker(){this.showEmojiPicker=!this.showEmojiPicker},showError(s){this.errorMessage=s,setTimeout(()=>{this.errorMessage=""},5e3)},showSuccess(s){this.successMessage=s,setTimeout(()=>{this.successMessage=""},5e3)},formatPhoneNumber(s){return s?s.replace(/@c\.us$/,""):"Unknown"},async loadMessages(s=1){var e,t,a;try{this.loading.messages=!0,this.currentPage=s;const r=await y.get("/api/v1/whatsapp-messages",{params:{page:s,per_page:this.perPage}});Array.isArray(r.data.data)?(this.messages=r.data.data,this.totalMessages=((e=r.data.meta)==null?void 0:e.total)||this.messages.length,this.calculateStats()):(console.error("Unexpected API response format:",r.data),this.messages=[],this.showError("Invalid data format received from server"))}catch(r){console.error("Error loading messages:",r),this.showError(`Failed to load messages: ${((a=(t=r.response)==null?void 0:t.data)==null?void 0:a.message)||r.message}`),this.messages=[]}finally{this.loading.messages=!1}},async loadContacts(){var s,e,t,a;try{this.loading.contacts=!0;const r=await y.get("/api/v1/contacts");(e=(s=r.data)==null?void 0:s.data)!=null&&e.data&&Array.isArray(r.data.data.data)?(this.contacts=r.data.data.data,console.log("Contacts loaded:",this.contacts.length)):(console.error("Unexpected API response format:",r.data),this.contacts=[],this.showError("Invalid contact data format received from server"))}catch(r){console.error("Error loading contacts:",r),this.showError(`Failed to load contacts: ${((a=(t=r.response)==null?void 0:t.data)==null?void 0:a.message)||r.message}`),this.contacts=[]}finally{this.loading.contacts=!1}},async loadTemplates(){var s;try{this.loading.templates=!0;const e=await y.get("/api/v1/templates");(s=e.data)!=null&&s.data&&Array.isArray(e.data.data)?(this.templates=e.data.data,console.log("Templates loaded:",this.templates.length)):(console.error("Unexpected API response format:",e.data),this.templates=[],this.showError("Failed to load custom templates, using default order templates"))}catch(e){console.error("Error loading templates:",e),this.templates=[],this.showError("Failed to load custom templates, using default order templates")}finally{this.loading.templates=!1}},async loadRiders(){var s,e,t;try{this.loading.riders=!0;const a=await y.get("/api/v1/riders");(s=a.data)!=null&&s.data&&Array.isArray(a.data.data)?(this.riders=a.data.data,console.log("Riders loaded:",this.riders.length)):(console.error("Unexpected API response format:",a.data),this.riders=[],this.showError("Failed to load riders"))}catch(a){console.error("Error loading riders:",a),this.riders=[],this.showError(`Failed to load riders: ${((t=(e=a.response)==null?void 0:e.data)==null?void 0:t.message)||a.message}`)}finally{this.loading.riders=!1}},async loadAgents(){var s,e,t;try{this.loading.agents=!0;const a=await y.get("/api/v1/agents");(s=a.data)!=null&&s.data&&Array.isArray(a.data.data)?(this.agents=a.data.data.map(r=>({id:r.id,name:r.name,phone:r.phone,email:r.email,...r})),console.log("Agents loaded:",this.agents.length)):(console.error("Unexpected API response format:",a.data),this.agents=[],this.showError("Failed to load agents"))}catch(a){console.error("Error loading agents:",a),this.agents=[],this.showError(`Failed to load agents: ${((t=(e=a.response)==null?void 0:e.data)==null?void 0:t.message)||a.message}`)}finally{this.loading.agents=!1}},calculateStats(){if(!Array.isArray(this.messages)){console.error("messages is not an array:",this.messages);return}try{const s=this.messages.reduce((e,t)=>{const a=t&&t.status&&typeof t.status=="string"?t.status.toLowerCase():"unknown";return e[a]=(e[a]||0)+1,e},{});this.stats={...this.stats,sent:s.sent||0,delivered:s.delivered||0,read:s.read||0,failed:s.failed||0,pending:s.pending||0}}catch(s){console.error("Error calculating message stats:",s)}},calculateOrderStats(){if(Array.isArray(this.orders))try{const s=this.orders.reduce((e,t)=>{var r;const a=((r=t.status)==null?void 0:r.toLowerCase())||"unknown";return e[a]=(e[a]||0)+1,e},{});this.stats={...this.stats,totalOrders:this.orders.length,pendingOrders:s.pending||0,deliveredOrders:s.delivered||0}}catch(s){console.error("Error calculating order stats:",s)}},onTemplateSelect(s){var r,i;if(console.log("Template selected:",s),!s||!s.content){console.log("No template or content found");return}this.selectedTemplate=s;const e=((r=this.selectedContacts)==null?void 0:r[0])||{},t=((i=this.selectedOrders)==null?void 0:i[0])||{},a={customer_name:e.name||t.customer_name||"Customer",customer_phone:e.phone||t.customer_phone||"",order_number:t.order_number||"",product_name:t.product_name||"",price:t.price||"",tracking_id:t.tracking_id||""};this.messageText=this.parseTemplate(s.content,a),console.log("Parsed messageText:",this.messageText)},parseTemplate(s,e={}){return Object.entries(e).reduce((t,[a,r])=>{const i=new RegExp(`{{\\s*${a}\\s*}}`,"g");return t.replace(i,String(r??""))},s)},resetFilters(){this.search="",this.filterType="all",this.filterStatus="all",this.orderFilters={status:"all",product:"",agent:"",zone:"",createdDateStart:null,createdDateEnd:null,deliveryDateStart:null,deliveryDateEnd:null,vendorRecallStart:null,vendorRecallEnd:null}},async sendSingleConversationMessage(){if(!this.replyMessage.trim()&&!this.hasAttachment)return this.showError("Please enter a message or attach a file");const s=this.replyMessage.trim(),e=`temp_${Date.now()}`,t={id:e,content:s,direction:"outgoing",from:"system",message_status:"sending",created_at:new Date().toISOString(),image_url:this.attachment.image?URL.createObjectURL(this.attachment.image):null,audio_url:this.attachment.audio?URL.createObjectURL(this.attachment.audio):null};this.conversation.push(t);const a=s,r={...this.attachment};this.replyMessage="",this.resetAttachment(),this.loading.sending=!0;try{const i=typeof this.selectedContactId=="object"&&this.selectedContactId!==null,c=i?this.selectedContactId.id:this.selectedContactId,d=i?this.selectedContactId.orderData:null,p=i?this.selectedContactId.orderId:null;let g=a;if(d){const v=this.buildOrderPlaceholders(this.selectedContactId,d);g=this.parseMessageTemplate(a,v)}const u={content:g,contact_id:c,order_id:p,temp_id:e},l=await this.sendMessageToAPI(u,r),w=this.conversation.findIndex(v=>v.id===e);w!==-1&&(this.conversation[w]={...this.conversation[w],id:l.id,message_status:"sent",created_at:l.created_at||l.timestamp})}catch(i){console.error("âŒ Failed to send message:",i);const c=this.conversation.findIndex(d=>d.id===e);c!==-1&&(this.conversation[c].message_status="failed"),this.showError("Failed to send message. Please try again.")}finally{this.loading.sending=!1}},buildOrderPlaceholders(s,e){var i,c,d,p,g,u,l,w,v,D,I;let t="";((i=e.order_items)==null?void 0:i.length)>0&&(t=e.order_items.map(f=>{var E;const F=f.name||((E=f.product)==null?void 0:E.product_name)||f.sku||"Item";return`- ${f.quantity} Ã— ${F}`}).join(`
`));const a=(c=e.assignments)==null?void 0:c.find(f=>f.role==="CallAgent"),r=(d=e.assignments)==null?void 0:d.find(f=>f.role==="Delivery Agent");return{customer_name:s.name||((p=e.customer)==null?void 0:p.full_name)||"Customer",customer_phone:s.phone||"",order_number:e.order_no||"",order_no:e.order_no||"",tracking_id:e.tracking_no||e.tracking_number||"",order_items:t,total_price:e.total_price||"0.00",delivery_date:e.delivery_date||"",agent_name:((g=a==null?void 0:a.user)==null?void 0:g.name)||"",agent_phone:((u=a==null?void 0:a.user)==null?void 0:u.phone_number)||"",rider_name:((l=r==null?void 0:r.user)==null?void 0:l.name)||"",rider_phone:((w=r==null?void 0:r.user)==null?void 0:w.phone_number)||"",vendor_name:((v=e.vendor)==null?void 0:v.name)||"",status:((I=(D=e.latest_status)==null?void 0:D.status)==null?void 0:I.name)||""}},parseMessageTemplate(s,e){let t=s;for(const[a,r]of Object.entries(e)){const i=String(r||"");t=t.replace(new RegExp(`\\{\\{${a}\\}\\}`,"g"),i),t=t.replace(new RegExp(`\\{${a}\\}`,"g"),i)}return t},async sendMessageToAPI(s,e){const t=new FormData;return t.append("content",s.content),t.append("contact_id",s.contact_id),t.append("temp_id",s.temp_id),s.order_id&&t.append("order_id",s.order_id),e.image&&t.append("image",e.image),e.audio&&t.append("audio",e.audio),(await y.post("/api/v1/messages",t,{headers:{"Content-Type":"multipart/form-data",Authorization:`Bearer ${localStorage.getItem("auth_token")||sessionStorage.getItem("auth_token")}`}})).data},async loadConversation(s){var e;if(s){this.loading.conversation=!0;try{const t=await y.get(`/api/v1/conversation/${s}`);(e=t.data)!=null&&e.data&&(this.conversation=Array.isArray(t.data.data)?t.data.data:t.data.data.messages||[],this.conversation.sort((a,r)=>new Date(a.created_at||a.timestamp)-new Date(r.created_at||r.timestamp)))}catch(t){console.error("Failed to load conversation:",t),this.conversation=[],this.showError("Failed to load conversation")}finally{this.loading.conversation=!1}}},async openConversationDialog(s){console.log("=== openConversationDialog called ==="),console.log("contactData:",s),this.selectedContactId=s,this.dialog=!0;try{await this.loadConversation(s.id)}catch(e){console.error("Error loading conversation:",e)}console.log("Dialog opened, selectedContactId:",this.selectedContactId)},async sendMessage(s){var e,t,a,r,i,c,d,p,g,u,l,w,v,D,I,f,F;if(console.log("ðŸš€ Sending message, userId:",s),!this.messageText.trim())return console.log("Message text is empty"),this.showError("Please enter a message");if(!((e=this.selectedContacts)!=null&&e.length))return console.log("No contacts selected"),this.showError("Please select at least one recipient");try{this.loading.sending=!0;const E=[];for(const h of this.selectedContacts){console.log("ðŸ“§ Processing:",h.name);let n=null;h.orderId?(n=this.orders.find(_=>_.id===h.orderId),console.log("âœ… Found by orderId:",n==null?void 0:n.order_no)):h.orderData&&(n=h.orderData,console.log("âœ… Using orderData:",n==null?void 0:n.order_no)),n||console.warn("âš ï¸ No order for:",h.name);let O="";((t=n==null?void 0:n.order_items)==null?void 0:t.length)>0&&(O=n.order_items.map(_=>{var m;const S=_.name||((m=_.product)==null?void 0:m.product_name)||_.sku||"Item";return`- ${_.quantity} Ã— ${S}`}).join(`
`));const o=(a=n==null?void 0:n.assignments)==null?void 0:a.find(_=>_.role==="CallAgent"),T=(r=n==null?void 0:n.assignments)==null?void 0:r.find(_=>_.role==="Delivery Agent"),C={customer_name:h.name||((i=n==null?void 0:n.customer)==null?void 0:i.full_name)||"Customer",customer_phone:h.phone||"",order_number:(n==null?void 0:n.order_no)||"",order_no:(n==null?void 0:n.order_no)||"",tracking_id:(n==null?void 0:n.tracking_no)||(n==null?void 0:n.tracking_number)||"",order_items:O,total_price:(n==null?void 0:n.total_price)||"0.00",delivery_date:(n==null?void 0:n.delivery_date)||"",agent_name:((c=o==null?void 0:o.user)==null?void 0:c.name)||"",agent_phone:((d=o==null?void 0:o.user)==null?void 0:d.phone_number)||"",rider_name:((p=T==null?void 0:T.user)==null?void 0:p.name)||"",rider_phone:((g=T==null?void 0:T.user)==null?void 0:g.phone_number)||"",vendor_name:((u=n==null?void 0:n.vendor)==null?void 0:u.name)||"",status:((w=(l=n==null?void 0:n.latest_status)==null?void 0:l.status)==null?void 0:w.name)||""};console.log("ðŸ“‹ Placeholders:",C);const M=this.parseTemplate(((v=this.selectedTemplate)==null?void 0:v.content)||this.messageText,C),A={user_id:s,template_id:((D=this.selectedTemplate)==null?void 0:D.id)||null,template_slug:((I=this.selectedTemplate)==null?void 0:I.slug)||"general",contacts:[{id:h.id,name:h.name,phone:h.phone,chatId:h.whatsapp||h.phone,orderId:h.orderId||(n==null?void 0:n.id)||null,orderOid:h.orderOid||(n==null?void 0:n.order_no)||null}],message:M,order:n?{id:n.id,order_no:n.order_no,order_items:n.order_items,total_price:n.total_price,customer:n.customer}:null};console.log("ðŸ“¤ Payload:",A);const P=await y.post("/api/v1/whatsapp/send-message",A);E.push({contact:h.name,phone:h.phone,orderId:n==null?void 0:n.id,status:"sent",result:P.data})}this.showSuccess(`Messages sent to ${E.length} recipients`),this.messageText="",this.selectedContacts=[],this.selectedOrders=[],this.selectedTemplate=null,this.showNewMessageDialog=!1,setTimeout(()=>this.loadMessages(1),1e3)}catch(E){console.error("âŒ Error:",E),this.showError(((F=(f=E.response)==null?void 0:f.data)==null?void 0:F.message)||E.message)}finally{this.loading.sending=!1}},async sendSingleMessage(s,e,t,a=null){var r,i,c,d,p,g,u,l,w,v,D,I,f,F,E,h,n,O;if(console.log("ðŸš€ Sending single message"),console.log("ðŸ“§ Contact:",e),console.log("ðŸ’¬ Message:",t),!(t!=null&&t.trim()))return this.showError("Please enter a message");if(!e||!e.phone)return this.showError("Invalid contact information");try{this.loading.sending=!0;let o=null;e.orderId?(o=this.orders.find(m=>m.id===e.orderId),console.log("âœ… Found order by ID:",o==null?void 0:o.order_no)):e.orderData?(o=e.orderData,console.log("âœ… Using provided orderData:",o==null?void 0:o.order_no)):e.orderOid&&(o=this.orders.find(m=>m.order_no===e.orderOid),console.log("âœ… Found order by order_no:",o==null?void 0:o.order_no)),o||console.warn("âš ï¸ No order found for contact:",e.name);let T="";((r=o==null?void 0:o.order_items)==null?void 0:r.length)>0&&(T=o.order_items.map(m=>{var b;const k=m.name||((b=m.product)==null?void 0:b.product_name)||m.sku||"Item";return`- ${m.quantity} Ã— ${k}`}).join(`
`));const C=(i=o==null?void 0:o.assignments)==null?void 0:i.find(m=>m.role==="CallAgent"),M=(c=o==null?void 0:o.assignments)==null?void 0:c.find(m=>m.role==="Delivery Agent"),A={customer_name:e.name||((d=o==null?void 0:o.customer)==null?void 0:d.full_name)||"Customer",customer_phone:e.phone||"",order_number:(o==null?void 0:o.order_no)||"",order_no:(o==null?void 0:o.order_no)||"",tracking_id:(o==null?void 0:o.tracking_no)||(o==null?void 0:o.tracking_number)||"",order_items:T,total_price:(o==null?void 0:o.total_price)||"0.00",delivery_date:(o==null?void 0:o.delivery_date)||"",agent_name:((p=C==null?void 0:C.user)==null?void 0:p.name)||"",agent_phone:((g=C==null?void 0:C.user)==null?void 0:g.phone_number)||"",rider_name:((u=M==null?void 0:M.user)==null?void 0:u.name)||"",rider_phone:((l=M==null?void 0:M.user)==null?void 0:l.phone_number)||"",vendor_name:((w=o==null?void 0:o.vendor)==null?void 0:w.name)||"",status:((D=(v=o==null?void 0:o.latest_status)==null?void 0:v.status)==null?void 0:D.name)||""};console.log("ðŸ“‹ Template placeholders:",A);const P=(I=this.selectedTemplate)!=null&&I.content?this.parseTemplate(this.selectedTemplate.content,A):this.parseTemplate(t,A),_={user_id:s,template_id:a||((f=this.selectedTemplate)==null?void 0:f.id)||null,template_slug:((F=this.selectedTemplate)==null?void 0:F.slug)||"general",contacts:[{id:e.id,name:e.name,phone:e.phone,chatId:e.whatsapp||e.phone,orderId:e.orderId||(o==null?void 0:o.id)||null,orderOid:e.orderOid||(o==null?void 0:o.order_no)||null}],message:P,order:o?{id:o.id,order_no:o.order_no,order_items:o.order_items,total_price:o.total_price,customer:o.customer}:null};console.log("ðŸ“¤ Sending payload:",_);const S=await y.post("/api/v1/whatsapp/send-message",_);return console.log("âœ… Message sent successfully:",S.data),R.success(`Message sent to ${e.name}`),this.messageText="",this.selectedTemplate=null,setTimeout(()=>this.loadMessages(1),1e3),{success:!0,data:S.data}}catch(o){return console.error("âŒ Error sending message:",o),console.error("Error details:",(E=o.response)==null?void 0:E.data),this.showError(((n=(h=o.response)==null?void 0:h.data)==null?void 0:n.message)||o.message||"Failed to send message"),{success:!1,error:((O=o.response)==null?void 0:O.data)||o.message}}finally{this.loading.sending=!1}},parseTemplate(s,e){if(!s)return"";let t=s;return Object.keys(e).forEach(a=>{const r=new RegExp(`{{\\s*${a}\\s*}}`,"g");t=t.replace(r,e[a]||"")}),t},async sendOrderMessage(s){var e,t,a;if(!this.messageText.trim())return this.showError("Please enter a message");if(!Array.isArray(this.selectedOrders)||this.selectedOrders.length===0)return this.showError("Please select at least one order");try{this.loading.sending=!0;const r=await y.post("/api/v1/whatsapp-send-orders",{user_id:s,orders:this.selectedOrders.map(i=>({id:i.id,order_number:i.order_number,customer_name:i.customer_name,customer_phone:i.customer_phone,product_name:i.product_name,price:i.price,tracking_id:i.tracking_id})),message:this.messageText,template_id:((e=this.selectedTemplate)==null?void 0:e.id)||null});this.showSuccess(`Order messages sent to ${this.selectedOrders.length} customers`),this.messageText="",this.selectedOrders=[],this.selectedTemplate=null,this.showOrderMessageDialog=!1,setTimeout(()=>{this.loadMessages(1)},1e3)}catch(r){console.error("Error sending order messages:",r),this.showError(`Failed to send order messages: ${((a=(t=r.response)==null?void 0:t.data)==null?void 0:a.message)||r.message}`)}finally{this.loading.sending=!1}},async importContacts(s){var e,t,a;if(!this.csvFile)return this.showError("Please select a CSV file to import");try{this.loading.importing=!0;const r=new FormData;r.append("file",this.csvFile),r.append("user_id",s);const i=await y.post("/api/v1/contacts/import",r,{headers:{"Content-Type":"multipart/form-data"}});i.data&&i.data.success?(this.showSuccess(`Successfully imported ${i.data.imported||"multiple"} contacts`),await this.loadContacts(),this.showImportDialog=!1,this.csvFile=null):this.showError(((e=i.data)==null?void 0:e.message)||"Import failed")}catch(r){console.error("Error importing contacts:",r),this.showError(`Failed to import contacts: ${((a=(t=r.response)==null?void 0:t.data)==null?void 0:a.message)||r.message}`)}finally{this.loading.importing=!1}},async importOrders(s){var e,t,a;if(!this.orderFile)return this.showError("Please select an Excel or CSV file to import");try{this.loading.uploadingOrders=!0;const r=new FormData;r.append("file",this.orderFile),r.append("user_id",s);const i=await y.post("/api/v1/orders/import",r,{headers:{"Content-Type":"multipart/form-data"}});i.data&&i.data.success?(this.showSuccess(`Successfully imported ${i.data.imported||"multiple"} orders`),this.showOrderImportDialog=!1,this.orderFile=null):this.showError(((e=i.data)==null?void 0:e.message)||"Order import failed")}catch(r){console.error("Error importing orders:",r),this.showError(`Failed to import orders: ${((a=(t=r.response)==null?void 0:t.data)==null?void 0:a.message)||r.message}`)}finally{this.loading.uploadingOrders=!1}},async openNewMessageDialog(){this.errorMessage="",this.messageText="",this.selectedContacts=[],this.selectedTemplate=null,(!Array.isArray(this.contacts)||this.contacts.length===0)&&!this.loading.contacts&&await this.loadContacts(),(!Array.isArray(this.templates)||this.templates.length===0)&&!this.loading.templates&&await this.loadTemplates(),this.showNewMessageDialog=!0},async openNewMessageDialog(s=[]){this.errorMessage="",this.messageText="",this.selectedContacts=[],this.selectedTemplate=null,(!Array.isArray(this.templates)||this.templates.length===0)&&!this.loading.templates&&await this.loadTemplates(),Array.isArray(s)&&s.length>0?(console.log("openNewMessageDialog: selectedOrders:",s),this.selectedContacts=s.map(e=>{const t=this.orders.find(a=>a.id===e);return t?t.client?{id:t.client.id,name:t.client.name||t.client.phone,phone:t.client.phone_number,alt_phone:t.client.alt_phone}:(console.warn("Order has no client:",t),null):(console.warn("Order not found for id:",e),null)}).filter(e=>{const t=(e==null?void 0:e.id)&&(e==null?void 0:e.phone);return t||console.warn("Invalid client object:",e),t}),console.log("openNewMessageDialog: selectedContacts from orders:",this.selectedContacts)):((!Array.isArray(this.contacts)||this.contacts.length===0)&&!this.loading.contacts&&await this.loadContacts(),this.selectedContacts=[],console.log("Loaded all contacts:",this.contacts)),this.showNewMessageDialog=!0},async openOrderMessageDialog(){this.errorMessage="",this.messageText="",this.selectedOrders=[],this.selectedTemplate=null,(!Array.isArray(this.orders)||this.orders.length===0)&&this.loading.orders,(!Array.isArray(this.templates)||this.templates.length===0)&&!this.loading.templates&&await this.loadTemplates(),this.showOrderMessageDialog=!0},async deleteMessage(s){var e,t;if(!s)return this.showError("Invalid message ID");if(confirm("Are you sure you want to delete this message?"))try{await y.delete(`/api/v1/whatsapp-messages/${s}`),Array.isArray(this.messages)&&(this.messages=this.messages.filter(a=>a.id!==s),this.calculateStats()),this.showSuccess("Message deleted successfully")}catch(a){console.error("Error deleting message:",a),this.showError(`Failed to delete message: ${((t=(e=a.response)==null?void 0:e.data)==null?void 0:t.message)||a.message}`)}},async initialize(){this.messages=[],this.contacts=[],this.orders=[],this.templates=[],this.riders=[],this.agents=[],await Promise.all([this.loadMessages(1),this.loadContacts(),this.loadTemplates(),this.loadRiders(),this.loadAgents()])}}});export{z as u};
