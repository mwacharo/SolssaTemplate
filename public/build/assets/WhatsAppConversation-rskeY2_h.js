import{E as Ue,r as h,j as U,Q as je,k as De,s as we,z as ke,l as g,c as O,o as _,w as s,b as n,a as m,f as p,t as C,u as r,d as x,e as S,F as xe,g as Ce,n as be,H as Se,y as $e,m as Ve,X as Pe,R as Ie}from"./app-BAMjVpRk.js";import{u as Le}from"./whatsappStore-wPIvlBRF.js";import{u as Oe}from"./WhatsAppConversation.vue_vue_type_style_index_0_scoped_0d9cd03d_lang-DtU6eZAM.js";import{_ as Fe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Re=Ue("conversation",()=>{const M=h(!1),u=h([]),P=h(!1),f=h(""),v=h({image:null,audio:null}),$=h(!1),T=h(!1),j=h(""),D=h(!1),y=h({}),b=h(null),w=h(!1),A=h("online"),Y=["ðŸ˜Š","ðŸ˜‚","â¤ï¸","ðŸ‘","ðŸ‘","ðŸŽ‰","ðŸ”¥","ðŸ’¯","ðŸ˜","ðŸ˜˜","ðŸ¤”","ðŸ˜Ž","ðŸ‘Œ","ðŸ™","ðŸ’ª","âœ¨","ðŸŽˆ","ðŸŒŸ","â­","ðŸ’«","ðŸŒ¸","ðŸŒº","ðŸŽŠ","ðŸŽ"],K=U(()=>v.value.image&&v.value.image.length||v.value.audio&&v.value.audio.length),J=U(()=>(f.value.trim()||K.value)&&!D.value&&A.value==="online"),F=U(()=>{if(u.value&&u.value.length>0){const t=u.value.find(a=>a.sender_name);return(t==null?void 0:t.sender_name)||"Contact"}return"Contact"}),Q=U(()=>{var t;if(u.value&&u.value.length>0){const a=(t=u.value[0].from)==null?void 0:t.match(/(\d+)/);return a?`+${a[1]}`:""}return""}),R=U(()=>u.value.filter(t=>t.direction==="incoming"&&t.message_status!=="read").length),z=U(()=>u.value[u.value.length-1]||null),Z=async t=>{console.log("=== openDialog called ==="),console.log("contactId:",t),b.value=t,M.value=!0,console.log("Dialog set to true:",M.value);try{await X(t)}catch(a){console.error("Error loading conversation:",a)}M.value||(console.log("Dialog was somehow set to false, correcting..."),M.value=!0),console.log("openDialog completed, final dialog state:",M.value)},q=()=>{M.value=!1,B(),b.value=null},X=async t=>{if(t){P.value=!0;try{const a=await fetch(`/api/v1/conversation/${t}`);if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const i=await a.json();u.value=i.data||i.messages||[],u.value.sort((c,k)=>new Date(c.created_at||c.timestamp)-new Date(k.created_at||k.timestamp))}catch(a){console.error("Failed to load conversation:",a),u.value=[],d("Failed to load conversation")}finally{P.value=!1}}},ee=async()=>{if(!J.value)return;const t=f.value.trim(),a=`temp_${Date.now()}_${Math.random()}`,i={id:a,content:t,direction:"outgoing",from:"system",message_status:"sending",created_at:new Date().toISOString(),image_url:v.value.image?URL.createObjectURL(v.value.image[0]):null,audio_url:v.value.audio?URL.createObjectURL(v.value.audio[0]):null};u.value.push(i);const c=t,k={...v.value};B(),D.value=!0;try{const L={content:c,contact_id:b.value,temp_id:a},I=await N(L,k),V=u.value.findIndex(ve=>ve.id===a);V!==-1&&(u.value[V]={...u.value[V],id:I.id,message_status:"sent",created_at:I.created_at||I.timestamp})}catch(L){console.error("Failed to send message:",L);const I=u.value.findIndex(V=>V.id===a);I!==-1&&(u.value[I].message_status="failed"),d("Failed to send message. Please try again.")}finally{D.value=!1}},N=async(t,a)=>{const i=new FormData;i.append("content",t.content),i.append("contact_id",t.contact_id),i.append("temp_id",t.temp_id),a.image&&a.image.length&&i.append("image",a.image[0]),a.audio&&a.audio.length&&i.append("audio",a.audio[0]);const c=await fetch("/api/v1/messages",{method:"POST",headers:{Authorization:`Bearer ${e()}`},body:i});if(!c.ok)throw new Error(`HTTP error! status: ${c.status}`);return c.json()},te=async t=>{const a=u.value.find(i=>i.id===t);if(!(!a||a.message_status!=="failed")){a.message_status="sending";try{await axios.post(`/api/v1/whatsapp/retry-message/${t}`),a.message_status="sent"}catch(i){console.error("Failed to retry message:",i),a.message_status="failed"}}},ae=async t=>{try{const a=await fetch(`/api/v1/messages/${t}`,{method:"DELETE",headers:{Authorization:`Bearer ${e()}`}});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const i=u.value.findIndex(c=>c.id===t);i!==-1&&u.value.splice(i,1)}catch(a){console.error("Failed to delete message:",a),d("Failed to delete message")}},ne=t=>{u.value.find(i=>i.id===t.id)||(u.value.push(t),u.value.sort((i,c)=>new Date(i.created_at||i.timestamp)-new Date(c.created_at||c.timestamp)))},oe=(t,a)=>{const i=u.value.find(c=>c.id===t);i&&(i.message_status=a)},se=t=>{w.value=t},le=t=>{A.value=t},B=()=>{f.value="",v.value.image=null,v.value.audio=null,$.value=!1},ie=t=>{f.value+=t,$.value=!1},re=t=>{t&&t.type.startsWith("image/")&&(v.value.image=[t])},W=t=>{t&&t.type.startsWith("audio/")&&(v.value.audio=[t])},ue=t=>{j.value=t,T.value=!0},G=()=>{T.value=!1,j.value=""},de=(t,a)=>{a&&(y.value[t]||(y.value[t]={playing:!1}),Object.keys(y.value).forEach(i=>{i!==t&&y.value[i].playing&&(y.value[i].playing=!1)}),y.value[t].playing?(a.pause(),y.value[t].playing=!1):(a.play(),y.value[t].playing=!0))},ce=t=>{y.value[t]&&(y.value[t].playing=!1)},me=t=>t.trim()?u.value.filter(a=>a.content.toLowerCase().includes(t.toLowerCase())):u.value,l=()=>{const t={contact:{name:F.value,phone:Q.value},messages:u.value.map(k=>({id:k.id,content:k.content,direction:k.direction,timestamp:k.created_at||k.timestamp,status:k.message_status})),exportedAt:new Date().toISOString()},a=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),i=URL.createObjectURL(a),c=document.createElement("a");c.href=i,c.download=`conversation_${F.value}_${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(i)},e=()=>localStorage.getItem("auth_token")||sessionStorage.getItem("auth_token"),d=t=>{console.error(t)};return{dialog:M,conversation:u,loading:P,replyMessage:f,attachment:v,showEmojiPicker:$,imagePreviewDialog:T,previewImageUrl:j,sending:D,audioStates:y,selectedContactId:b,typingIndicator:w,connectionStatus:A,commonEmojis:Y,hasAttachment:K,canSendMessage:J,contactName:F,contactPhone:Q,unreadCount:R,lastMessage:z,openDialog:Z,closeDialog:q,loadConversation:X,sendMessage:ee,retryFailedMessage:te,deleteMessage:ae,addIncomingMessage:ne,updateMessageStatus:oe,setTypingIndicator:se,setConnectionStatus:le,clearForm:B,appendEmoji:ie,handleImageUpload:re,handleAudioUpload:W,openImagePreview:ue,closeImagePreview:G,toggleAudio:de,onAudioEnded:ce,searchMessages:me,exportConversation:l,resetStore:()=>{M.value=!1,u.value=[],P.value=!1,f.value="",v.value={image:null,audio:null},$.value=!1,T.value=!1,j.value="",D.value=!1,y.value={},b.value=null,w.value=!1,A.value="online"}}}),ze={class:"d-flex align-center w-100"},Ne={class:"flex-grow-1"},Be={class:"text-h6 mb-0"},We={class:"text-caption text-grey"},He={key:0,class:"pa-4"},Ke={key:0,class:"message-sender text-caption font-weight-medium mb-1"},Je={class:"message-content"},Qe={key:1,class:"message-media mt-2"},Xe={key:2,class:"message-media mt-2"},Ge={class:"audio-container"},Ye=["src","onEnded"],Ze={class:"message-meta d-flex align-center justify-end mt-1"},qe={class:"text-caption text-grey mr-2"},et={key:0,class:"typing-indicator mb-3"},tt={key:1,class:"empty-state pa-8 text-center"},at={key:0,class:"attachment-preview mb-3"},nt={class:"message-input-container"},ot={class:"input-actions d-flex align-center mt-2"},st={class:"d-flex align-center flex-grow-1"},lt={key:0,class:"text-caption text-grey ml-2"},it={key:0,class:"emoji-picker mt-3 pa-3"},rt={class:"emoji-grid"},ut={__name:"WhatsAppConversation",setup(M){const u=Oe(),P=U(()=>{var l;return(l=u.user)==null?void 0:l.id}),f=Le(),v=Re(),{dialog:$,conversation:T,contactName:j,contactPhone:D,connectionStatus:y,replyMessage:b,attachment:w,imagePreviewDialog:A,previewImageUrl:Y,typingIndicator:K,audioStates:J,sending:F}=je(v),Q=h(null),R=h(null),z=h(!1),Z=["ðŸ˜€","ðŸ˜‚","ðŸ˜","ðŸ˜­","ðŸ˜¡","ðŸ‘","ðŸ™","ðŸ”¥","ðŸŽ‰","ðŸ’¯"],q=()=>{switch(y.value){case"online":return"Online";case"offline":return"Offline";case"connecting":return"Connecting...";default:return"Unknown"}},X=()=>{switch(y.value){case"online":return"success";case"offline":return"grey";case"connecting":return"warning";default:return"grey"}},ee=l=>l.from!=="system",N=l=>l.from==="system"||l.direction==="outgoing",te=l=>N(l)?"outgoing":"incoming",ae=l=>N(l)?"outgoing":"incoming",ne=l=>{switch(l){case"sent":return"mdi-check";case"delivered":return"mdi-check-all";case"read":return"mdi-check-all";case"failed":return"mdi-alert-circle";case"sending":return"mdi-clock-outline";default:return"mdi-clock-outline"}},oe=l=>{switch(l){case"read":return"blue";case"delivered":return"grey";case"sent":return"grey";case"failed":return"red";case"sending":return"orange";default:return"grey"}},se=l=>{if(!l)return"-";const e=new Date(l),H=(new Date-e)/(1e3*60*60);return H<24?e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):H<168?e.toLocaleDateString([],{weekday:"short",hour:"2-digit",minute:"2-digit"}):e.toLocaleDateString([],{month:"short",day:"numeric"})},le=()=>{b.value+=`
`},B=l=>{const e=l.target.files[0];e&&v.handleImageUpload(e)},ie=l=>{const e=l.target.files[0];e&&v.handleAudioUpload(e)},re=(l,e)=>{let d=e[`audio-${l}`];Array.isArray(d)&&(d=d[0]),d?v.toggleAudio(l,d):console.warn(`Audio element not found for messageId: ${l}`)},W=()=>{ke(()=>{R.value&&(R.value.scrollTop=R.value.scrollHeight)})},ue=()=>{$.value=!1},G=()=>f.sendMessage(P.value),de=l=>{b.value+=l},ce=()=>{A.value=!1},me=l=>{v.retryFailedMessage(l)};return U(()=>{var l,e;return b.value.trim().length>0||((l=w.value)==null?void 0:l.image)||((e=w.value)==null?void 0:e.audio)}),De(()=>{W(),f.initialize()}),we(T,()=>{W()},{deep:!0}),we($,l=>{l&&ke(()=>W())}),(l,e)=>{const d=g("v-icon"),H=g("v-avatar"),t=g("v-chip"),a=g("v-btn"),i=g("v-card-title"),c=g("v-divider"),k=g("v-progress-linear"),L=g("v-img"),I=g("v-card-text"),V=g("v-select"),ve=g("v-textarea"),ge=g("v-list-item-icon"),pe=g("v-list-item-title"),_e=g("v-list-item-content"),fe=g("v-list-item"),Me=g("v-list"),Te=g("v-menu"),Ae=g("v-expand-transition"),ye=g("v-card"),Ee=g("v-spacer"),he=g("v-dialog");return _(),O(he,{modelValue:r($),"onUpdate:modelValue":e[8]||(e[8]=o=>Ie($)?$.value=o:null),"max-width":"800",persistent:""},{default:s(()=>[n(ye,{class:"conversation-dialog"},{default:s(()=>[n(i,{class:"conversation-header pa-4"},{default:s(()=>[m("div",ze,[n(H,{color:"primary",size:"40",class:"mr-3"},{default:s(()=>[n(d,{color:"white"},{default:s(()=>e[9]||(e[9]=[p("mdi-account")])),_:1,__:[9]})]),_:1}),m("div",Ne,[m("div",Be,C(r(j)),1),m("div",We,C(r(D)),1)]),n(t,{color:X(),small:"",outlined:"",class:"mr-2"},{default:s(()=>[p(C(q()),1)]),_:1},8,["color"]),n(a,{icon:"",onClick:ue},{default:s(()=>[n(d,null,{default:s(()=>e[10]||(e[10]=[p("mdi-close")])),_:1,__:[10]})]),_:1})])]),_:1}),n(c),n(I,{class:"pa-0"},{default:s(()=>[r(f).loading.conversation?(_(),O(k,{key:0,indeterminate:"",color:"primary"})):(_(),x("div",{key:1,class:"messages-container",ref_key:"messagesContainer",ref:Q},[Array.isArray(r(T))&&r(T).length?(_(),x("div",He,[(_(!0),x(xe,null,Ce(r(T),o=>(_(),x("div",{key:o.id,class:be(["message-wrapper mb-3",te(o)])},[m("div",{class:be(["message-bubble elevation-1",ae(o)])},[ee(o)?(_(),x("div",Ke,C(o.sender_name||r(j)),1)):S("",!0),m("div",Je,C(o.content),1),o.image_url?(_(),x("div",Qe,[n(L,{src:o.image_url,"max-height":"200","max-width":"300",contain:"",class:"rounded",onClick:E=>l.openImagePreview(o.image_url),style:{cursor:"pointer"}},null,8,["src","onClick"])])):S("",!0),o.audio_url?(_(),x("div",Xe,[m("div",Ge,[n(a,{icon:"",small:"",onClick:E=>re(o.id,l.$refs),class:"mr-2"},{default:s(()=>[n(d,null,{default:s(()=>{var E;return[p(C((E=r(J)[o.id])!=null&&E.playing?"mdi-pause":"mdi-play"),1)]}),_:2},1024)]),_:2},1032,["onClick"]),m("audio",{ref_for:!0,ref:`audio-${o.id}`,src:o.audio_url,onEnded:E=>l.onAudioEnded(o.id),style:{display:"none"}},null,40,Ye),e[11]||(e[11]=m("span",{class:"text-caption"},"Voice message",-1))])])):S("",!0),m("div",Ze,[m("span",qe,C(se(o.created_at||o.timestamp)),1),N(o)?(_(),O(d,{key:0,color:oe(o.message_status),size:"14"},{default:s(()=>[p(C(ne(o.message_status)),1)]),_:2},1032,["color"])):S("",!0),o.message_status==="failed"?(_(),O(a,{key:1,icon:"","x-small":"",onClick:E=>me(o.id),class:"ml-1"},{default:s(()=>[n(d,{size:"12"},{default:s(()=>e[12]||(e[12]=[p("mdi-refresh")])),_:1,__:[12]})]),_:2},1032,["onClick"])):S("",!0)])],2)],2))),128)),r(K)?(_(),x("div",et,e[13]||(e[13]=[m("div",{class:"message-bubble incoming"},[m("div",{class:"typing-dots"},[m("span"),m("span"),m("span")])],-1)]))):S("",!0)])):(_(),x("div",tt,[n(d,{size:"64",color:"grey lighten-2"},{default:s(()=>e[14]||(e[14]=[p("mdi-message-outline")])),_:1,__:[14]}),e[15]||(e[15]=m("div",{class:"text-h6 mt-4 text-grey"}," No messages yet ",-1)),e[16]||(e[16]=m("div",{class:"text-caption text-grey"}," Start the conversation below ",-1))]))],512))]),_:1}),n(c),n(I,{class:"reply-section pa-4"},{default:s(()=>[l.hasAttachment?(_(),x("div",at,[r(w).image&&r(w).image.length?(_(),O(t,{key:0,close:"","onClick:close":e[0]||(e[0]=o=>r(w).image=null),color:"blue lighten-4",class:"mr-2"},{default:s(()=>{var o;return[n(d,{left:"",small:""},{default:s(()=>e[17]||(e[17]=[p("mdi-image")])),_:1,__:[17]}),p(" "+C((o=r(w).image[0])==null?void 0:o.name),1)]}),_:1})):S("",!0),r(w).audio&&r(w).audio.length?(_(),O(t,{key:1,close:"","onClick:close":e[1]||(e[1]=o=>r(w).audio=null),color:"green lighten-4"},{default:s(()=>{var o;return[n(d,{left:"",small:""},{default:s(()=>e[18]||(e[18]=[p("mdi-microphone")])),_:1,__:[18]}),p(" "+C((o=r(w).audio[0])==null?void 0:o.name),1)]}),_:1})):S("",!0)])):S("",!0),n(V,{modelValue:r(f).selectedTemplate,"onUpdate:modelValue":[e[2]||(e[2]=o=>r(f).selectedTemplate=o),r(f).onTemplateSelect],items:r(f).allTemplates,"item-title":"name","item-value":"id",label:"Select Template","return-object":"",disabled:r(f).loading.templates,loading:r(f).loading.templates,class:"mt-3",clearable:""},null,8,["modelValue","items","disabled","loading","onUpdate:modelValue"]),m("div",nt,[n(ve,{modelValue:r(f).messageText,"onUpdate:modelValue":e[3]||(e[3]=o=>r(f).messageText=o),label:"Type your message...",rows:"2","auto-grow":"",outlined:"",dense:"","hide-details":"",class:"message-input",disabled:r(y)!=="online",onKeydown:[Se($e(G,["exact","prevent"]),["enter"]),Se($e(le,["shift","exact"]),["enter"])]},null,8,["modelValue","disabled","onKeydown"]),m("div",ot,[m("div",st,[n(a,{icon:"",small:"",onClick:e[4]||(e[4]=o=>z.value=!z.value),class:"mr-2",disabled:r(y)!=="online"},{default:s(()=>[n(d,null,{default:s(()=>e[19]||(e[19]=[p("mdi-emoticon-happy-outline")])),_:1,__:[19]})]),_:1},8,["disabled"]),n(Te,{"offset-y":""},{activator:s(({on:o,attrs:E})=>[n(a,Ve({icon:"",small:""},E,Pe(o),{class:"mr-2",disabled:r(y)!=="online"}),{default:s(()=>[n(d,null,{default:s(()=>e[20]||(e[20]=[p("mdi-attachment")])),_:1,__:[20]})]),_:2},1040,["disabled"])]),default:s(()=>[n(Me,{dense:""},{default:s(()=>[n(fe,{onClick:e[5]||(e[5]=o=>l.$refs.imageInput.click())},{default:s(()=>[n(ge,null,{default:s(()=>[n(d,null,{default:s(()=>e[21]||(e[21]=[p("mdi-image")])),_:1,__:[21]})]),_:1}),n(_e,null,{default:s(()=>[n(pe,null,{default:s(()=>e[22]||(e[22]=[p("Image")])),_:1,__:[22]})]),_:1})]),_:1}),n(fe,{onClick:e[6]||(e[6]=o=>l.$refs.audioInput.click())},{default:s(()=>[n(ge,null,{default:s(()=>[n(d,null,{default:s(()=>e[23]||(e[23]=[p("mdi-microphone")])),_:1,__:[23]})]),_:1}),n(_e,null,{default:s(()=>[n(pe,null,{default:s(()=>e[24]||(e[24]=[p("Voice Note")])),_:1,__:[24]})]),_:1})]),_:1})]),_:1})]),_:1}),m("input",{ref:"imageInput",type:"file",accept:"image/*",onChange:B,style:{display:"none"}},null,544),m("input",{ref:"audioInput",type:"file",accept:"audio/*",onChange:ie,style:{display:"none"}},null,544),r(b).length>0?(_(),x("span",lt,C(r(b).length),1)):S("",!0)]),n(a,{color:"primary",onClick:G,class:"ml-2",loading:r(F)},{default:s(()=>[n(d,null,{default:s(()=>e[25]||(e[25]=[p("mdi-send")])),_:1,__:[25]})]),_:1},8,["loading"])]),n(Ae,null,{default:s(()=>[z.value?(_(),x("div",it,[m("div",rt,[(_(),x(xe,null,Ce(Z,o=>n(a,{key:o,text:"","x-small":"",onClick:E=>de(o),class:"emoji-btn"},{default:s(()=>[p(C(o),1)]),_:2},1032,["onClick"])),64))])])):S("",!0)]),_:1})])]),_:1})]),_:1}),n(he,{modelValue:r(A),"onUpdate:modelValue":e[7]||(e[7]=o=>Ie(A)?A.value=o:null),"max-width":"90vw"},{default:s(()=>[n(ye,null,{default:s(()=>[n(i,{class:"pa-2"},{default:s(()=>[n(Ee),n(a,{icon:"",onClick:ce},{default:s(()=>[n(d,null,{default:s(()=>e[26]||(e[26]=[p("mdi-close")])),_:1,__:[26]})]),_:1})]),_:1}),n(I,{class:"pa-2"},{default:s(()=>[n(L,{src:r(Y),contain:"","max-height":"80vh"},null,8,["src"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])}}},dt=Fe(ut,[["__scopeId","data-v-0d9cd03d"]]),pt=Object.freeze(Object.defineProperty({__proto__:null,default:dt},Symbol.toStringTag,{value:"Module"}));export{dt as W,pt as a,Re as u};
