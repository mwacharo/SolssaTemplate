import{_ as me}from"./AppLayout-BgPFFROc.js";import{r as c,j as z,k as ce,l as u,c as g,o as i,w as n,a as l,b as o,e as H,u as ve,f as d,d as y,F as J,g as Q,t as r,W as X}from"./app-CpVldMEC.js";import{u as _e}from"./orderStore-DZ6Dizjo.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./webrtc-khQ7QFZV.js";import"./africastalking-B6-VgVuI.js";import"./IncomingCallDialog-BpeibPCJ.js";/* empty css                                                                           */import"./toast-DtlkEXjk.js";const pe={class:"pa-4"},fe={key:1,class:"text-center py-8"},De={__name:"RiderPayments",props:{invoices:{type:Array,default:()=>[]}},setup(P){const p=_e(),b=c(!1),k=c(!1),D=c(!1),I=c(!1),U=c(""),F=c("success"),s=c({from:"",to:"",rider:null}),f=c(100),m=c([]),T=z(()=>s.value.from&&s.value.to&&s.value.rider),j=z(()=>p.riderOptions.find(a=>a.id===s.value.rider)),B=z(()=>m.value.length*f.value),Y=async()=>{if(!T.value){w("Please select date range and agent","error");return}b.value=!0,k.value=!0;try{const e=await(await fetch(`/api/v1/orders/rider/${s.value.rider}?from=${s.value.from}&to=${s.value.to}`)).json();if(e.success)m.value=e.data||[];else throw new Error(e.message||"Failed to fetch orders")}catch(a){console.error("Error fetching orders:",a),w("Error loading orders","error"),m.value=[]}finally{k.value=!1}},S=()=>{b.value=!1,m.value=[]},Z=async()=>{D.value=!0;try{await X.post("/call-agent-invoices",{rider_id:s.value.rider,from:s.value.from,to:s.value.to,rate:f.value,orders:m.value.map(a=>a.id),total_commission:B.value},{onSuccess:()=>{w("Invoice generated successfully","success"),S(),s.value={from:"",to:"",rider:null}},onError:a=>{w("Error generating invoice","error"),console.error(a)}})}finally{D.value=!1}},ee=a=>{X.visit(`/call-agent-invoices/${a.id}`)},le=async a=>{window.open(`/call-agent-invoices/${a.id}/download`,"_blank")},w=(a,e="success")=>{U.value=a,F.value=e,I.value=!0},C=a=>new Intl.NumberFormat("en-KE",{style:"currency",currency:"KES"}).format(a),E=a=>a?new Date(a).toLocaleDateString("en-KE",{year:"numeric",month:"short",day:"numeric"}):"N/A",te=a=>({pending:"warning",paid:"success",cancelled:"error",processing:"info"})[a==null?void 0:a.toLowerCase()]||"default";return ce(async()=>{p.initialized?await p.fetchDropdownOptions():await p.initialize()}),(a,e)=>{const O=u("v-text-field"),v=u("v-col"),oe=u("v-autocomplete"),_=u("v-btn"),A=u("v-row"),G=u("v-card-title"),ne=u("v-chip"),K=u("v-table"),h=u("v-card-text"),$=u("v-card"),L=u("v-alert"),ae=u("v-progress-circular"),re=u("v-divider"),se=u("v-spacer"),ue=u("v-card-actions"),de=u("v-dialog"),ie=u("v-snackbar");return i(),g(me,null,{default:n(()=>[l("div",pe,[e[9]||(e[9]=l("h2",{class:"text-h4 mb-6"},"Delivery Person",-1)),o(A,null,{default:n(()=>[o(v,{cols:"12",md:"4"},{default:n(()=>[o(O,{modelValue:s.value.from,"onUpdate:modelValue":e[0]||(e[0]=t=>s.value.from=t),label:"Date From",type:"date",variant:"outlined",density:"comfortable"},null,8,["modelValue"])]),_:1}),o(v,{cols:"12",md:"4"},{default:n(()=>[o(O,{modelValue:s.value.to,"onUpdate:modelValue":e[1]||(e[1]=t=>s.value.to=t),label:"Date To",type:"date",variant:"outlined",density:"comfortable"},null,8,["modelValue"])]),_:1}),o(v,{cols:"12",md:"4"},{default:n(()=>[o(oe,{modelValue:s.value.rider,"onUpdate:modelValue":e[2]||(e[2]=t=>s.value.rider=t),items:ve(p).riderOptions,"item-title":"name","item-value":"id",clearable:"",dense:"",outlined:"",placeholder:"Search delivery persons...",class:"w-full",autocomplete:""},null,8,["modelValue","items"])]),_:1}),o(v,{cols:"12"},{default:n(()=>[o(_,{color:"primary",onClick:Y,disabled:!T.value,size:"large"},{default:n(()=>e[6]||(e[6]=[d(" Generate Invoice ")])),_:1,__:[6]},8,["disabled"])]),_:1})]),_:1}),P.invoices.length>0?(i(),g($,{key:0,class:"mt-6"},{default:n(()=>[o(G,null,{default:n(()=>e[7]||(e[7]=[d("Recent Invoices")])),_:1,__:[7]}),o(h,null,{default:n(()=>[o(K,null,{default:n(()=>[e[8]||(e[8]=l("thead",null,[l("tr",null,[l("th",null,"Invoice No"),l("th",null,"Agent"),l("th",null,"Period"),l("th",null,"Orders"),l("th",null,"Commission"),l("th",null,"Status"),l("th",null,"Actions")])],-1)),l("tbody",null,[(i(!0),y(J,null,Q(P.invoices,t=>(i(),y("tr",{key:t.id},[l("td",null,r(t.invoice_no),1),l("td",null,r(t.agent_name),1),l("td",null,r(t.period),1),l("td",null,r(t.order_count),1),l("td",null,r(C(t.total_commission)),1),l("td",null,[o(ne,{color:te(t.status),size:"small"},{default:n(()=>[d(r(t.status),1)]),_:2},1032,["color"])]),l("td",null,[o(_,{icon:"mdi-eye",size:"small",variant:"text",onClick:V=>ee(t)},null,8,["onClick"]),o(_,{icon:"mdi-download",size:"small",variant:"text",onClick:V=>le(t)},null,8,["onClick"])])]))),128))])]),_:1,__:[8]})]),_:1})]),_:1})):H("",!0)]),o(de,{modelValue:b.value,"onUpdate:modelValue":e[4]||(e[4]=t=>b.value=t),"max-width":"1000",persistent:""},{default:n(()=>[o($,null,{default:n(()=>[o(G,{class:"d-flex justify-space-between align-center"},{default:n(()=>[e[10]||(e[10]=l("span",null,"Generate Invoice",-1)),o(_,{icon:"mdi-close",variant:"text",onClick:S})]),_:1,__:[10]}),o(h,null,{default:n(()=>[j.value?(i(),g(L,{key:0,type:"info",variant:"tonal",class:"mb-4"},{default:n(()=>[e[11]||(e[11]=l("strong",null,"Agent:",-1)),d(" "+r(j.value.name)+" ",1),e[12]||(e[12]=l("br",null,null,-1)),e[13]||(e[13]=l("strong",null,"Period:",-1)),d(" "+r(E(s.value.from))+" to "+r(E(s.value.to)),1)]),_:1,__:[11,12,13]})):H("",!0),o(A,{class:"mb-4"},{default:n(()=>[o(v,{cols:"12",md:"6"},{default:n(()=>[o(O,{modelValue:f.value,"onUpdate:modelValue":e[3]||(e[3]=t=>f.value=t),modelModifiers:{number:!0},label:"Commission Rate (per order)",type:"number",prefix:"KES",variant:"outlined",density:"comfortable"},null,8,["modelValue"])]),_:1})]),_:1}),k.value?(i(),y("div",fe,[o(ae,{indeterminate:"",color:"primary",size:"64"}),e[14]||(e[14]=l("p",{class:"mt-4"},"Loading orders...",-1))])):m.value.length>0?(i(),g(K,{key:2,class:"mt-4"},{default:n(()=>[e[15]||(e[15]=l("thead",null,[l("tr",null,[l("th",null,"Order No"),l("th",null,"Customer"),l("th",null,"phone"),l("th",null,"COD"),l("th",null,"status date"),l("th",null,"quantity"),l("th",null,"product"),l("th",null,"address"),l("th",null,"Payment"),l("th",null,"Commission")])],-1)),l("tbody",null,[(i(!0),y(J,null,Q(m.value,t=>{var V,R,q,M,W;return i(),y("tr",{key:t.id},[l("td",null,r(t.order_no),1),l("td",null,r(((V=t.customer)==null?void 0:V.full_name)||"N/A"),1),l("td",null,r(((R=t.customer)==null?void 0:R.phone)||"N/A"),1),l("td",null,r(C(t.cod_amount||t.total_price)),1),l("td",null,r(E((q=t.latest_status)==null?void 0:q.created_at)),1),l("td",null,r((t.order_items||[]).reduce((x,N)=>x+(Number(N.quantity)||0),0)),1),l("td",null,r((t.order_items||[]).map(x=>{var N;return((N=x.product)==null?void 0:N.product_name)||x.sku||"N/A"}).join(", ")),1),l("td",null,r(((M=t.customer)==null?void 0:M.address)||((W=t.shipping_address)==null?void 0:W.address)||"N/A"),1),l("td",null,r(t.payment_method||(Number(t.amount_paid||0)>0?"Prepaid":"COD")),1),l("td",null,r(C(f.value)),1)])}),128))])]),_:1,__:[15]})):(i(),g(L,{key:3,type:"warning",variant:"tonal",class:"mt-4"},{default:n(()=>e[16]||(e[16]=[d(" No orders found for the selected period and agent. ")])),_:1,__:[16]})),o(re,{class:"my-4"}),o($,{variant:"tonal",color:"primary"},{default:n(()=>[o(h,null,{default:n(()=>[o(A,null,{default:n(()=>[o(v,{cols:"6"},{default:n(()=>[e[17]||(e[17]=l("strong",null,"Total Orders:",-1)),d(" "+r(m.value.length),1)]),_:1,__:[17]}),o(v,{cols:"6",class:"text-right"},{default:n(()=>[e[18]||(e[18]=l("strong",null,"Total Commission:",-1)),d(" "+r(C(B.value)),1)]),_:1,__:[18]})]),_:1})]),_:1})]),_:1})]),_:1}),o(ue,null,{default:n(()=>[o(se),o(_,{variant:"text",onClick:S},{default:n(()=>e[19]||(e[19]=[d("Cancel")])),_:1,__:[19]}),o(_,{color:"success",onClick:Z,disabled:m.value.length===0||k.value,loading:D.value},{default:n(()=>e[20]||(e[20]=[d(" Generate Invoice ")])),_:1,__:[20]},8,["disabled","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(ie,{modelValue:I.value,"onUpdate:modelValue":e[5]||(e[5]=t=>I.value=t),color:F.value,timeout:"3000"},{default:n(()=>[d(r(U.value),1)]),_:1},8,["modelValue","color"])]),_:1})}}};export{De as default};
