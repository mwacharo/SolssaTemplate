import{E as Ne,r as s,P as Ue,j as w,i as l}from"./app-DEn6gJZO.js";import{n as c}from"./toast-D2LqBDAu.js";const Le=Ne("orders",()=>{const g=s(""),f=s(""),S=Ue({deliveryPerson:"",callCentreAgent:"",status:"",notes:"",zone:"",city:""}),d=s([]),i=s({orders:!1,options:!1,creating:!1,updating:!1,deleting:!1}),p=s(null),ee=s([]),z=s(!1),y=s(!1),_=s(null),O=s(null),x=s(!1),P=s(!1),A=s(null),F=s(null),b=s(null),C=s(null),D=s(null),k=s(null),j=s(null),m=s(null),v=s([]),R=s(""),te=s([]),q=s([]),$=s([]),L=s([]),M=s([]),V=s([]),W=s([]),Z=s([]),G=s([]),H=s([]),J=s([]),ae=s([]),re=s([]),K=s([]),T=s({current_page:1,last_page:1,per_page:15,total:0,from:0,to:0}),se=w(()=>e=>d.value.find(t=>t.id===e)),oe=w(()=>d.value.filter(e=>e.status===1)),le=w(()=>d.value.filter(e=>e.status===0)),ne=w(()=>d.value.filter(e=>e.status===2)),ie=w(()=>d.value.reduce((e,t)=>e+parseFloat(t.total_price||0),0)),ce=w(()=>{let e=0;return A.value&&e++,F.value&&e++,b.value&&e++,C.value&&e++,D.value&&e++,k.value&&e++,j.value&&e++,m.value&&e++,v.value&&v.value.length>0&&e++,R.value&&e++,e}),de=w(()=>({status:A.value,product:F.value,zone:b.value,agent:C.value,rider:D.value,vendor:k.value,city:j.value,category:m.value,dateRange:v.value,search:R.value})),B=async(e={})=>{var t,a;i.value.orders=!0,p.value=null;try{const r=new URLSearchParams;e.page&&r.append("page",e.page),e.per_page&&r.append("per_page",e.per_page),e.status&&r.append("status",e.status),e.vendor_id&&r.append("vendor_id",e.vendor_id),e.city&&r.append("city",e.city),e.agent_id&&r.append("agent_id",e.agent_id),e.rider_id&&r.append("rider_id",e.rider_id),e.zone_id&&r.append("zone_id",e.zone_id),e.product_id&&r.append("product_id",e.product_id),e.category_id&&r.append("category_id",e.category_id),e.search&&r.append("search",e.search),e.created_from&&r.append("created_from",e.created_from),e.created_to&&r.append("created_to",e.created_to);const n=(await l.get(`/api/v1/orders?${r.toString()}`,{headers:{Accept:"application/json","Content-Type":"application/json"}})).data;if(!n.success)throw new Error(n.message||"Failed to fetch orders");P.value=!1;const u=n.data;return d.value=u.data||[],T.value={current_page:u.current_page||1,last_page:u.last_page||1,itemsPerPage:u.per_page||15,total:u.total||0,from:u.from||0,to:u.to||0},u}catch(r){throw p.value=((a=(t=r.response)==null?void 0:t.data)==null?void 0:a.message)||r.message||"Failed to fetch orders",r}finally{i.value.orders=!1}},h=s([]),ue=async e=>{var t,a;if(!(!e||e.length===0))try{const r=await l.post("/api/v1/bulk-print-waybills",{order_ids:e},{headers:{Accept:"application/json","Content-Type":"application/json"},responseType:"blob"}),o=window.URL.createObjectURL(new Blob([r.data])),n=document.createElement("a");n.href=o,n.setAttribute("download","waybills.pdf"),document.body.appendChild(n),n.click(),n.remove(),c.success("Waybills printed successfully")}catch(r){throw c.error("Failed to print waybills"),p.value=((a=(t=r.response)==null?void 0:t.data)==null?void 0:a.message)||r.message||"Failed to print waybill",r}},Q=async e=>{i.value.orders=!0,p.value=null;try{const t=await X(e);return O.value=t,_.value=e,t}catch(t){throw p.value=t.message||"Failed to load order",t}finally{i.value.orders=!1}},pe=async e=>{var t,a;i.value.creating=!0,p.value=null;try{const o=(await l.post("/api/v1/orders",e,{headers:{Accept:"application/json","Content-Type":"application/json"}})).data;if(!o.success)throw new Error(o.message||"Failed to create order");return d.value.unshift(o.data),T.value.total+=1,o.data;c.success("Order created successfully")}catch(r){throw c.error("Failed to create order"),p.value=((a=(t=r.response)==null?void 0:t.data)==null?void 0:a.message)||r.message||"Failed to create order",r}finally{i.value.creating=!1}},N=async(e,t)=>{var a,r;i.value.updating=!0,p.value=null;try{const n=(await l.put(`/api/v1/orders/${e}`,t,{headers:{Accept:"application/json","Content-Type":"application/json"}})).data;if(!n.success)throw new Error(n.message||"Failed to update order");const u=d.value.findIndex(U=>U.id===e);return u!==-1&&(d.value[u]=n.data),_.value===e&&(O.value=n.data),n.data;c.success("Order updated successfully")}catch(o){throw c.error("Failed to update order"),p.value=((r=(a=o.response)==null?void 0:a.data)==null?void 0:r.message)||o.message||"Failed to update order",o}finally{i.value.updating=!1}},ve=async e=>{var t,a;i.value.deleting=!0,p.value=null;try{const o=(await l.delete(`/api/v1/orders/${e}`,{headers:{Accept:"application/json"}})).data;if(!o.success)throw new Error(o.message||"Failed to delete order");const n=d.value.findIndex(u=>u.id===e);n!==-1&&(d.value.splice(n,1),T.value.total-=1),c.success("Order deleted successfully")}catch(r){throw c.error("Failed to delete order"),p.value=((a=(t=r.response)==null?void 0:t.data)==null?void 0:a.message)||r.message||"Failed to delete order",r}finally{i.value.deleting=!1}},X=async e=>{var t,a;try{const o=(await l.get(`/api/v1/orders/${e}`,{headers:{Accept:"application/json"}})).data;if(!o.success)throw new Error(o.message||"Failed to fetch order details");return o.data}catch(r){const o=((a=(t=r.response)==null?void 0:t.data)==null?void 0:a.message)||r.message||"Failed to fetch order details";throw new Error(o)}},ge=async(e,t)=>N(e,{customer:t}),fe=async(e,t)=>N(e,{order_items:t}),Y=async(e=null)=>{if(i.value.options){console.log("Options already loading, skipping...");return}i.value.options=!0;try{console.log("Fetching dropdown options...");const t=[l.get("/api/v1/statuses").catch(()=>({data:{data:[]}})),l.get("/api/v1/categories").catch(()=>({data:{data:[]}})),l.get("/api/v1/cities").catch(()=>({data:{data:[]}})),l.get("/api/v1/zones").catch(()=>({data:{data:[]}})),l.get("/api/v1/agents").catch(()=>({data:{data:[]}})),l.get("/api/v1/riders").catch(()=>({data:{data:[]}})),l.get("/api/v1/vendors").catch(()=>({data:{data:[]}})),l.get("/api/v1/countries").catch(()=>({data:{data:[]}})),l.get("/api/v1/warehouses").catch(()=>({data:{data:[]}})),l.get("/api/v1/clients").catch(()=>({data:{data:[]}}))];e?t.push(l.get(`/api/v1/vendors/${e}/products`).catch(()=>({data:{success:!1,data:[]}}))):t.push(l.get("/api/v1/products").catch(()=>({data:{success:!1,data:[]}})));const a=E=>!E||!E.data?[]:Array.isArray(E.data)?E.data:Array.isArray(E.data.data)?E.data.data:[],[r,o,n,u,U,Te,ze,Pe,Se,xe,Be]=await Promise.all(t);K.value=a(r),$.value=a(o),L.value=a(n),M.value=a(u),V.value=a(U),W.value=a(Te),Z.value=a(ze),J.value=a(Pe),H.value=a(Se),G.value=a(xe),q.value=a(Be),console.log("Dropdown options loaded successfully")}catch(t){throw console.error("Failed to fetch dropdown options:",t),t}finally{i.value.options=!1}},ye=async e=>{if(_.value=e,P.value=!1,z.value=!0,e){const t=await Q(e);return O.value=t,t}},he=()=>{z.value=!0,_.value=null,O.value=null,P.value=!0},we=()=>{z.value=!1,_.value=null,O.value=null},_e=()=>{A.value=null,F.value=null,b.value=null,C.value=null,D.value=null,k.value=null,j.value=null,m.value=null,v.value=[],R.value=""},Oe=async()=>{const e={};A.value&&(e.status=A.value),F.value&&(e.product_id=F.value),b.value&&(e.zone_id=b.value),C.value&&(e.agent_id=C.value),D.value&&(e.rider_id=D.value),k.value&&(e.vendor_id=k.value),j.value&&(e.city=j.value),m.value&&(e.category_id=m.value),R.value&&(e.search=R.value),v.value&&v.value.length===2&&(e.created_from=v.value[0],e.created_to=v.value[1]),e.page=1,await B(e)},Ae=async()=>{if(!x.value)try{await Promise.all([Y(),B({page:1})]),x.value=!0}catch(e){console.error("Failed to initialize order store:",e)}},Fe=(e=[])=>{console.debug("openAssignDeliveryDialog called with:",e),h.value=e,g.value="assignDelivery",f.value="Assign Delivery Person",y.value=!0,console.debug("Bulk action dialog opened. State:",{selectedOrders:h.value,dialogType:g.value,dialogTitle:f.value,bulkActionDialog:y.value})},be=(e=[])=>{h.value=e,g.value="assignCallCentre",f.value="Assign Call Centre Agent",y.value=!0},Ce=(e=[])=>{h.value=e,g.value="status",f.value="Change Status",y.value=!0},De=(e=[])=>{h.value=e,g.value="delete",f.value="Delete Orders",y.value=!0},I=()=>{y.value=!1,g.value="",f.value="",h.value=[],Object.keys(S).forEach(e=>{S[e]=""})},ke=async e=>{i.value.updating=!0;try{const{type:t,data:a,orders:r}=e,o=Array.isArray(r)&&r.length>0?r:h.value;switch(console.debug("handleBulkAction called with:",{type:t,data:a,orders:o}),t){case"assignDelivery":if(!a.deliveryPerson)throw console.error("No delivery person selected"),new Error("No delivery person selected");console.debug("Assigning delivery person:",a.deliveryPerson,"to orders:",o),await je(o,a.deliveryPerson);break;case"assignCallCentre":if(!a.callCentreAgent)throw console.error("No call centre agent selected"),new Error("No call centre agent selected");console.debug("Assigning call centre agent:",a.callCentreAgent,"to orders:",o),await me(o,a.callCentreAgent);break;case"status":if(!a.status)throw console.error("No status selected"),new Error("No status selected");console.debug("Updating status for orders:",o,"with status:",a.status),await Re(o,a.status);break;case"delete":console.debug("Deleting orders:",o),await Ee(o);break;default:console.warn("Unknown bulk action type:",t)}I()}catch(t){console.error("Bulk action failed:",t)}finally{i.value.updating=!1}},je=async(e=[],t)=>{if(!e.length||!t)throw new Error("Orders and deliveryPersonId are required");try{await l.post("/api/v1/orders/assign-rider",{order_ids:e,rider_id:t},{headers:{Accept:"application/json","Content-Type":"application/json"}}),console.log("Assigned delivery person:",t,"to orders:",e),c.success("Rider assigned successfully")}catch(a){throw c.error("Failed to assign rider"),console.error("Failed to assign rider:",a),a}},me=async(e=[],t)=>{if(!e.length||!t)throw new Error("Orders and agentId are required");try{await l.post("/api/v1/orders/assign-agent",{order_ids:e,agent_id:t},{headers:{Accept:"application/json","Content-Type":"application/json"}}),console.log("Assigned call centre agent:",t,"to orders:",e),c.success("Call centre agent assigned successfully")}catch(a){throw c.error("Failed to assign call centre agent"),console.error("Failed to assign agent:",a),a}},Re=async(e=[],t)=>{if(!e.length||!t)throw new Error("Orders and status are required");try{await l.post("/api/v1/orders/update-status",{order_ids:e,status:t},{headers:{Accept:"application/json","Content-Type":"application/json"}}),console.log("Updated status for orders:",e,"to status:",t),c.success("Order status updated successfully")}catch(a){throw c.error("Failed to update order status"),console.error("Failed to update status:",a),a}},Ee=async(e=[])=>{if(!e.length)throw new Error("No orders selected for deletion");try{await l.post("/api/v1/orders/bulk-delete",{order_ids:e},{headers:{Accept:"application/json","Content-Type":"application/json"}}),Array.isArray(d.value)&&e.forEach(t=>{const a=d.value.findIndex(r=>r.id===t);a!==-1&&(d.value.splice(a,1),T.value.total-=1)}),console.log("Deleted orders:",e),c.success("Orders deleted successfully")}catch(t){throw c.error("Failed to bulk delete orders"),console.error("Failed to bulk delete orders:",t),t}};return{orders:d,loading:i,error:p,notifications:ee,dialog:z,bulkActionDialog:y,selectedOrderId:_,selectedOrder:O,initialized:x,isCreateMode:P,orderFilterStatus:A,orderFilterProduct:F,orderFilterZone:b,orderFilterAgent:C,orderFilterRider:D,orderFilterVendor:k,orderFilterCity:j,orderFilterCategory:m,orderDateRange:v,orderSearch:R,orderStatusOptions:te,productOptions:q,categoryOptions:$,cityOptions:L,zoneOptions:M,agentOptions:V,riderOptions:W,vendorOptions:Z,clientOptions:G,warehouseOptions:H,countryOptions:J,deliveryStatusOptions:ae,userOptions:re,statusOptions:K,pagination:T,getOrderById:se,confirmedOrders:oe,pendingOrders:le,cancelledOrders:ne,totalRevenue:ie,activeFilterCount:ce,currentFilters:de,printOrders:ue,fetchOrders:B,loadOrder:Q,createOrder:pe,updateOrder:N,updateOrderCustomer:ge,updateOrderItems:fe,deleteOrder:ve,getOrderDetails:X,fetchDropdownOptions:Y,openDialog:ye,openCreateDialog:he,openAssignDeliveryDialog:Fe,openAssignCallCentreDialog:be,openBulkStatusDialog:Ce,dialogType:g,dialogTitle:f,bulkActionForm:S,openDeleteDialog:De,closeBulkActionDialog:I,handleBulkAction:ke,closeDialog:we,clearAllFilters:_e,applyFilters:Oe,initialize:Ae}});export{Le as u};
