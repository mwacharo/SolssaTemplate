import{E as $,i as h}from"./app-BAMjVpRk.js";var _,P;function b(){if(P)return _;P=1;let e={comma(s){return e.split(s,[","],!0)},space(s){let t=[" ",`
`,"	"];return e.split(s,t)},split(s,t,r){let a=[],i="",m=!1,d=0,g=!1,y="",p=!1;for(let n of s)p?p=!1:n==="\\"?p=!0:g?n===y&&(g=!1):n==='"'||n==="'"?(g=!0,y=n):n==="("?d+=1:n===")"?d>0&&(d-=1):d===0&&t.includes(n)&&(m=!0),m?(i!==""&&a.push(i.trim()),i="",m=!1):i+=n;return(r||i!=="")&&a.push(i.trim()),a}};return _=e,e.default=e,_}b();const R=$("whatsapp",{state:()=>({dialog:!1,conversation:[],replyMessage:"",showEmojiPicker:!1,attachment:{image:null,audio:null},messages:[],contacts:[],orders:[],templates:[],riders:[],agents:[],selectedRiders:[],selectedAgents:[],selectedContacts:[],selectedOrders:[],selectedTemplate:null,messageText:"",currentPage:1,perPage:20,totalMessages:0,totalOrders:0,loading:{conversation:!1,messages:!1,contacts:!1,orders:!1,templates:!1,sending:!1,importing:!1,savingTemplate:!1,deletingTemplate:!1,uploadingOrders:!1},showImportDialog:!1,showNewMessageDialog:!1,showTemplateDialog:!1,showOrderImportDialog:!1,showOrderMessageDialog:!1,activeTab:"messages",search:"",filterType:"all",filterStatus:"all",orderFilters:{status:"all",product:"",agent:"",zone:"",createdDateStart:null,createdDateEnd:null,deliveryDateStart:null,deliveryDateEnd:null,vendorRecallStart:null,vendorRecallEnd:null},errorMessage:"",successMessage:"",stats:{sent:0,delivered:0,read:0,failed:0,pending:0,totalOrders:0,pendingOrders:0,deliveredOrders:0},whatsappStatus:"Connected",csvFile:null,orderFile:null,orderTemplates:[]}),getters:{hasAttachment:e=>!!(e.attachment.image||e.attachment.audio),filteredContacts:e=>{if(!Array.isArray(e.contacts))return[];let s=[...e.contacts];return e.filterType!=="all"&&(s=s.filter(t=>t.type===e.filterType)),e.filterStatus!=="all"&&(s=s.filter(t=>t.status===e.filterStatus)),s},filteredOrders:e=>{if(!Array.isArray(e.orders))return[];let s=[...e.orders];return e.orderFilters.status!=="all"&&(s=s.filter(t=>t.status===e.orderFilters.status)),e.orderFilters.product&&(s=s.filter(t=>{var r;return(r=t.product_name)==null?void 0:r.toLowerCase().includes(e.orderFilters.product.toLowerCase())})),e.orderFilters.agent&&(s=s.filter(t=>{var r;return(r=t.agent_name)==null?void 0:r.toLowerCase().includes(e.orderFilters.agent.toLowerCase())})),e.orderFilters.zone&&(s=s.filter(t=>{var r;return(r=t.zone)==null?void 0:r.toLowerCase().includes(e.orderFilters.zone.toLowerCase())})),e.orderFilters.createdDateStart&&(s=s.filter(t=>{const r=new Date(t.created_at),a=new Date(e.orderFilters.createdDateStart);return r>=a})),e.orderFilters.createdDateEnd&&(s=s.filter(t=>{const r=new Date(t.created_at),a=new Date(e.orderFilters.createdDateEnd);return r<=a})),e.orderFilters.deliveryDateStart&&e.orderFilters.deliveryDateEnd&&(s=s.filter(t=>{if(!t.delivery_date)return!1;const r=new Date(t.delivery_date),a=new Date(e.orderFilters.deliveryDateStart),i=new Date(e.orderFilters.deliveryDateEnd);return r>=a&&r<=i})),e.orderFilters.vendorRecallStart&&e.orderFilters.vendorRecallEnd&&(s=s.filter(t=>{if(!t.vendor_recall_date)return!1;const r=new Date(t.vendor_recall_date),a=new Date(e.orderFilters.vendorRecallStart),i=new Date(e.orderFilters.vendorRecallEnd);return r>=a&&r<=i})),s},filteredMessages:e=>{if(!e.search||!Array.isArray(e.messages))return e.messages;const s=e.search.toLowerCase();return e.messages.filter(t=>{var r,a,i,m,d;return((r=t.content)==null?void 0:r.toLowerCase().includes(s))||((a=t.status)==null?void 0:a.toLowerCase().includes(s))||((i=t.recipient_name)==null?void 0:i.toLowerCase().includes(s))||((m=t.recipient_phone)==null?void 0:m.toLowerCase().includes(s))||((d=t.order_number)==null?void 0:d.toLowerCase().includes(s))})},validWhatsappContacts:e=>Array.isArray(e.contacts)?e.contacts.filter(s=>s.whatsapp||s.alt_phone||s.phone):[],totalPages:e=>Math.ceil(e.totalMessages/e.perPage),totalOrderPages:e=>Math.ceil(e.totalOrders/e.perPage),allTemplates:e=>[...e.templates,...e.orderTemplates]},actions:{setDialog(e){this.dialog=e},appendEmoji(e){this.replyMessage+=e},setAttachmentImage(e){this.attachment.image=e},setAttachmentAudio(e){this.attachment.audio=e},resetAttachment(){this.attachment.image=null,this.attachment.audio=null},toggleEmojiPicker(){this.showEmojiPicker=!this.showEmojiPicker},showError(e){this.errorMessage=e,setTimeout(()=>{this.errorMessage=""},5e3)},showSuccess(e){this.successMessage=e,setTimeout(()=>{this.successMessage=""},5e3)},formatPhoneNumber(e){return e?e.replace(/@c\.us$/,""):"Unknown"},async loadMessages(e=1){var s,t,r;try{this.loading.messages=!0,this.currentPage=e;const a=await h.get("/api/v1/whatsapp-messages",{params:{page:e,per_page:this.perPage}});Array.isArray(a.data.data)?(this.messages=a.data.data,this.totalMessages=((s=a.data.meta)==null?void 0:s.total)||this.messages.length,this.calculateStats()):(console.error("Unexpected API response format:",a.data),this.messages=[],this.showError("Invalid data format received from server"))}catch(a){console.error("Error loading messages:",a),this.showError(`Failed to load messages: ${((r=(t=a.response)==null?void 0:t.data)==null?void 0:r.message)||a.message}`),this.messages=[]}finally{this.loading.messages=!1}},async loadContacts(){var e,s,t,r;try{this.loading.contacts=!0;const a=await h.get("/api/v1/contacts");(s=(e=a.data)==null?void 0:e.data)!=null&&s.data&&Array.isArray(a.data.data.data)?(this.contacts=a.data.data.data,console.log("Contacts loaded:",this.contacts.length)):(console.error("Unexpected API response format:",a.data),this.contacts=[],this.showError("Invalid contact data format received from server"))}catch(a){console.error("Error loading contacts:",a),this.showError(`Failed to load contacts: ${((r=(t=a.response)==null?void 0:t.data)==null?void 0:r.message)||a.message}`),this.contacts=[]}finally{this.loading.contacts=!1}},async loadTemplates(){var e;try{this.loading.templates=!0;const s=await h.get("/api/v1/templates");(e=s.data)!=null&&e.data&&Array.isArray(s.data.data)?(this.templates=s.data.data,console.log("Templates loaded:",this.templates.length)):(console.error("Unexpected API response format:",s.data),this.templates=[],this.showError("Failed to load custom templates, using default order templates"))}catch(s){console.error("Error loading templates:",s),this.templates=[],this.showError("Failed to load custom templates, using default order templates")}finally{this.loading.templates=!1}},async loadRiders(){var e,s,t;try{this.loading.riders=!0;const r=await h.get("/api/v1/riders");(e=r.data)!=null&&e.data&&Array.isArray(r.data.data)?(this.riders=r.data.data,console.log("Riders loaded:",this.riders.length)):(console.error("Unexpected API response format:",r.data),this.riders=[],this.showError("Failed to load riders"))}catch(r){console.error("Error loading riders:",r),this.riders=[],this.showError(`Failed to load riders: ${((t=(s=r.response)==null?void 0:s.data)==null?void 0:t.message)||r.message}`)}finally{this.loading.riders=!1}},async loadAgents(){var e,s,t;try{this.loading.agents=!0;const r=await h.get("/api/v1/agents");(e=r.data)!=null&&e.data&&Array.isArray(r.data.data)?(this.agents=r.data.data.map(a=>({id:a.id,name:a.name,phone:a.phone,email:a.email,...a})),console.log("Agents loaded:",this.agents.length)):(console.error("Unexpected API response format:",r.data),this.agents=[],this.showError("Failed to load agents"))}catch(r){console.error("Error loading agents:",r),this.agents=[],this.showError(`Failed to load agents: ${((t=(s=r.response)==null?void 0:s.data)==null?void 0:t.message)||r.message}`)}finally{this.loading.agents=!1}},calculateStats(){if(!Array.isArray(this.messages)){console.error("messages is not an array:",this.messages);return}try{const e=this.messages.reduce((s,t)=>{const r=t&&t.status&&typeof t.status=="string"?t.status.toLowerCase():"unknown";return s[r]=(s[r]||0)+1,s},{});this.stats={...this.stats,sent:e.sent||0,delivered:e.delivered||0,read:e.read||0,failed:e.failed||0,pending:e.pending||0}}catch(e){console.error("Error calculating message stats:",e)}},calculateOrderStats(){if(Array.isArray(this.orders))try{const e=this.orders.reduce((s,t)=>{var a;const r=((a=t.status)==null?void 0:a.toLowerCase())||"unknown";return s[r]=(s[r]||0)+1,s},{});this.stats={...this.stats,totalOrders:this.orders.length,pendingOrders:e.pending||0,deliveredOrders:e.delivered||0}}catch(e){console.error("Error calculating order stats:",e)}},onTemplateSelect(e){var a,i;if(console.log("Template selected:",e),!e||!e.content){console.log("No template or content found");return}this.selectedTemplate=e;const s=((a=this.selectedContacts)==null?void 0:a[0])||{},t=((i=this.selectedOrders)==null?void 0:i[0])||{},r={customer_name:s.name||t.customer_name||"Customer",customer_phone:s.phone||t.customer_phone||"",order_number:t.order_number||"",product_name:t.product_name||"",price:t.price||"",tracking_id:t.tracking_id||""};this.messageText=this.parseTemplate(e.content,r),console.log("Parsed messageText:",this.messageText)},parseTemplate(e,s={}){return Object.entries(s).reduce((t,[r,a])=>{const i=new RegExp(`{{\\s*${r}\\s*}}`,"g");return t.replace(i,String(a??""))},e)},resetFilters(){this.search="",this.filterType="all",this.filterStatus="all",this.orderFilters={status:"all",product:"",agent:"",zone:"",createdDateStart:null,createdDateEnd:null,deliveryDateStart:null,deliveryDateEnd:null,vendorRecallStart:null,vendorRecallEnd:null}},async sendMessage(e){var s,t,r,a,i,m,d,g,y,p,n,D,v,E,T,A,F;if(console.log("ðŸš€ Sending message, userId:",e),!this.messageText.trim())return console.log("Message text is empty"),this.showError("Please enter a message");if(!((s=this.selectedContacts)!=null&&s.length))return console.log("No contacts selected"),this.showError("Please select at least one recipient");try{this.loading.sending=!0;const u=[];for(const l of this.selectedContacts){console.log("ðŸ“§ Processing:",l.name);let o=null;l.orderId?(o=this.orders.find(c=>c.id===l.orderId),console.log("âœ… Found by orderId:",o==null?void 0:o.order_no)):l.orderData&&(o=l.orderData,console.log("âœ… Using orderData:",o==null?void 0:o.order_no)),o||console.warn("âš ï¸ No order for:",l.name);let C="";((t=o==null?void 0:o.order_items)==null?void 0:t.length)>0&&(C=o.order_items.map(c=>{var O;const L=c.name||((O=c.product)==null?void 0:O.product_name)||c.sku||"Item";return`- ${c.quantity} Ã— ${L}`}).join(`
`));const f=(r=o==null?void 0:o.assignments)==null?void 0:r.find(c=>c.role==="CallAgent"),w=(a=o==null?void 0:o.assignments)==null?void 0:a.find(c=>c.role==="Delivery Agent"),M={customer_name:l.name||((i=o==null?void 0:o.customer)==null?void 0:i.full_name)||"Customer",customer_phone:l.phone||"",order_number:(o==null?void 0:o.order_no)||"",order_no:(o==null?void 0:o.order_no)||"",tracking_id:(o==null?void 0:o.tracking_no)||(o==null?void 0:o.tracking_number)||"",order_items:C,total_price:(o==null?void 0:o.total_price)||"0.00",delivery_date:(o==null?void 0:o.delivery_date)||"",agent_name:((m=f==null?void 0:f.user)==null?void 0:m.name)||"",agent_phone:((d=f==null?void 0:f.user)==null?void 0:d.phone_number)||"",rider_name:((g=w==null?void 0:w.user)==null?void 0:g.name)||"",rider_phone:((y=w==null?void 0:w.user)==null?void 0:y.phone_number)||"",vendor_name:((p=o==null?void 0:o.vendor)==null?void 0:p.name)||"",status:((D=(n=o==null?void 0:o.latest_status)==null?void 0:n.status)==null?void 0:D.name)||""};console.log("ðŸ“‹ Placeholders:",M);const x=this.parseTemplate(((v=this.selectedTemplate)==null?void 0:v.content)||this.messageText,M),S={user_id:e,template_id:((E=this.selectedTemplate)==null?void 0:E.id)||null,template_slug:((T=this.selectedTemplate)==null?void 0:T.slug)||"general",contacts:[{id:l.id,name:l.name,phone:l.phone,chatId:l.whatsapp||l.phone,orderId:l.orderId||(o==null?void 0:o.id)||null,orderOid:l.orderOid||(o==null?void 0:o.order_no)||null}],message:x,order:o?{id:o.id,order_no:o.order_no,order_items:o.order_items,total_price:o.total_price,customer:o.customer}:null};console.log("ðŸ“¤ Payload:",S);const I=await h.post("/api/v1/whatsapp/send-message",S);u.push({contact:l.name,phone:l.phone,orderId:o==null?void 0:o.id,status:"sent",result:I.data})}this.showSuccess(`Messages sent to ${u.length} recipients`),this.messageText="",this.selectedContacts=[],this.selectedOrders=[],this.selectedTemplate=null,this.showNewMessageDialog=!1,setTimeout(()=>this.loadMessages(1),1e3)}catch(u){console.error("âŒ Error:",u),this.showError(((F=(A=u.response)==null?void 0:A.data)==null?void 0:F.message)||u.message)}finally{this.loading.sending=!1}},async sendOrderMessage(e){var s,t,r;if(!this.messageText.trim())return this.showError("Please enter a message");if(!Array.isArray(this.selectedOrders)||this.selectedOrders.length===0)return this.showError("Please select at least one order");try{this.loading.sending=!0;const a=await h.post("/api/v1/whatsapp-send-orders",{user_id:e,orders:this.selectedOrders.map(i=>({id:i.id,order_number:i.order_number,customer_name:i.customer_name,customer_phone:i.customer_phone,product_name:i.product_name,price:i.price,tracking_id:i.tracking_id})),message:this.messageText,template_id:((s=this.selectedTemplate)==null?void 0:s.id)||null});this.showSuccess(`Order messages sent to ${this.selectedOrders.length} customers`),this.messageText="",this.selectedOrders=[],this.selectedTemplate=null,this.showOrderMessageDialog=!1,setTimeout(()=>{this.loadMessages(1)},1e3)}catch(a){console.error("Error sending order messages:",a),this.showError(`Failed to send order messages: ${((r=(t=a.response)==null?void 0:t.data)==null?void 0:r.message)||a.message}`)}finally{this.loading.sending=!1}},async importContacts(e){var s,t,r;if(!this.csvFile)return this.showError("Please select a CSV file to import");try{this.loading.importing=!0;const a=new FormData;a.append("file",this.csvFile),a.append("user_id",e);const i=await h.post("/api/v1/contacts/import",a,{headers:{"Content-Type":"multipart/form-data"}});i.data&&i.data.success?(this.showSuccess(`Successfully imported ${i.data.imported||"multiple"} contacts`),await this.loadContacts(),this.showImportDialog=!1,this.csvFile=null):this.showError(((s=i.data)==null?void 0:s.message)||"Import failed")}catch(a){console.error("Error importing contacts:",a),this.showError(`Failed to import contacts: ${((r=(t=a.response)==null?void 0:t.data)==null?void 0:r.message)||a.message}`)}finally{this.loading.importing=!1}},async importOrders(e){var s,t,r;if(!this.orderFile)return this.showError("Please select an Excel or CSV file to import");try{this.loading.uploadingOrders=!0;const a=new FormData;a.append("file",this.orderFile),a.append("user_id",e);const i=await h.post("/api/v1/orders/import",a,{headers:{"Content-Type":"multipart/form-data"}});i.data&&i.data.success?(this.showSuccess(`Successfully imported ${i.data.imported||"multiple"} orders`),this.showOrderImportDialog=!1,this.orderFile=null):this.showError(((s=i.data)==null?void 0:s.message)||"Order import failed")}catch(a){console.error("Error importing orders:",a),this.showError(`Failed to import orders: ${((r=(t=a.response)==null?void 0:t.data)==null?void 0:r.message)||a.message}`)}finally{this.loading.uploadingOrders=!1}},async openNewMessageDialog(){this.errorMessage="",this.messageText="",this.selectedContacts=[],this.selectedTemplate=null,(!Array.isArray(this.contacts)||this.contacts.length===0)&&!this.loading.contacts&&await this.loadContacts(),(!Array.isArray(this.templates)||this.templates.length===0)&&!this.loading.templates&&await this.loadTemplates(),this.showNewMessageDialog=!0},async openNewMessageDialog(e=[]){this.errorMessage="",this.messageText="",this.selectedContacts=[],this.selectedTemplate=null,(!Array.isArray(this.templates)||this.templates.length===0)&&!this.loading.templates&&await this.loadTemplates(),Array.isArray(e)&&e.length>0?(console.log("openNewMessageDialog: selectedOrders:",e),this.selectedContacts=e.map(s=>{const t=this.orders.find(r=>r.id===s);return t?t.client?{id:t.client.id,name:t.client.name||t.client.phone,phone:t.client.phone_number,alt_phone:t.client.alt_phone}:(console.warn("Order has no client:",t),null):(console.warn("Order not found for id:",s),null)}).filter(s=>{const t=(s==null?void 0:s.id)&&(s==null?void 0:s.phone);return t||console.warn("Invalid client object:",s),t}),console.log("openNewMessageDialog: selectedContacts from orders:",this.selectedContacts)):((!Array.isArray(this.contacts)||this.contacts.length===0)&&!this.loading.contacts&&await this.loadContacts(),this.selectedContacts=[],console.log("Loaded all contacts:",this.contacts)),this.showNewMessageDialog=!0},async openOrderMessageDialog(){this.errorMessage="",this.messageText="",this.selectedOrders=[],this.selectedTemplate=null,(!Array.isArray(this.orders)||this.orders.length===0)&&this.loading.orders,(!Array.isArray(this.templates)||this.templates.length===0)&&!this.loading.templates&&await this.loadTemplates(),this.showOrderMessageDialog=!0},async deleteMessage(e){var s,t;if(!e)return this.showError("Invalid message ID");if(confirm("Are you sure you want to delete this message?"))try{await h.delete(`/api/v1/whatsapp-messages/${e}`),Array.isArray(this.messages)&&(this.messages=this.messages.filter(r=>r.id!==e),this.calculateStats()),this.showSuccess("Message deleted successfully")}catch(r){console.error("Error deleting message:",r),this.showError(`Failed to delete message: ${((t=(s=r.response)==null?void 0:s.data)==null?void 0:t.message)||r.message}`)}},async initialize(){this.messages=[],this.contacts=[],this.orders=[],this.templates=[],this.riders=[],this.agents=[],await Promise.all([this.loadMessages(1),this.loadContacts(),this.loadTemplates(),this.loadRiders(),this.loadAgents()])}}});export{R as u};
