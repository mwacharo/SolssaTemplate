import{E as Ve,r as l,P as We,j as _,i as o}from"./app-CAy57pox.js";import{n as c}from"./toast-D74Ymlbb.js";const He=Ve("orders",()=>{const w=l(""),m=l(""),L=We({deliveryPerson:"",callCentreAgent:"",status:"",notes:"",zone:"",city:""}),u=l([]),i=l({orders:!1,options:!1,creating:!1,updating:!1,deleting:!1}),d=l(null),le=l([]),B=l(!1),O=l(!1),F=l(null),A=l(null),U=l(!1),q=l(!1),D=l(null),C=l(null),b=l(null),R=l(null),k=l(null),E=l(null),S=l(null),z=l(null),g=l([null,null]),f=l([null,null]),y=l([null,null]),j=l(""),$=l({}),oe=l([]),V=l([]),W=l([]),Y=l([]),Z=l([]),G=l([]),H=l([]),J=l([]),K=l([]),Q=l([]),X=l([]),ne=l([]),ie=l([]),I=l([]),h=l({current_page:1,last_page:1,per_page:15,total:0,from:0,to:0}),ue=[15,30,50,100,200],ce=_(()=>e=>u.value.find(a=>a.id===e)),de=_(()=>u.value.filter(e=>e.status===1)),pe=_(()=>u.value.filter(e=>e.status===0)),ve=_(()=>u.value.filter(e=>e.status===2)),ge=_(()=>u.value.reduce((e,a)=>e+parseFloat(a.total_price||0),0)),fe=_(()=>{let e=0;return D.value&&e++,C.value&&e++,b.value&&e++,R.value&&e++,k.value&&e++,E.value&&e++,S.value&&e++,z.value&&e++,g.value&&g.value.length>0&&e++,f.value&&f.value.length>0&&e++,y.value&&y.value.length>0&&e++,j.value&&e++,e}),ye=_(()=>({status:D.value,product:C.value,zone:b.value,agent:R.value,rider:k.value,vendor:E.value,city:S.value,category:z.value,deliveryDateRange:g.value,statusDateRange:f.value,createdDateRange:y.value,search:j.value})),P=e=>{if(!e)return null;const a=new Date(e),s=a.getFullYear(),r=String(a.getMonth()+1).padStart(2,"0"),t=String(a.getDate()).padStart(2,"0");return`${s}-${r}-${t}`},ee=()=>{const e={};return D.value&&(e.status=D.value),C.value&&(e.product_id=C.value),b.value&&(e.zone_id=b.value),R.value&&(e.agent_id=R.value),k.value&&(e.rider_id=k.value),E.value&&(e.vendor_id=E.value),S.value&&(e.city_id=S.value),z.value&&(e.category_id=z.value),j.value&&(e.search=j.value),g.value&&g.value.length===2&&(e.delivery_from=P(g.value[0]),e.delivery_to=P(g.value[1])),f.value&&f.value.length===2&&(e.status_from=P(f.value[0]),e.status_to=P(f.value[1])),y.value&&y.value.length===2&&(e.created_from=P(y.value[0]),e.created_to=P(y.value[1])),e},N=async(e={})=>{var a,s;i.value.orders=!0,d.value=null;try{const r=new URLSearchParams,t={...$.value,...e};t.page&&r.append("page",t.page),t.per_page&&r.append("per_page",t.per_page),t.status&&r.append("status",t.status),t.vendor_id&&r.append("vendor_id",t.vendor_id),t.city_id&&r.append("city_id",t.city_id),t.agent_id&&r.append("agent_id",t.agent_id),t.rider_id&&r.append("rider_id",t.rider_id),t.zone_id&&r.append("zone_id",t.zone_id),t.product_id&&r.append("product_id",t.product_id),t.category_id&&r.append("category_id",t.category_id),t.search&&r.append("search",t.search),t.delivery_from&&r.append("delivery_from",t.delivery_from),t.delivery_to&&r.append("delivery_to",t.delivery_to),t.status_from&&r.append("status_from",t.status_from),t.status_to&&r.append("status_to",t.status_to),t.created_from&&r.append("created_from",t.created_from),t.created_to&&r.append("created_to",t.created_to);const v=(await o.get(`/api/v1/orders?${r.toString()}`,{headers:{Accept:"application/json","Content-Type":"application/json"}})).data;if(!v.success)throw new Error(v.message||"Failed to fetch orders");q.value=!1;const p=v.data;return u.value=p.data||[],h.value={current_page:p.current_page||1,last_page:p.last_page||1,per_page:p.per_page||15,total:p.total||0,from:p.from||0,to:p.to||0},p}catch(r){throw d.value=((s=(a=r.response)==null?void 0:a.data)==null?void 0:s.message)||r.message||"Failed to fetch orders",r}finally{i.value.orders=!1}},he=async()=>{const e=ee();$.value={...e,per_page:h.value.per_page},e.page=1,e.per_page=h.value.per_page,await N(e)},_e=async e=>{h.value.per_page=e;const a=ee();$.value={...a,per_page:e},await N({...a,page:1,per_page:e})},we=()=>{D.value=null,C.value=null,b.value=null,R.value=null,k.value=null,E.value=null,S.value=null,z.value=null,g.value=[],f.value=[],y.value=[],j.value="",$.value={}},T=l([]),me=async e=>{var a,s;if(!(!e||e.length===0))try{const r=await o.post("/api/v1/bulk-print-waybills",{order_ids:e},{headers:{Accept:"application/json","Content-Type":"application/json"},responseType:"blob"}),t=window.URL.createObjectURL(new Blob([r.data])),n=document.createElement("a");n.href=t,n.setAttribute("download","waybills.pdf"),document.body.appendChild(n),n.click(),n.remove(),c.success("Waybills printed successfully")}catch(r){throw c.error("Failed to print waybills"),d.value=((s=(a=r.response)==null?void 0:a.data)==null?void 0:s.message)||r.message||"Failed to print waybill",r}},ae=async e=>{i.value.orders=!0,d.value=null;try{const a=await te(e);return A.value=a,F.value=e,a}catch(a){throw d.value=a.message||"Failed to load order",a}finally{i.value.orders=!1}},Oe=async e=>{var a,s;i.value.creating=!0,d.value=null;try{const t=(await o.post("/api/v1/orders",e,{headers:{Accept:"application/json","Content-Type":"application/json"}})).data;if(!t.success)throw new Error(t.message||"Failed to create order");return u.value.unshift(t.data),h.value.total+=1,c.success("Order created successfully"),t.data}catch(r){throw c.error("Failed to create order"),d.value=((s=(a=r.response)==null?void 0:a.data)==null?void 0:s.message)||r.message||"Failed to create order",r}finally{i.value.creating=!1}},M=async(e,a)=>{var s,r;i.value.updating=!0,d.value=null;try{const n=(await o.put(`/api/v1/orders/${e}`,a,{headers:{Accept:"application/json","Content-Type":"application/json"}})).data;if(!n.success)throw new Error(n.message||"Failed to update order");const v=u.value.findIndex(p=>p.id===e);return v!==-1&&(u.value[v]=n.data),F.value===e&&(A.value=n.data),n.data}catch(t){throw c.error("Failed to update order"),d.value=((r=(s=t.response)==null?void 0:s.data)==null?void 0:r.message)||t.message||"Failed to update order",t}finally{i.value.updating=!1}},Fe=async e=>{var a,s;i.value.deleting=!0,d.value=null;try{const t=(await o.delete(`/api/v1/orders/${e}`,{headers:{Accept:"application/json"}})).data;if(!t.success)throw new Error(t.message||"Failed to delete order");const n=u.value.findIndex(v=>v.id===e);n!==-1&&(u.value.splice(n,1),h.value.total-=1),c.success("Order deleted successfully")}catch(r){throw c.error("Failed to delete order"),d.value=((s=(a=r.response)==null?void 0:a.data)==null?void 0:s.message)||r.message||"Failed to delete order",r}finally{i.value.deleting=!1}},te=async e=>{var a,s;try{const t=(await o.get(`/api/v1/orders/${e}`,{headers:{Accept:"application/json"}})).data;if(!t.success)throw new Error(t.message||"Failed to fetch order details");return t.data}catch(r){const t=((s=(a=r.response)==null?void 0:a.data)==null?void 0:s.message)||r.message||"Failed to fetch order details";throw new Error(t)}},Ae=async(e,a)=>M(e,{customer:a}),De=async(e,a)=>M(e,{order_items:a}),re=async(e=null)=>{if(i.value.options){console.log("Options already loading, skipping...");return}i.value.options=!0;try{console.log("Fetching dropdown options...");const a=[o.get("/api/v1/statuses").catch(()=>({data:{data:[]}})),o.get("/api/v1/categories").catch(()=>({data:{data:[]}})),o.get("/api/v1/cities").catch(()=>({data:{data:[]}})),o.get("/api/v1/zones").catch(()=>({data:{data:[]}})),o.get("/api/v1/agents").catch(()=>({data:{data:[]}})),o.get("/api/v1/riders").catch(()=>({data:{data:[]}})),o.get("/api/v1/vendors").catch(()=>({data:{data:[]}})),o.get("/api/v1/countries").catch(()=>({data:{data:[]}})),o.get("/api/v1/warehouses").catch(()=>({data:{data:[]}})),o.get("/api/v1/clients").catch(()=>({data:{data:[]}}))];e?a.push(o.get(`/api/v1/vendors/${e}/products`).catch(()=>({data:{success:!1,data:[]}}))):a.push(o.get("/api/v1/products").catch(()=>({data:{success:!1,data:[]}})));const s=x=>!x||!x.data?[]:Array.isArray(x.data)?x.data:Array.isArray(x.data.data)?x.data.data:[],[r,t,n,v,p,Be,qe,Ne,Le,Ue,Me]=await Promise.all(a);I.value=s(r),W.value=s(t),Y.value=s(n),Z.value=s(v),G.value=s(p),H.value=s(Be),J.value=s(qe),X.value=s(Ne),Q.value=s(Le),K.value=s(Ue),V.value=s(Me),console.log("Dropdown options loaded successfully")}catch(a){throw console.error("Failed to fetch dropdown options:",a),a}finally{i.value.options=!1}},Ce=async e=>{if(F.value=e,q.value=!1,B.value=!0,e){const a=await ae(e);return A.value=a,a}},be=()=>{B.value=!0,F.value=null,A.value=null,q.value=!0},Re=()=>{B.value=!1,F.value=null,A.value=null},ke=(e=[])=>{console.debug("openAssignDeliveryDialog called with:",e),T.value=e,w.value="assignDelivery",m.value="Assign Delivery Person",O.value=!0},Ee=(e=[])=>{T.value=e,w.value="assignCallCentre",m.value="Assign Call Centre Agent",O.value=!0},Se=(e=[])=>{T.value=e,w.value="status",m.value="Change Status",O.value=!0},ze=(e=[])=>{T.value=e,w.value="delete",m.value="Delete Orders",O.value=!0},se=()=>{O.value=!1,w.value="",m.value="",T.value=[],Object.keys(L).forEach(e=>{L[e]=""})},je=async e=>{i.value.updating=!0;try{const{type:a,data:s,orders:r}=e,t=Array.isArray(r)&&r.length>0?r:T.value;switch(a){case"assignDelivery":if(!s.deliveryPerson)throw new Error("No delivery person selected");await Pe(t,s.deliveryPerson);break;case"assignCallCentre":if(!s.callCentreAgent)throw new Error("No call centre agent selected");await Te(t,s.callCentreAgent);break;case"status":if(!s.status)throw new Error("No status selected");await xe(t,s.status);break;case"delete":await $e(t);break}se()}catch(a){console.error("Bulk action failed:",a)}finally{i.value.updating=!1}},Pe=async(e=[],a)=>{if(!e.length||!a)throw new Error("Orders and deliveryPersonId are required");try{await o.post("/api/v1/orders/assign-rider",{order_ids:e,rider_id:a}),c.success("Rider assigned successfully")}catch(s){throw c.error("Failed to assign rider"),s}},Te=async(e=[],a)=>{if(!e.length||!a)throw new Error("Orders and agentId are required");try{await o.post("/api/v1/orders/assign-agent",{order_ids:e,agent_id:a}),c.success("Call centre agent assigned successfully")}catch(s){throw c.error("Failed to assign call centre agent"),s}},xe=async(e=[],a)=>{if(!e.length||!a)throw new Error("Orders and status are required");try{await o.post("/api/v1/orders/update-status",{order_ids:e,status:a}),c.success("Order status updated successfully")}catch(s){throw c.error("Failed to update order status"),s}},$e=async(e=[])=>{if(!e.length)throw new Error("No orders selected for deletion");try{await o.post("/api/v1/orders/bulk-delete",{order_ids:e}),Array.isArray(u.value)&&e.forEach(a=>{const s=u.value.findIndex(r=>r.id===a);s!==-1&&(u.value.splice(s,1),h.value.total-=1)}),c.success("Orders deleted successfully")}catch(a){throw c.error("Failed to bulk delete orders"),a}};return{orders:u,loading:i,error:d,notifications:le,dialog:B,bulkActionDialog:O,selectedOrderId:F,selectedOrder:A,initialized:U,isCreateMode:q,orderFilterStatus:D,orderFilterProduct:C,orderFilterZone:b,orderFilterAgent:R,orderFilterRider:k,orderFilterVendor:E,orderFilterCity:S,orderFilterCategory:z,deliveryDateRange:g,statusDateRange:f,createdDateRange:y,orderSearch:j,lastAppliedFilters:$,orderStatusOptions:oe,productOptions:V,categoryOptions:W,cityOptions:Y,zoneOptions:Z,agentOptions:G,riderOptions:H,vendorOptions:J,clientOptions:K,warehouseOptions:Q,countryOptions:X,deliveryStatusOptions:ne,userOptions:ie,statusOptions:I,pagination:h,perPageOptions:ue,getOrderById:ce,confirmedOrders:de,pendingOrders:pe,cancelledOrders:ve,totalRevenue:ge,activeFilterCount:fe,currentFilters:ye,printOrders:me,fetchOrders:N,loadOrder:ae,createOrder:Oe,updateOrder:M,updateOrderCustomer:Ae,updateOrderItems:De,deleteOrder:Fe,getOrderDetails:te,fetchDropdownOptions:re,openDialog:Ce,openCreateDialog:be,openAssignDeliveryDialog:ke,openAssignCallCentreDialog:Ee,openBulkStatusDialog:Se,dialogType:w,dialogTitle:m,bulkActionForm:L,openDeleteDialog:ze,closeBulkActionDialog:se,handleBulkAction:je,closeDialog:Re,clearAllFilters:we,applyFilters:he,changePerPage:_e,initialize:async()=>{if(!U.value)try{await Promise.all([re(),N({page:1})]),U.value=!0}catch(e){console.error("Failed to initialize order store:",e)}}}});export{He as u};
