import{E as qe,r as s,P as Le,j as A,i as l}from"./app-B176KS28.js";import{n as u}from"./toast-BcmM4dZn.js";const We=qe("orders",()=>{const y=s(""),h=s(""),$=Le({deliveryPerson:"",callCentreAgent:"",status:"",notes:"",zone:"",city:""}),c=s([]),i=s({orders:!1,options:!1,creating:!1,updating:!1,deleting:!1}),v=s(null),re=s([]),x=s(!1),w=s(!1),F=s(null),D=s(null),N=s(!1),B=s(!1),b=s(null),C=s(null),k=s(null),m=s(null),R=s(null),j=s(null),E=s(null),S=s(null),p=s([null,null]),g=s([null,null]),f=s([null,null]),_=s(""),se=s([]),M=s([]),V=s([]),W=s([]),Y=s([]),Z=s([]),G=s([]),H=s([]),J=s([]),K=s([]),Q=s([]),oe=s([]),le=s([]),X=s([]),P=s({current_page:1,last_page:1,per_page:15,total:0,from:0,to:0}),ne=A(()=>e=>c.value.find(t=>t.id===e)),ie=A(()=>c.value.filter(e=>e.status===1)),ce=A(()=>c.value.filter(e=>e.status===0)),de=A(()=>c.value.filter(e=>e.status===2)),ue=A(()=>c.value.reduce((e,t)=>e+parseFloat(t.total_price||0),0)),ve=A(()=>{let e=0;return b.value&&e++,C.value&&e++,k.value&&e++,m.value&&e++,R.value&&e++,j.value&&e++,E.value&&e++,S.value&&e++,p.value&&p.value.length>0&&e++,g.value&&g.value.length>0&&e++,f.value&&f.value.length>0&&e++,_.value&&e++,e}),pe=A(()=>({status:b.value,product:C.value,zone:k.value,agent:m.value,rider:R.value,vendor:j.value,city:E.value,category:S.value,deliveryDateRange:p.value,statusDateRange:g.value,createdDateRange:f.value,search:_.value})),U=async(e={})=>{var t,r;i.value.orders=!0,v.value=null;try{const a=new URLSearchParams;e.page&&a.append("page",e.page),e.per_page&&a.append("per_page",e.per_page),e.status&&a.append("status",e.status),e.vendor_id&&a.append("vendor_id",e.vendor_id),e.city_id&&a.append("city_id",e.city_id),e.agent_id&&a.append("agent_id",e.agent_id),e.rider_id&&a.append("rider_id",e.rider_id),e.zone_id&&a.append("zone_id",e.zone_id),e.product_id&&a.append("product_id",e.product_id),e.category_id&&a.append("category_id",e.category_id),e.search&&a.append("search",e.search),e.delivery_from&&a.append("delivery_from",e.delivery_from),e.delivery_to&&a.append("delivery_to",e.delivery_to),e.status_from&&a.append("status_from",e.status_from),e.status_to&&a.append("status_to",e.status_to),e.created_from&&a.append("created_from",e.created_from),e.created_to&&a.append("created_to",e.created_to);const n=(await l.get(`/api/v1/orders?${a.toString()}`,{headers:{Accept:"application/json","Content-Type":"application/json"}})).data;if(!n.success)throw new Error(n.message||"Failed to fetch orders");B.value=!1;const d=n.data;return c.value=d.data||[],P.value={current_page:d.current_page||1,last_page:d.last_page||1,itemsPerPage:d.per_page||15,total:d.total||0,from:d.from||0,to:d.to||0},d}catch(a){throw v.value=((r=(t=a.response)==null?void 0:t.data)==null?void 0:r.message)||a.message||"Failed to fetch orders",a}finally{i.value.orders=!1}},O=s([]),ge=async e=>{var t,r;if(!(!e||e.length===0))try{const a=await l.post("/api/v1/bulk-print-waybills",{order_ids:e},{headers:{Accept:"application/json","Content-Type":"application/json"},responseType:"blob"}),o=window.URL.createObjectURL(new Blob([a.data])),n=document.createElement("a");n.href=o,n.setAttribute("download","waybills.pdf"),document.body.appendChild(n),n.click(),n.remove(),u.success("Waybills printed successfully")}catch(a){throw u.error("Failed to print waybills"),v.value=((r=(t=a.response)==null?void 0:t.data)==null?void 0:r.message)||a.message||"Failed to print waybill",a}},I=async e=>{i.value.orders=!0,v.value=null;try{const t=await ee(e);return D.value=t,F.value=e,t}catch(t){throw v.value=t.message||"Failed to load order",t}finally{i.value.orders=!1}},fe=async e=>{var t,r;i.value.creating=!0,v.value=null;try{const o=(await l.post("/api/v1/orders",e,{headers:{Accept:"application/json","Content-Type":"application/json"}})).data;if(!o.success)throw new Error(o.message||"Failed to create order");return c.value.unshift(o.data),P.value.total+=1,u.success("Order created successfully"),o.data}catch(a){throw u.error("Failed to create order"),v.value=((r=(t=a.response)==null?void 0:t.data)==null?void 0:r.message)||a.message||"Failed to create order",a}finally{i.value.creating=!1}},q=async(e,t)=>{var r,a;i.value.updating=!0,v.value=null;try{const n=(await l.put(`/api/v1/orders/${e}`,t,{headers:{Accept:"application/json","Content-Type":"application/json"}})).data;if(!n.success)throw new Error(n.message||"Failed to update order");const d=c.value.findIndex(L=>L.id===e);return d!==-1&&(c.value[d]=n.data),F.value===e&&(D.value=n.data),n.data}catch(o){throw u.error("Failed to update order"),v.value=((a=(r=o.response)==null?void 0:r.data)==null?void 0:a.message)||o.message||"Failed to update order",o}finally{i.value.updating=!1}},ye=async e=>{var t,r;i.value.deleting=!0,v.value=null;try{const o=(await l.delete(`/api/v1/orders/${e}`,{headers:{Accept:"application/json"}})).data;if(!o.success)throw new Error(o.message||"Failed to delete order");const n=c.value.findIndex(d=>d.id===e);n!==-1&&(c.value.splice(n,1),P.value.total-=1),u.success("Order deleted successfully")}catch(a){throw u.error("Failed to delete order"),v.value=((r=(t=a.response)==null?void 0:t.data)==null?void 0:r.message)||a.message||"Failed to delete order",a}finally{i.value.deleting=!1}},ee=async e=>{var t,r;try{const o=(await l.get(`/api/v1/orders/${e}`,{headers:{Accept:"application/json"}})).data;if(!o.success)throw new Error(o.message||"Failed to fetch order details");return o.data}catch(a){const o=((r=(t=a.response)==null?void 0:t.data)==null?void 0:r.message)||a.message||"Failed to fetch order details";throw new Error(o)}},he=async(e,t)=>q(e,{customer:t}),we=async(e,t)=>q(e,{order_items:t}),te=async(e=null)=>{if(i.value.options){console.log("Options already loading, skipping...");return}i.value.options=!0;try{console.log("Fetching dropdown options...");const t=[l.get("/api/v1/statuses").catch(()=>({data:{data:[]}})),l.get("/api/v1/categories").catch(()=>({data:{data:[]}})),l.get("/api/v1/cities").catch(()=>({data:{data:[]}})),l.get("/api/v1/zones").catch(()=>({data:{data:[]}})),l.get("/api/v1/agents").catch(()=>({data:{data:[]}})),l.get("/api/v1/riders").catch(()=>({data:{data:[]}})),l.get("/api/v1/vendors").catch(()=>({data:{data:[]}})),l.get("/api/v1/countries").catch(()=>({data:{data:[]}})),l.get("/api/v1/warehouses").catch(()=>({data:{data:[]}})),l.get("/api/v1/clients").catch(()=>({data:{data:[]}}))];e?t.push(l.get(`/api/v1/vendors/${e}/products`).catch(()=>({data:{success:!1,data:[]}}))):t.push(l.get("/api/v1/products").catch(()=>({data:{success:!1,data:[]}})));const r=z=>!z||!z.data?[]:Array.isArray(z.data)?z.data:Array.isArray(z.data.data)?z.data.data:[],[a,o,n,d,L,Pe,xe,Be,$e,Ne,Ue]=await Promise.all(t);X.value=r(a),V.value=r(o),W.value=r(n),Y.value=r(d),Z.value=r(L),G.value=r(Pe),H.value=r(xe),Q.value=r(Be),K.value=r($e),J.value=r(Ne),M.value=r(Ue),console.log("Dropdown options loaded successfully")}catch(t){throw console.error("Failed to fetch dropdown options:",t),t}finally{i.value.options=!1}},_e=async e=>{if(F.value=e,B.value=!1,x.value=!0,e){const t=await I(e);return D.value=t,t}},Oe=()=>{x.value=!0,F.value=null,D.value=null,B.value=!0},Ae=()=>{x.value=!1,F.value=null,D.value=null},Fe=()=>{b.value=null,C.value=null,k.value=null,m.value=null,R.value=null,j.value=null,E.value=null,S.value=null,p.value=[],g.value=[],f.value=[],_.value=""},De=async()=>{const e={};b.value&&(e.status=b.value),C.value&&(e.product_id=C.value),k.value&&(e.zone_id=k.value),m.value&&(e.agent_id=m.value),R.value&&(e.rider_id=R.value),j.value&&(e.vendor_id=j.value),E.value&&(e.city_id=E.value),S.value&&(e.category_id=S.value),_.value&&(e.search=_.value),p.value&&p.value.length===2&&(e.delivery_from=T(p.value[0]),e.delivery_to=T(p.value[1])),g.value&&g.value.length===2&&(e.status_from=T(g.value[0]),e.status_to=T(g.value[1])),f.value&&f.value.length===2&&(e.created_from=T(f.value[0]),e.created_to=T(f.value[1])),e.page=1,await U(e)},T=e=>{if(!e)return null;const t=new Date(e),r=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${r}-${a}-${o}`},be=async()=>{if(!N.value)try{await Promise.all([te(),U({page:1})]),N.value=!0}catch(e){console.error("Failed to initialize order store:",e)}},Ce=(e=[])=>{console.debug("openAssignDeliveryDialog called with:",e),O.value=e,y.value="assignDelivery",h.value="Assign Delivery Person",w.value=!0,console.debug("Bulk action dialog opened. State:",{selectedOrders:O.value,dialogType:y.value,dialogTitle:h.value,bulkActionDialog:w.value})},ke=(e=[])=>{O.value=e,y.value="assignCallCentre",h.value="Assign Call Centre Agent",w.value=!0},me=(e=[])=>{O.value=e,y.value="status",h.value="Change Status",w.value=!0},Re=(e=[])=>{O.value=e,y.value="delete",h.value="Delete Orders",w.value=!0},ae=()=>{w.value=!1,y.value="",h.value="",O.value=[],Object.keys($).forEach(e=>{$[e]=""})},je=async e=>{i.value.updating=!0;try{const{type:t,data:r,orders:a}=e,o=Array.isArray(a)&&a.length>0?a:O.value;switch(console.debug("handleBulkAction called with:",{type:t,data:r,orders:o}),t){case"assignDelivery":if(!r.deliveryPerson)throw console.error("No delivery person selected"),new Error("No delivery person selected");console.debug("Assigning delivery person:",r.deliveryPerson,"to orders:",o),await Ee(o,r.deliveryPerson);break;case"assignCallCentre":if(!r.callCentreAgent)throw console.error("No call centre agent selected"),new Error("No call centre agent selected");console.debug("Assigning call centre agent:",r.callCentreAgent,"to orders:",o),await Se(o,r.callCentreAgent);break;case"status":if(!r.status)throw console.error("No status selected"),new Error("No status selected");console.debug("Updating status for orders:",o,"with status:",r.status),await Te(o,r.status);break;case"delete":console.debug("Deleting orders:",o),await ze(o);break;default:console.warn("Unknown bulk action type:",t)}ae()}catch(t){console.error("Bulk action failed:",t)}finally{i.value.updating=!1}},Ee=async(e=[],t)=>{if(!e.length||!t)throw new Error("Orders and deliveryPersonId are required");try{await l.post("/api/v1/orders/assign-rider",{order_ids:e,rider_id:t},{headers:{Accept:"application/json","Content-Type":"application/json"}}),console.log("Assigned delivery person:",t,"to orders:",e),u.success("Rider assigned successfully")}catch(r){throw u.error("Failed to assign rider"),console.error("Failed to assign rider:",r),r}},Se=async(e=[],t)=>{if(!e.length||!t)throw new Error("Orders and agentId are required");try{await l.post("/api/v1/orders/assign-agent",{order_ids:e,agent_id:t},{headers:{Accept:"application/json","Content-Type":"application/json"}}),console.log("Assigned call centre agent:",t,"to orders:",e),u.success("Call centre agent assigned successfully")}catch(r){throw u.error("Failed to assign call centre agent"),console.error("Failed to assign agent:",r),r}},Te=async(e=[],t)=>{if(!e.length||!t)throw new Error("Orders and status are required");try{await l.post("/api/v1/orders/update-status",{order_ids:e,status:t},{headers:{Accept:"application/json","Content-Type":"application/json"}}),console.log("Updated status for orders:",e,"to status:",t),u.success("Order status updated successfully")}catch(r){throw u.error("Failed to update order status"),console.error("Failed to update status:",r),r}},ze=async(e=[])=>{if(!e.length)throw new Error("No orders selected for deletion");try{await l.post("/api/v1/orders/bulk-delete",{order_ids:e},{headers:{Accept:"application/json","Content-Type":"application/json"}}),Array.isArray(c.value)&&e.forEach(t=>{const r=c.value.findIndex(a=>a.id===t);r!==-1&&(c.value.splice(r,1),P.value.total-=1)}),console.log("Deleted orders:",e),u.success("Orders deleted successfully")}catch(t){throw u.error("Failed to bulk delete orders"),console.error("Failed to bulk delete orders:",t),t}};return{orders:c,loading:i,error:v,notifications:re,dialog:x,bulkActionDialog:w,selectedOrderId:F,selectedOrder:D,initialized:N,isCreateMode:B,orderFilterStatus:b,orderFilterProduct:C,orderFilterZone:k,orderFilterAgent:m,orderFilterRider:R,orderFilterVendor:j,orderFilterCity:E,orderFilterCategory:S,deliveryDateRange:p,statusDateRange:g,createdDateRange:f,orderSearch:_,deliveryDateRange:p,statusDateRange:g,createdDateRange:f,orderSearch:_,orderStatusOptions:se,productOptions:M,categoryOptions:V,cityOptions:W,zoneOptions:Y,agentOptions:Z,riderOptions:G,vendorOptions:H,clientOptions:J,warehouseOptions:K,countryOptions:Q,deliveryStatusOptions:oe,userOptions:le,statusOptions:X,pagination:P,getOrderById:ne,confirmedOrders:ie,pendingOrders:ce,cancelledOrders:de,totalRevenue:ue,activeFilterCount:ve,currentFilters:pe,printOrders:ge,fetchOrders:U,loadOrder:I,createOrder:fe,updateOrder:q,updateOrderCustomer:he,updateOrderItems:we,deleteOrder:ye,getOrderDetails:ee,fetchDropdownOptions:te,openDialog:_e,openCreateDialog:Oe,openAssignDeliveryDialog:Ce,openAssignCallCentreDialog:ke,openBulkStatusDialog:me,dialogType:y,dialogTitle:h,bulkActionForm:$,openDeleteDialog:Re,closeBulkActionDialog:ae,handleBulkAction:je,closeDialog:Ae,clearAllFilters:Fe,applyFilters:De,initialize:be}});export{We as u};
