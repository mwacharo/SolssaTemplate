import{E as De,r as y,j as U,Q as Ue,k as Te,s as ke,z as Ce,l as g,c as O,o as f,w as o,b as s,a as c,f as p,t as x,u,d as C,e as b,F as xe,g as be,n as Se,H as $e,y as Me,R as ge,m as Pe,X as Le}from"./app-CjQEmdpZ.js";import{u as Oe}from"./whatsappStore-lOFSPrR8.js";import{u as Ve}from"./WhatsAppConversation.vue_vue_type_style_index_0_scoped_ad86ab47_lang-BYEqOYhQ.js";import{_ as Fe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Re=De("conversation",()=>{const $=y(!1),r=y([]),L=y(!1),D=y(""),v=y({image:null,audio:null}),S=y(!1),M=y(!1),T=y(""),P=y(!1),_=y({}),h=y(null),w=y(!1),I=y("online"),G=["😊","😂","❤️","👍","👏","🎉","🔥","💯","😍","😘","🤔","😎","👌","🙏","💪","✨","🎈","🌟","⭐","💫","🌸","🌺","🎊","🎁"],H=U(()=>v.value.image&&v.value.image.length||v.value.audio&&v.value.audio.length),K=U(()=>(D.value.trim()||H.value)&&!P.value&&I.value==="online"),V=U(()=>{if(r.value&&r.value.length>0){const t=r.value.find(a=>a.sender_name);return(t==null?void 0:t.sender_name)||"Contact"}return"Contact"}),J=U(()=>{var t;if(r.value&&r.value.length>0){const a=(t=r.value[0].from)==null?void 0:t.match(/(\d+)/);return a?`+${a[1]}`:""}return""}),F=U(()=>r.value.filter(t=>t.direction==="incoming"&&t.message_status!=="read").length),R=U(()=>r.value[r.value.length-1]||null),Y=async t=>{console.log("=== openDialog called ==="),console.log("contactId:",t),h.value=t,$.value=!0,console.log("Dialog set to true:",$.value);try{await Q(t)}catch(a){console.error("Error loading conversation:",a)}$.value||(console.log("Dialog was somehow set to false, correcting..."),$.value=!0),console.log("openDialog completed, final dialog state:",$.value)},Z=()=>{$.value=!1,z(),h.value=null},Q=async t=>{if(t){L.value=!0;try{const a=await fetch(`/api/v1/conversation/${t}`);if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const i=await a.json();r.value=i.data||i.messages||[],r.value.sort((d,k)=>new Date(d.created_at||d.timestamp)-new Date(k.created_at||k.timestamp))}catch(a){console.error("Failed to load conversation:",a),r.value=[],e("Failed to load conversation")}finally{L.value=!1}}},q=async()=>{if(!K.value)return;const t=D.value.trim(),a=`temp_${Date.now()}_${Math.random()}`,i={id:a,content:t,direction:"outgoing",from:"system",message_status:"sending",created_at:new Date().toISOString(),image_url:v.value.image?URL.createObjectURL(v.value.image[0]):null,audio_url:v.value.audio?URL.createObjectURL(v.value.audio[0]):null};r.value.push(i);const d=t,k={...v.value};z(),P.value=!0;try{const W={content:d,contact_id:h.value,temp_id:a},A=await N(W,k),E=r.value.findIndex(ve=>ve.id===a);E!==-1&&(r.value[E]={...r.value[E],id:A.id,message_status:"sent",created_at:A.created_at||A.timestamp})}catch(W){console.error("Failed to send message:",W);const A=r.value.findIndex(E=>E.id===a);A!==-1&&(r.value[A].message_status="failed"),e("Failed to send message. Please try again.")}finally{P.value=!1}},N=async(t,a)=>{const i=new FormData;i.append("content",t.content),i.append("contact_id",t.contact_id),i.append("temp_id",t.temp_id),a.image&&a.image.length&&i.append("image",a.image[0]),a.audio&&a.audio.length&&i.append("audio",a.audio[0]);const d=await fetch("/api/v1/messages",{method:"POST",headers:{Authorization:`Bearer ${n()}`},body:i});if(!d.ok)throw new Error(`HTTP error! status: ${d.status}`);return d.json()},ee=async t=>{const a=r.value.find(i=>i.id===t);if(!(!a||a.message_status!=="failed")){a.message_status="sending";try{await axios.post(`/api/v1/whatsapp/retry-message/${t}`),a.message_status="sent"}catch(i){console.error("Failed to retry message:",i),a.message_status="failed"}}},te=async t=>{try{const a=await fetch(`/api/v1/messages/${t}`,{method:"DELETE",headers:{Authorization:`Bearer ${n()}`}});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const i=r.value.findIndex(d=>d.id===t);i!==-1&&r.value.splice(i,1)}catch(a){console.error("Failed to delete message:",a),e("Failed to delete message")}},ae=t=>{r.value.find(i=>i.id===t.id)||(r.value.push(t),r.value.sort((i,d)=>new Date(i.created_at||i.timestamp)-new Date(d.created_at||d.timestamp)))},ne=(t,a)=>{const i=r.value.find(d=>d.id===t);i&&(i.message_status=a)},oe=t=>{w.value=t},se=t=>{I.value=t},z=()=>{D.value="",v.value.image=null,v.value.audio=null,S.value=!1},le=t=>{D.value+=t,S.value=!1},ie=t=>{t&&t.type.startsWith("image/")&&(v.value.image=[t])},B=t=>{t&&t.type.startsWith("audio/")&&(v.value.audio=[t])},re=t=>{T.value=t,M.value=!0},X=()=>{M.value=!1,T.value=""},ue=(t,a)=>{a&&(_.value[t]||(_.value[t]={playing:!1}),Object.keys(_.value).forEach(i=>{i!==t&&_.value[i].playing&&(_.value[i].playing=!1)}),_.value[t].playing?(a.pause(),_.value[t].playing=!1):(a.play(),_.value[t].playing=!0))},de=t=>{_.value[t]&&(_.value[t].playing=!1)},ce=t=>t.trim()?r.value.filter(a=>a.content.toLowerCase().includes(t.toLowerCase())):r.value,me=()=>{const t={contact:{name:V.value,phone:J.value},messages:r.value.map(k=>({id:k.id,content:k.content,direction:k.direction,timestamp:k.created_at||k.timestamp,status:k.message_status})),exportedAt:new Date().toISOString()},a=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),i=URL.createObjectURL(a),d=document.createElement("a");d.href=i,d.download=`conversation_${V.value}_${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(i)},n=()=>localStorage.getItem("auth_token")||sessionStorage.getItem("auth_token"),e=t=>{console.error(t)};return{dialog:$,conversation:r,loading:L,replyMessage:D,attachment:v,showEmojiPicker:S,imagePreviewDialog:M,previewImageUrl:T,sending:P,audioStates:_,selectedContactId:h,typingIndicator:w,connectionStatus:I,commonEmojis:G,hasAttachment:H,canSendMessage:K,contactName:V,contactPhone:J,unreadCount:F,lastMessage:R,openDialog:Y,closeDialog:Z,loadConversation:Q,sendMessage:q,retryFailedMessage:ee,deleteMessage:te,addIncomingMessage:ae,updateMessageStatus:ne,setTypingIndicator:oe,setConnectionStatus:se,clearForm:z,appendEmoji:le,handleImageUpload:ie,handleAudioUpload:B,openImagePreview:re,closeImagePreview:X,toggleAudio:ue,onAudioEnded:de,searchMessages:ce,exportConversation:me,resetStore:()=>{$.value=!1,r.value=[],L.value=!1,D.value="",v.value={image:null,audio:null},S.value=!1,M.value=!1,T.value="",P.value=!1,_.value={},h.value=null,w.value=!1,I.value="online"}}}),Ne={class:"d-flex align-center w-100"},ze={class:"flex-grow-1"},Be={class:"text-h6 mb-0"},We={class:"text-caption text-grey"},He={key:0,class:"pa-4"},Ke={key:0,class:"message-sender text-caption font-weight-medium mb-1"},Je={class:"message-content"},Qe={key:1,class:"message-media mt-2"},Xe={key:2,class:"message-media mt-2"},Ge={class:"audio-container"},Ye=["src","onEnded"],Ze={class:"message-meta d-flex align-center justify-end mt-1"},qe={class:"text-caption text-grey mr-2"},et={key:0,class:"typing-indicator mb-3"},tt={key:1,class:"empty-state pa-8 text-center"},at={key:0,class:"attachment-preview mb-3"},nt={class:"message-input-container"},ot={class:"input-actions d-flex align-center mt-2"},st={class:"d-flex align-center flex-grow-1"},lt={key:0,class:"text-caption text-grey ml-2"},it={key:0,class:"emoji-picker mt-3 pa-3"},rt={class:"emoji-grid"},ut={__name:"WhatsAppConversation",setup($){const r=Ve(),L=U(()=>{var n;return(n=r.user)==null?void 0:n.id}),D=Oe(),v=Re(),{dialog:S,conversation:M,contactName:T,contactPhone:P,connectionStatus:_,replyMessage:h,attachment:w,imagePreviewDialog:I,previewImageUrl:G,typingIndicator:H,audioStates:K,sending:V}=Ue(v),J=y(null),F=y(null),R=y(!1),Y=["😀","😂","😍","😭","😡","👍","🙏","🔥","🎉","💯"],Z=()=>{switch(_.value){case"online":return"Online";case"offline":return"Offline";case"connecting":return"Connecting...";default:return"Unknown"}},Q=()=>{switch(_.value){case"online":return"success";case"offline":return"grey";case"connecting":return"warning";default:return"grey"}},q=n=>n.direction==="incoming"||n.from!=="system",N=n=>n.direction==="outgoing"||n.from==="system",ee=n=>N(n)?"outgoing":"incoming",te=n=>N(n)?"outgoing":"incoming",ae=n=>{switch(n){case"sent":return"mdi-check";case"delivered":return"mdi-check-all";case"read":return"mdi-check-all";case"failed":return"mdi-alert-circle";case"sending":return"mdi-clock-outline";default:return"mdi-clock-outline"}},ne=n=>{switch(n){case"read":return"blue";case"delivered":return"grey";case"sent":return"grey";case"failed":return"red";case"sending":return"orange";default:return"grey"}},oe=n=>{if(!n)return"-";const e=new Date(n),t=(new Date-e)/(1e3*60*60);return t<24?e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):t<168?e.toLocaleDateString([],{weekday:"short",hour:"2-digit",minute:"2-digit"}):e.toLocaleDateString([],{month:"short",day:"numeric"})},se=()=>{h.value+=`
`},z=n=>{const e=n.target.files[0];e&&v.handleImageUpload(e)},le=n=>{const e=n.target.files[0];e&&v.handleAudioUpload(e)},ie=(n,e)=>{let m=e[`audio-${n}`];Array.isArray(m)&&(m=m[0]),m?v.toggleAudio(n,m):console.warn(`Audio element not found for messageId: ${n}`)},B=()=>{Ce(()=>{F.value&&(F.value.scrollTop=F.value.scrollHeight)})},re=()=>{S.value=!1},X=()=>D.sendMessage(L.value),ue=n=>{h.value+=n},de=()=>{I.value=!1},ce=n=>{v.retryFailedMessage(n)},me=U(()=>{var n,e;return h.value.trim().length>0||((n=w.value)==null?void 0:n.image)||((e=w.value)==null?void 0:e.audio)});return Te(()=>{B()}),ke(M,()=>{B()},{deep:!0}),ke(S,n=>{n&&Ce(()=>B())}),(n,e)=>{const m=g("v-icon"),t=g("v-avatar"),a=g("v-chip"),i=g("v-btn"),d=g("v-card-title"),k=g("v-divider"),W=g("v-progress-linear"),A=g("v-img"),E=g("v-card-text"),ve=g("v-textarea"),pe=g("v-list-item-icon"),fe=g("v-list-item-title"),_e=g("v-list-item-content"),ye=g("v-list-item"),Ie=g("v-list"),Ae=g("v-menu"),Ee=g("v-expand-transition"),he=g("v-card"),je=g("v-spacer"),we=g("v-dialog");return f(),O(we,{modelValue:u(S),"onUpdate:modelValue":e[7]||(e[7]=l=>ge(S)?S.value=l:null),"max-width":"800",persistent:""},{default:o(()=>[s(he,{class:"conversation-dialog"},{default:o(()=>[s(d,{class:"conversation-header pa-4"},{default:o(()=>[c("div",Ne,[s(t,{color:"primary",size:"40",class:"mr-3"},{default:o(()=>[s(m,{color:"white"},{default:o(()=>e[8]||(e[8]=[p("mdi-account")])),_:1,__:[8]})]),_:1}),c("div",ze,[c("div",Be,x(u(T)),1),c("div",We,x(u(P)),1)]),s(a,{color:Q(),small:"",outlined:"",class:"mr-2"},{default:o(()=>[p(x(Z()),1)]),_:1},8,["color"]),s(i,{icon:"",onClick:re},{default:o(()=>[s(m,null,{default:o(()=>e[9]||(e[9]=[p("mdi-close")])),_:1,__:[9]})]),_:1})])]),_:1}),s(k),s(E,{class:"pa-0"},{default:o(()=>[n.loading?(f(),O(W,{key:0,indeterminate:"",color:"primary"})):(f(),C("div",{key:1,class:"messages-container",ref_key:"messagesContainer",ref:J},[Array.isArray(u(M))&&u(M).length?(f(),C("div",He,[(f(!0),C(xe,null,be(u(M),l=>(f(),C("div",{key:l.id,class:Se(["message-wrapper mb-3",ee(l)])},[c("div",{class:Se(["message-bubble elevation-1",te(l)])},[q(l)?(f(),C("div",Ke,x(l.sender_name||u(T)),1)):b("",!0),c("div",Je,x(l.content),1),l.image_url?(f(),C("div",Qe,[s(A,{src:l.image_url,"max-height":"200","max-width":"300",contain:"",class:"rounded",onClick:j=>n.openImagePreview(l.image_url),style:{cursor:"pointer"}},null,8,["src","onClick"])])):b("",!0),l.audio_url?(f(),C("div",Xe,[c("div",Ge,[s(i,{icon:"",small:"",onClick:j=>ie(l.id,n.$refs),class:"mr-2"},{default:o(()=>[s(m,null,{default:o(()=>{var j;return[p(x((j=u(K)[l.id])!=null&&j.playing?"mdi-pause":"mdi-play"),1)]}),_:2},1024)]),_:2},1032,["onClick"]),c("audio",{ref_for:!0,ref:`audio-${l.id}`,src:l.audio_url,onEnded:j=>n.onAudioEnded(l.id),style:{display:"none"}},null,40,Ye),e[10]||(e[10]=c("span",{class:"text-caption"},"Voice message",-1))])])):b("",!0),c("div",Ze,[c("span",qe,x(oe(l.created_at||l.timestamp)),1),N(l)?(f(),O(m,{key:0,color:ne(l.message_status),size:"14"},{default:o(()=>[p(x(ae(l.message_status)),1)]),_:2},1032,["color"])):b("",!0),l.message_status==="failed"?(f(),O(i,{key:1,icon:"","x-small":"",onClick:j=>ce(l.id),class:"ml-1"},{default:o(()=>[s(m,{size:"12"},{default:o(()=>e[11]||(e[11]=[p("mdi-refresh")])),_:1,__:[11]})]),_:2},1032,["onClick"])):b("",!0)])],2)],2))),128)),u(H)?(f(),C("div",et,e[12]||(e[12]=[c("div",{class:"message-bubble incoming"},[c("div",{class:"typing-dots"},[c("span"),c("span"),c("span")])],-1)]))):b("",!0)])):(f(),C("div",tt,[s(m,{size:"64",color:"grey lighten-2"},{default:o(()=>e[13]||(e[13]=[p("mdi-message-outline")])),_:1,__:[13]}),e[14]||(e[14]=c("div",{class:"text-h6 mt-4 text-grey"},"No messages yet",-1)),e[15]||(e[15]=c("div",{class:"text-caption text-grey"},"Start the conversation below",-1))]))],512))]),_:1}),s(k),s(E,{class:"reply-section pa-4"},{default:o(()=>[n.hasAttachment?(f(),C("div",at,[u(w).image&&u(w).image.length?(f(),O(a,{key:0,close:"","onClick:close":e[0]||(e[0]=l=>u(w).image=null),color:"blue lighten-4",class:"mr-2"},{default:o(()=>{var l;return[s(m,{left:"",small:""},{default:o(()=>e[16]||(e[16]=[p("mdi-image")])),_:1,__:[16]}),p(" "+x((l=u(w).image[0])==null?void 0:l.name),1)]}),_:1})):b("",!0),u(w).audio&&u(w).audio.length?(f(),O(a,{key:1,close:"","onClick:close":e[1]||(e[1]=l=>u(w).audio=null),color:"green lighten-4"},{default:o(()=>{var l;return[s(m,{left:"",small:""},{default:o(()=>e[17]||(e[17]=[p("mdi-microphone")])),_:1,__:[17]}),p(" "+x((l=u(w).audio[0])==null?void 0:l.name),1)]}),_:1})):b("",!0)])):b("",!0),c("div",nt,[s(ve,{modelValue:u(h),"onUpdate:modelValue":e[2]||(e[2]=l=>ge(h)?h.value=l:null),label:"Type your message...",rows:"2","auto-grow":"",outlined:"",dense:"","hide-details":"",class:"message-input",disabled:u(_)!=="online",onKeydown:[$e(Me(X,["exact","prevent"]),["enter"]),$e(Me(se,["shift","exact"]),["enter"])]},null,8,["modelValue","disabled","onKeydown"]),c("div",ot,[c("div",st,[s(i,{icon:"",small:"",onClick:e[3]||(e[3]=l=>R.value=!R.value),class:"mr-2",disabled:u(_)!=="online"},{default:o(()=>[s(m,null,{default:o(()=>e[18]||(e[18]=[p("mdi-emoticon-happy-outline")])),_:1,__:[18]})]),_:1},8,["disabled"]),s(Ae,{"offset-y":""},{activator:o(({on:l,attrs:j})=>[s(i,Pe({icon:"",small:""},j,Le(l),{class:"mr-2",disabled:u(_)!=="online"}),{default:o(()=>[s(m,null,{default:o(()=>e[19]||(e[19]=[p("mdi-attachment")])),_:1,__:[19]})]),_:2},1040,["disabled"])]),default:o(()=>[s(Ie,{dense:""},{default:o(()=>[s(ye,{onClick:e[4]||(e[4]=l=>n.$refs.imageInput.click())},{default:o(()=>[s(pe,null,{default:o(()=>[s(m,null,{default:o(()=>e[20]||(e[20]=[p("mdi-image")])),_:1,__:[20]})]),_:1}),s(_e,null,{default:o(()=>[s(fe,null,{default:o(()=>e[21]||(e[21]=[p("Image")])),_:1,__:[21]})]),_:1})]),_:1}),s(ye,{onClick:e[5]||(e[5]=l=>n.$refs.audioInput.click())},{default:o(()=>[s(pe,null,{default:o(()=>[s(m,null,{default:o(()=>e[22]||(e[22]=[p("mdi-microphone")])),_:1,__:[22]})]),_:1}),s(_e,null,{default:o(()=>[s(fe,null,{default:o(()=>e[23]||(e[23]=[p("Voice Note")])),_:1,__:[23]})]),_:1})]),_:1})]),_:1})]),_:1}),c("input",{ref:"imageInput",type:"file",accept:"image/*",onChange:z,style:{display:"none"}},null,544),c("input",{ref:"audioInput",type:"file",accept:"audio/*",onChange:le,style:{display:"none"}},null,544),u(h).length>0?(f(),C("span",lt,x(u(h).length),1)):b("",!0)]),s(i,{color:"primary",disabled:!me.value,onClick:X,class:"ml-2",loading:u(V)},{default:o(()=>[s(m,null,{default:o(()=>e[24]||(e[24]=[p("mdi-send")])),_:1,__:[24]})]),_:1},8,["disabled","loading"])]),s(Ee,null,{default:o(()=>[R.value?(f(),C("div",it,[c("div",rt,[(f(),C(xe,null,be(Y,l=>s(i,{key:l,text:"","x-small":"",onClick:j=>ue(l),class:"emoji-btn"},{default:o(()=>[p(x(l),1)]),_:2},1032,["onClick"])),64))])])):b("",!0)]),_:1})])]),_:1})]),_:1}),s(we,{modelValue:u(I),"onUpdate:modelValue":e[6]||(e[6]=l=>ge(I)?I.value=l:null),"max-width":"90vw"},{default:o(()=>[s(he,null,{default:o(()=>[s(d,{class:"pa-2"},{default:o(()=>[s(je),s(i,{icon:"",onClick:de},{default:o(()=>[s(m,null,{default:o(()=>e[25]||(e[25]=[p("mdi-close")])),_:1,__:[25]})]),_:1})]),_:1}),s(E,{class:"pa-2"},{default:o(()=>[s(A,{src:u(G),contain:"","max-height":"80vh"},null,8,["src"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])}}},dt=Fe(ut,[["__scopeId","data-v-ad86ab47"]]),pt=Object.freeze(Object.defineProperty({__proto__:null,default:dt},Symbol.toStringTag,{value:"Module"}));export{dt as W,pt as a,Re as u};
