import{E as De,r as w,j as D,R as Ve,k as Ie,s as pe,z as ke,l as p,c as z,o as y,w as l,b as s,a as m,f,t as x,u as r,d as C,e as b,F as Ce,g as xe,n as be,H as Se,y as $e,m as Pe,Y as Le,U as Te}from"./app-CAy57pox.js";import{n as Me}from"./toast-D74Ymlbb.js";import{u as Fe}from"./whatsappStore-6nWBSeyU.js";import{u as Oe}from"./auth-DJQ0lkbe.js";/* empty css                                                                             */import{_ as Re}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ne=De("conversation",()=>{const S=w(!1),u=w([]),R=w(!1),g=w(""),v=w({image:null,audio:null}),$=w(!1),M=w(!1),V=w(""),I=w(!1),h=w({}),T=w(null),_=w(null);w(null);const A=w(!1),N=w("online"),q=["ðŸ˜Š","ðŸ˜‚","â¤ï¸","ðŸ‘","ðŸ‘","ðŸŽ‰","ðŸ”¥","ðŸ’¯","ðŸ˜","ðŸ˜˜","ðŸ¤”","ðŸ˜Ž","ðŸ‘Œ","ðŸ™","ðŸ’ª","âœ¨","ðŸŽˆ","ðŸŒŸ","â­","ðŸ’«","ðŸŒ¸","ðŸŒº","ðŸŽŠ","ðŸŽ"],J=D(()=>v.value.image&&v.value.image.length||v.value.audio&&v.value.audio.length),Y=D(()=>(g.value.trim()||J.value)&&!I.value&&N.value==="online"),P=D(()=>{var e;if((e=_.value)!=null&&e.name)return _.value.name;if(u.value&&u.value.length>0){const a=u.value.find(i=>i.sender_name);return(a==null?void 0:a.sender_name)||"Unknown Contact"}return"Unknown Contact"}),L=D(()=>{var e,a;if((e=_.value)!=null&&e.phone)return _.value.phone;if(u.value&&u.value.length>0){const i=(a=u.value[0].from)==null?void 0:a.match(/(\d+)/);return i?i[1]:""}return""}),B=D(()=>u.value.filter(e=>e.direction==="incoming"&&e.message_status!=="read").length),ee=D(()=>u.value[u.value.length-1]||null),te=async e=>{console.log("=== openDialog called ==="),console.log("contactId:",e);let a,i;if(typeof e=="object"&&e!==null)a={id:e.id,name:e.name,phone:e.phone||e.whatsapp},i=e.whatsapp?`${e.whatsapp}@c.us`:`${e.phone}@c.us`;else{i=e;const d=e.replace("@c.us","");a={id:d,name:P.value||"Unknown",phone:d}}_.value=a,P.value=a.name||"Unknown",L.value=a.phone||"",S.value=!0,console.log("Dialog set to true:",S.value),console.log("Calling loadConversation with:",i);try{await G(i)}catch(d){console.error("Error loading conversation:",d)}S.value||(console.log("Dialog was somehow set to false, correcting..."),S.value=!0),console.log("openDialog completed, final dialog state:",S.value)},ae=()=>{S.value=!1,H(),T.value=null,_.value=null},G=async e=>{if(e){R.value=!0;try{const a=await fetch(`/api/v1/conversation/${e}`);if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const i=await a.json();u.value=i.data||i.messages||[],u.value.sort((d,k)=>new Date(d.created_at||d.timestamp)-new Date(k.created_at||k.timestamp))}catch(a){console.error("Failed to load conversation:",a),u.value=[],j("Failed to load conversation")}finally{R.value=!1}}},W=async()=>{if(!Y.value)return;const e=g.value.trim(),a=`temp_${Date.now()}_${Math.random()}`,i={id:a,content:e,direction:"outgoing",from:"system",message_status:"sending",created_at:new Date().toISOString(),image_url:v.value.image?URL.createObjectURL(v.value.image[0]):null,audio_url:v.value.audio?URL.createObjectURL(v.value.audio[0]):null};u.value.push(i);const d=e,k={...v.value};H(),I.value=!0;try{const F={content:d,contact_id:T.value,temp_id:a},E=await ne(F,k),O=u.value.findIndex(Z=>Z.id===a);O!==-1&&(u.value[O]={...u.value[O],id:E.id,message_status:"sent",created_at:E.created_at||E.timestamp}),Me.success("Message sent successfully!"),S.value=!1}catch(F){console.error("Failed to send message:",F);const E=u.value.findIndex(O=>O.id===a);E!==-1&&(u.value[E].message_status="failed"),Me.error("Failed to send message."),j("Failed to send message. Please try again.")}finally{I.value=!1}},ne=async(e,a)=>{const i=new FormData;i.append("content",e.content),i.append("contact_id",e.contact_id),i.append("temp_id",e.temp_id),a.image&&a.image.length&&i.append("image",a.image[0]),a.audio&&a.audio.length&&i.append("audio",a.audio[0]);const d=await fetch("/api/v1/messages",{method:"POST",headers:{Authorization:`Bearer ${c()}`},body:i});if(!d.ok)throw new Error(`HTTP error! status: ${d.status}`);return d.json()},se=async e=>{const a=u.value.find(i=>i.id===e);if(!(!a||a.message_status!=="failed")){a.message_status="sending";try{await axios.post(`/api/v1/whatsapp/retry-message/${e}`),a.message_status="sent"}catch(i){console.error("Failed to retry message:",i),a.message_status="failed"}}},oe=async e=>{try{const a=await fetch(`/api/v1/messages/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${c()}`}});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const i=u.value.findIndex(d=>d.id===e);i!==-1&&u.value.splice(i,1)}catch(a){console.error("Failed to delete message:",a),j("Failed to delete message")}},le=e=>{u.value.find(i=>i.id===e.id)||(u.value.push(e),u.value.sort((i,d)=>new Date(i.created_at||i.timestamp)-new Date(d.created_at||d.timestamp)))},ie=(e,a)=>{const i=u.value.find(d=>d.id===e);i&&(i.message_status=a)},re=e=>{A.value=e},ue=e=>{N.value=e},H=()=>{g.value="",v.value.image=null,v.value.audio=null,$.value=!1},de=e=>{g.value+=e,$.value=!1},K=e=>{e&&e.type.startsWith("image/")&&(v.value.image=[e])},ce=e=>{e&&e.type.startsWith("audio/")&&(v.value.audio=[e])},Q=e=>{V.value=e,M.value=!0},me=()=>{M.value=!1,V.value=""},ve=(e,a)=>{a&&(h.value[e]||(h.value[e]={playing:!1}),Object.keys(h.value).forEach(i=>{i!==e&&h.value[i].playing&&(h.value[i].playing=!1)}),h.value[e].playing?(a.pause(),h.value[e].playing=!1):(a.play(),h.value[e].playing=!0))},ge=e=>{h.value[e]&&(h.value[e].playing=!1)},n=e=>e.trim()?u.value.filter(a=>a.content.toLowerCase().includes(e.toLowerCase())):u.value,t=()=>{const e={contact:{name:P.value,phone:L.value},messages:u.value.map(k=>({id:k.id,content:k.content,direction:k.direction,timestamp:k.created_at||k.timestamp,status:k.message_status})),exportedAt:new Date().toISOString()},a=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),i=URL.createObjectURL(a),d=document.createElement("a");d.href=i,d.download=`conversation_${P.value}_${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(i)},c=()=>localStorage.getItem("auth_token")||sessionStorage.getItem("auth_token"),j=e=>{console.error(e)};return{dialog:S,selectedContact:_,conversation:u,loading:R,replyMessage:g,attachment:v,showEmojiPicker:$,imagePreviewDialog:M,previewImageUrl:V,sending:I,audioStates:h,selectedContactId:T,typingIndicator:A,connectionStatus:N,commonEmojis:q,hasAttachment:J,canSendMessage:Y,contactName:P,contactPhone:L,unreadCount:B,lastMessage:ee,openDialog:te,closeDialog:ae,loadConversation:G,sendMessage:W,retryFailedMessage:se,deleteMessage:oe,addIncomingMessage:le,updateMessageStatus:ie,setTypingIndicator:re,setConnectionStatus:ue,clearForm:H,appendEmoji:de,handleImageUpload:K,handleAudioUpload:ce,openImagePreview:Q,closeImagePreview:me,toggleAudio:ve,onAudioEnded:ge,searchMessages:n,exportConversation:t,resetStore:()=>{S.value=!1,u.value=[],R.value=!1,g.value="",v.value={image:null,audio:null},$.value=!1,M.value=!1,V.value="",I.value=!1,h.value={},T.value=null,A.value=!1,N.value="online",_.value=null}}}),ze={class:"d-flex align-center w-100"},Be={class:"flex-grow-1"},We={class:"text-h6 mb-0"},He={class:"text-caption text-grey"},Ke={key:0,class:"pa-4"},Je={key:0,class:"message-sender text-caption font-weight-medium mb-1"},Ye={class:"message-content"},Ge={key:1,class:"message-media mt-2"},Qe={key:2,class:"message-media mt-2"},Xe={class:"audio-container"},Ze=["src","onEnded"],qe={class:"message-meta d-flex align-center justify-end mt-1"},et={class:"text-caption text-grey mr-2"},tt={key:0,class:"typing-indicator mb-3"},at={key:1,class:"empty-state pa-8 text-center"},nt={key:0,class:"attachment-preview mb-3"},st={class:"message-input-container"},ot={class:"input-actions d-flex align-center mt-2"},lt={class:"d-flex align-center flex-grow-1"},it={key:0,class:"text-caption text-grey ml-2"},rt={key:0,class:"emoji-picker mt-3 pa-3"},ut={class:"emoji-grid"},dt={__name:"WhatsAppConversation",setup(S){const u=Oe(),R=D(()=>{var n;return(n=u.user)==null?void 0:n.id}),g=Fe(),v=Ne(),{dialog:$,conversation:M,contactName:V,contactPhone:I,connectionStatus:h,replyMessage:T,attachment:_,imagePreviewDialog:A,previewImageUrl:N,typingIndicator:q,audioStates:J,sending:Y}=Ve(v),P=w(null),L=w(null),B=w(!1),ee=["ðŸ˜€","ðŸ˜‚","ðŸ˜","ðŸ˜­","ðŸ˜¡","ðŸ‘","ðŸ™","ðŸ”¥","ðŸŽ‰","ðŸ’¯"],te=()=>{switch(h.value){case"online":return"Online";case"offline":return"Offline";case"connecting":return"Connecting...";default:return"Unknown"}},ae=()=>{switch(h.value){case"online":return"success";case"offline":return"grey";case"connecting":return"warning";default:return"grey"}},G=n=>n.from!=="system",W=n=>n.from==="system"||n.direction==="outgoing",ne=n=>W(n)?"outgoing":"incoming",se=n=>W(n)?"outgoing":"incoming",oe=n=>{switch(n){case"sent":return"mdi-check";case"delivered":return"mdi-check-all";case"read":return"mdi-check-all";case"failed":return"mdi-alert-circle";case"sending":return"mdi-clock-outline";default:return"mdi-clock-outline"}},le=n=>{switch(n){case"read":return"blue";case"delivered":return"grey";case"sent":return"grey";case"failed":return"red";case"sending":return"orange";default:return"grey"}},ie=n=>{if(!n)return"-";const t=new Date(n),j=(new Date-t)/(1e3*60*60);return j<24?t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):j<168?t.toLocaleDateString([],{weekday:"short",hour:"2-digit",minute:"2-digit"}):t.toLocaleDateString([],{month:"short",day:"numeric"})},re=()=>{T.value+=`
`},ue=n=>{const t=n.target.files[0];t&&v.handleImageUpload(t)},H=n=>{const t=n.target.files[0];t&&v.handleAudioUpload(t)},de=(n,t)=>{let c=t[`audio-${n}`];Array.isArray(c)&&(c=c[0]),c?v.toggleAudio(n,c):console.warn(`Audio element not found for messageId: ${n}`)},K=()=>{ke(()=>{L.value&&(L.value.scrollTop=L.value.scrollHeight)})},ce=()=>{$.value=!1},Q=()=>{var n;return g.sendSingleMessage(R.value,v.selectedContact,g.messageText,(n=g.selectedTemplate)==null?void 0:n.id)},me=n=>{T.value+=n},ve=()=>{A.value=!1},ge=n=>{v.retryFailedMessage(n)};return D(()=>{var n,t;return T.value.trim().length>0||((n=_.value)==null?void 0:n.image)||((t=_.value)==null?void 0:t.audio)}),Ie(()=>{K(),g.initialize()}),pe(()=>v.selectedContact,n=>{n&&(g.selectedContacts=[n],console.log("âœ… Selected contact set:",g.selectedContacts))},{immediate:!0}),pe(M,()=>{K()},{deep:!0}),pe($,n=>{n&&ke(()=>K())}),(n,t)=>{const c=p("v-icon"),j=p("v-avatar"),X=p("v-chip"),e=p("v-btn"),a=p("v-card-title"),i=p("v-divider"),d=p("v-progress-linear"),k=p("v-img"),F=p("v-card-text"),E=p("v-select"),O=p("v-textarea"),Z=p("v-list-item-icon"),fe=p("v-list-item-title"),_e=p("v-list-item-content"),ye=p("v-list-item"),Ue=p("v-list"),Ae=p("v-menu"),je=p("v-expand-transition"),he=p("v-card"),Ee=p("v-spacer"),we=p("v-dialog");return y(),z(we,{modelValue:r($),"onUpdate:modelValue":t[8]||(t[8]=o=>Te($)?$.value=o:null),"max-width":"800",persistent:""},{default:l(()=>[s(he,{class:"conversation-dialog"},{default:l(()=>[s(a,{class:"conversation-header pa-4"},{default:l(()=>[m("div",ze,[s(j,{color:"primary",size:"40",class:"mr-3"},{default:l(()=>[s(c,{color:"white"},{default:l(()=>t[9]||(t[9]=[f("mdi-account")])),_:1,__:[9]})]),_:1}),m("div",Be,[m("div",We,x(r(V)),1),m("div",He,x(r(I)),1)]),s(X,{color:ae(),small:"",outlined:"",class:"mr-2"},{default:l(()=>[f(x(te()),1)]),_:1},8,["color"]),s(e,{icon:"",onClick:ce},{default:l(()=>[s(c,null,{default:l(()=>t[10]||(t[10]=[f("mdi-close")])),_:1,__:[10]})]),_:1})])]),_:1}),s(i),s(F,{class:"pa-0"},{default:l(()=>[r(g).loading.conversation?(y(),z(d,{key:0,indeterminate:"",color:"primary"})):(y(),C("div",{key:1,class:"messages-container",ref_key:"messagesContainer",ref:P},[Array.isArray(r(M))&&r(M).length?(y(),C("div",Ke,[(y(!0),C(Ce,null,xe(r(M),o=>(y(),C("div",{key:o.id,class:be(["message-wrapper mb-3",ne(o)])},[m("div",{class:be(["message-bubble elevation-1",se(o)])},[G(o)?(y(),C("div",Je,x(o.sender_name||r(V)),1)):b("",!0),m("div",Ye,x(o.content),1),o.image_url?(y(),C("div",Ge,[s(k,{src:o.image_url,"max-height":"200","max-width":"300",contain:"",class:"rounded",onClick:U=>n.openImagePreview(o.image_url),style:{cursor:"pointer"}},null,8,["src","onClick"])])):b("",!0),o.audio_url?(y(),C("div",Qe,[m("div",Xe,[s(e,{icon:"",small:"",onClick:U=>de(o.id,n.$refs),class:"mr-2"},{default:l(()=>[s(c,null,{default:l(()=>{var U;return[f(x((U=r(J)[o.id])!=null&&U.playing?"mdi-pause":"mdi-play"),1)]}),_:2},1024)]),_:2},1032,["onClick"]),m("audio",{ref_for:!0,ref:`audio-${o.id}`,src:o.audio_url,onEnded:U=>n.onAudioEnded(o.id),style:{display:"none"}},null,40,Ze),t[11]||(t[11]=m("span",{class:"text-caption"},"Voice message",-1))])])):b("",!0),m("div",qe,[m("span",et,x(ie(o.created_at||o.timestamp)),1),W(o)?(y(),z(c,{key:0,color:le(o.message_status),size:"14"},{default:l(()=>[f(x(oe(o.message_status)),1)]),_:2},1032,["color"])):b("",!0),o.message_status==="failed"?(y(),z(e,{key:1,icon:"","x-small":"",onClick:U=>ge(o.id),class:"ml-1"},{default:l(()=>[s(c,{size:"12"},{default:l(()=>t[12]||(t[12]=[f("mdi-refresh")])),_:1,__:[12]})]),_:2},1032,["onClick"])):b("",!0)])],2)],2))),128)),r(q)?(y(),C("div",tt,t[13]||(t[13]=[m("div",{class:"message-bubble incoming"},[m("div",{class:"typing-dots"},[m("span"),m("span"),m("span")])],-1)]))):b("",!0)])):(y(),C("div",at,[s(c,{size:"64",color:"grey lighten-2"},{default:l(()=>t[14]||(t[14]=[f("mdi-message-outline")])),_:1,__:[14]}),t[15]||(t[15]=m("div",{class:"text-h6 mt-4 text-grey"}," No messages yet ",-1)),t[16]||(t[16]=m("div",{class:"text-caption text-grey"}," Start the conversation below ",-1))]))],512))]),_:1}),s(i),s(F,{class:"reply-section pa-4"},{default:l(()=>[n.hasAttachment?(y(),C("div",nt,[r(_).image&&r(_).image.length?(y(),z(X,{key:0,close:"","onClick:close":t[0]||(t[0]=o=>r(_).image=null),color:"blue lighten-4",class:"mr-2"},{default:l(()=>{var o;return[s(c,{left:"",small:""},{default:l(()=>t[17]||(t[17]=[f("mdi-image")])),_:1,__:[17]}),f(" "+x((o=r(_).image[0])==null?void 0:o.name),1)]}),_:1})):b("",!0),r(_).audio&&r(_).audio.length?(y(),z(X,{key:1,close:"","onClick:close":t[1]||(t[1]=o=>r(_).audio=null),color:"green lighten-4"},{default:l(()=>{var o;return[s(c,{left:"",small:""},{default:l(()=>t[18]||(t[18]=[f("mdi-microphone")])),_:1,__:[18]}),f(" "+x((o=r(_).audio[0])==null?void 0:o.name),1)]}),_:1})):b("",!0)])):b("",!0),s(E,{modelValue:r(g).selectedTemplate,"onUpdate:modelValue":[t[2]||(t[2]=o=>r(g).selectedTemplate=o),r(g).onTemplateSelect],items:r(g).allTemplates,"item-title":"name","item-value":"id",label:"Select Template","return-object":"",disabled:r(g).loading.templates,loading:r(g).loading.templates,class:"mt-3",clearable:""},null,8,["modelValue","items","disabled","loading","onUpdate:modelValue"]),m("div",st,[s(O,{modelValue:r(g).messageText,"onUpdate:modelValue":t[3]||(t[3]=o=>r(g).messageText=o),label:"Type your message...",rows:"2","auto-grow":"",outlined:"",dense:"","hide-details":"",class:"message-input",disabled:r(h)!=="online",onKeydown:[Se($e(Q,["exact","prevent"]),["enter"]),Se($e(re,["shift","exact"]),["enter"])]},null,8,["modelValue","disabled","onKeydown"]),m("div",ot,[m("div",lt,[s(e,{icon:"",small:"",onClick:t[4]||(t[4]=o=>B.value=!B.value),class:"mr-2",disabled:r(h)!=="online"},{default:l(()=>[s(c,null,{default:l(()=>t[19]||(t[19]=[f("mdi-emoticon-happy-outline")])),_:1,__:[19]})]),_:1},8,["disabled"]),s(Ae,{"offset-y":""},{activator:l(({on:o,attrs:U})=>[s(e,Pe({icon:"",small:""},U,Le(o),{class:"mr-2",disabled:r(h)!=="online"}),{default:l(()=>[s(c,null,{default:l(()=>t[20]||(t[20]=[f("mdi-attachment")])),_:1,__:[20]})]),_:2},1040,["disabled"])]),default:l(()=>[s(Ue,{dense:""},{default:l(()=>[s(ye,{onClick:t[5]||(t[5]=o=>n.$refs.imageInput.click())},{default:l(()=>[s(Z,null,{default:l(()=>[s(c,null,{default:l(()=>t[21]||(t[21]=[f("mdi-image")])),_:1,__:[21]})]),_:1}),s(_e,null,{default:l(()=>[s(fe,null,{default:l(()=>t[22]||(t[22]=[f("Image")])),_:1,__:[22]})]),_:1})]),_:1}),s(ye,{onClick:t[6]||(t[6]=o=>n.$refs.audioInput.click())},{default:l(()=>[s(Z,null,{default:l(()=>[s(c,null,{default:l(()=>t[23]||(t[23]=[f("mdi-microphone")])),_:1,__:[23]})]),_:1}),s(_e,null,{default:l(()=>[s(fe,null,{default:l(()=>t[24]||(t[24]=[f("Voice Note")])),_:1,__:[24]})]),_:1})]),_:1})]),_:1})]),_:1}),m("input",{ref:"imageInput",type:"file",accept:"image/*",onChange:ue,style:{display:"none"}},null,544),m("input",{ref:"audioInput",type:"file",accept:"audio/*",onChange:H,style:{display:"none"}},null,544),r(T).length>0?(y(),C("span",it,x(r(T).length),1)):b("",!0)]),s(e,{color:"primary",onClick:Q,class:"ml-2",loading:r(Y)},{default:l(()=>[s(c,null,{default:l(()=>t[25]||(t[25]=[f("mdi-send")])),_:1,__:[25]})]),_:1},8,["loading"])]),s(je,null,{default:l(()=>[B.value?(y(),C("div",rt,[m("div",ut,[(y(),C(Ce,null,xe(ee,o=>s(e,{key:o,text:"","x-small":"",onClick:U=>me(o),class:"emoji-btn"},{default:l(()=>[f(x(o),1)]),_:2},1032,["onClick"])),64))])])):b("",!0)]),_:1})])]),_:1})]),_:1}),s(we,{modelValue:r(A),"onUpdate:modelValue":t[7]||(t[7]=o=>Te(A)?A.value=o:null),"max-width":"90vw"},{default:l(()=>[s(he,null,{default:l(()=>[s(a,{class:"pa-2"},{default:l(()=>[s(Ee),s(e,{icon:"",onClick:ve},{default:l(()=>[s(c,null,{default:l(()=>t[26]||(t[26]=[f("mdi-close")])),_:1,__:[26]})]),_:1})]),_:1}),s(F,{class:"pa-2"},{default:l(()=>[s(k,{src:r(N),contain:"","max-height":"80vh"},null,8,["src"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])}}},ct=Re(dt,[["__scopeId","data-v-c5851893"]]),yt=Object.freeze(Object.defineProperty({__proto__:null,default:ct},Symbol.toStringTag,{value:"Module"}));export{ct as W,yt as a,Ne as u};
