import{E as W,r as i,G as A,j as d}from"./app-DtzzgwNC.js";import{A as R}from"./africastalking-bEyHLJvt.js";const x=W("webrtc",()=>{const c=i("offline"),p=A(),u=d(()=>{var n,o;return(o=(n=p.props.auth)==null?void 0:n.user)==null?void 0:o.token}),v=d(()=>{var n,o;return(o=(n=p.props.auth)==null?void 0:n.user)==null?void 0:o.id}),f=i(null),l=i(!1),g=i(null),a=i(!1),C=d(()=>a.value?"success":"error"),b=d(()=>a.value?"Online":"Offline");function m(e){g.value=e,l.value=!0}function h(){l.value=!1,g.value=null}function T(){setInterval(()=>{(c.value==="ready"||c.value==="busy")&&axios.post("/api/v1/agent/ping").catch(()=>{})},15e3)}function k(){Echo.private("agent.status").listen(".status.updated",e=>{console.log(`üîÑ Agent ${e.agentId} is now ${e.status}`),e.agentId===v.value&&(c.value=e.status)})}async function w(){return new Promise(e=>{const n=setInterval(()=>{u.value&&(clearInterval(n),e())},300)})}async function r(e){try{c.value=e,await axios.post("/api/v1/agent/status",{status:e}),console.log(`‚úÖ Agent status updated to ${e}`)}catch(n){console.error("‚ùå Failed to update agent status:",n)}}async function I(){var o,y;if(((y=(o=p.props.auth)==null?void 0:o.user)==null?void 0:y.country_id)===2){console.warn("üö´ AfricasTalking disabled for Zambia users"),f.value=null,a.value=!1;return}if(T(),k(),u.value||(console.warn("Waiting for token..."),await w()),f.value){console.log("WebRTC client already initialized.");return}const n={sounds:{ringing:"https://support.solssa.com/storage/ringtones/office_phone.mp3"}};try{const t=new R.Client(u.value,n);f.value=t,console.log("‚úÖ WebRTC client initialized for user:",v.value),t.on("ready",()=>{a.value=!0,console.log("üéß WebRTC client ready."),r("ready")}),t.on("error",s=>{console.error("‚ùå WebRTC error:",s)}),t.on("closed",()=>{a.value=!1,console.warn("üîå WebRTC connection closed."),r("offline")}),t.on("incomingcall",s=>{console.log("üìû Incoming call from",s.from),r("busy"),m({from:s.from,duration:"Connecting..."})}),t.on("hangup",s=>{console.log("‚òéÔ∏è Call hung up:",s.reason),r("ready"),l.value=!1,a.value=!1})}catch(t){console.error("‚ö†Ô∏è Failed to initialize WebRTC:",t)}}return{afClient:f,userId:v,userToken:u,incomingCallDialog:l,incomingCall:g,connection_active:a,connectionStatusColor:C,connectionStatusText:b,incomingCall:g,incomingCallDialog:l,setIncomingCall:m,closeIncomingCallDialog:h,initializeAfricastalking:I,updateAgentStatus:r}});export{x as u};
