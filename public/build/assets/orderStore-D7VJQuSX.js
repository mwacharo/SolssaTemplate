import{E as Ve,r as l,P as We,j as w,i as o}from"./app-DtzzgwNC.js";import{n as i}from"./toast-BzC1xQ81.js";const Je=Ve("orders",()=>{const _=l(""),m=l(""),U=We({deliveryPerson:"",callCentreAgent:"",status:"",notes:"",zone:"",city:""}),u=l([]),c=l({orders:!1,options:!1,creating:!1,updating:!1,deleting:!1}),d=l(null),le=l([]),B=l(!1),O=l(!1),F=l(null),A=l(null),N=l(!1),q=l(!1),D=l(null),b=l(null),C=l(null),R=l(null),k=l(null),E=l(null),x=l(null),S=l(null),g=l([null,null]),f=l([null,null]),y=l([null,null]),j=l(""),$=l({}),oe=l([]),V=l([]),W=l([]),Y=l([]),Z=l([]),G=l([]),H=l([]),J=l([]),K=l([]),Q=l([]),X=l([]),ne=l([]),ie=l([]),I=l([]),h=l({current_page:1,last_page:1,per_page:15,total:0,from:0,to:0}),ce=[15,30,50,100,200],ue=w(()=>e=>u.value.find(a=>a.id===e)),de=w(()=>u.value.filter(e=>e.status===1)),pe=w(()=>u.value.filter(e=>e.status===0)),ve=w(()=>u.value.filter(e=>e.status===2)),ge=w(()=>u.value.reduce((e,a)=>e+parseFloat(a.total_price||0),0)),fe=w(()=>{let e=0;return D.value&&e++,b.value&&e++,C.value&&e++,R.value&&e++,k.value&&e++,E.value&&e++,x.value&&e++,S.value&&e++,g.value&&g.value.length>0&&e++,f.value&&f.value.length>0&&e++,y.value&&y.value.length>0&&e++,j.value&&e++,e}),ye=w(()=>({status:D.value,product:b.value,zone:C.value,agent:R.value,rider:k.value,vendor:E.value,city:x.value,category:S.value,deliveryDateRange:g.value,statusDateRange:f.value,createdDateRange:y.value,search:j.value})),z=e=>{if(!e)return null;const a=new Date(e),s=a.getFullYear(),r=String(a.getMonth()+1).padStart(2,"0"),t=String(a.getDate()).padStart(2,"0");return`${s}-${r}-${t}`},ee=()=>{const e={};if(D.value&&(e.status=D.value),b.value&&(e.product_id=b.value),C.value&&(e.zone_id=C.value),R.value&&(e.agent_id=R.value),k.value&&(e.rider_id=k.value),E.value&&(e.vendostatusDateRanger_id=E.value),x.value&&(e.city_id=x.value),S.value&&(e.category_id=S.value),j.value&&(e.search=j.value),g.value&&g.value.length>0){const a=g.value;e.delivery_from=z(a[0]),e.delivery_to=z(a[a.length-1])}if(f.value&&f.value.length>0){const a=f.value;e.status_from=z(a[0]),e.status_to=z(a[a.length-1])}if(y.value&&y.value.length>0){const a=y.value;e.created_from=z(a[0]),e.created_to=z(a[a.length-1])}return e},L=async(e={})=>{var a,s;c.value.orders=!0,d.value=null;try{const r=new URLSearchParams,t={...$.value,...e};t.page&&r.append("page",t.page),t.per_page&&r.append("per_page",t.per_page),t.status&&r.append("status",t.status),t.vendor_id&&r.append("vendor_id",t.vendor_id),t.city_id&&r.append("city_id",t.city_id),t.agent_id&&r.append("agent_id",t.agent_id),t.rider_id&&r.append("rider_id",t.rider_id),t.zone_id&&r.append("zone_id",t.zone_id),t.product_id&&r.append("product_id",t.product_id),t.category_id&&r.append("category_id",t.category_id),t.search&&r.append("search",t.search),t.delivery_from&&r.append("delivery_from",t.delivery_from),t.delivery_to&&r.append("delivery_to",t.delivery_to),t.status_from&&r.append("status_from",t.status_from),t.status_to&&r.append("status_to",t.status_to),t.created_from&&r.append("created_from",t.created_from),t.created_to&&r.append("created_to",t.created_to);const v=(await o.get(`/api/v1/orders?${r.toString()}`,{headers:{Accept:"application/json","Content-Type":"application/json"}})).data;if(!v.success)throw new Error(v.message||"Failed to fetch orders");q.value=!1;const p=v.data;return u.value=p.data||[],h.value={current_page:p.current_page||1,last_page:p.last_page||1,per_page:p.per_page||15,total:p.total||0,from:p.from||0,to:p.to||0},p}catch(r){throw d.value=((s=(a=r.response)==null?void 0:a.data)==null?void 0:s.message)||r.message||"Failed to fetch orders",r}finally{c.value.orders=!1}},he=async()=>{const e=ee();$.value={...e,per_page:h.value.per_page},e.page=1,e.per_page=h.value.per_page,await L(e)},we=async e=>{h.value.per_page=e;const a=ee();$.value={...a,per_page:e},await L({...a,page:1,per_page:e})},_e=()=>{D.value=null,b.value=null,C.value=null,R.value=null,k.value=null,E.value=null,x.value=null,S.value=null,g.value=[],f.value=[],y.value=[],j.value="",$.value={}},P=l([]),me=async e=>{var a,s;if(!(!e||e.length===0))try{const r=await o.post("/api/v1/bulk-print-waybills",{order_ids:e},{headers:{Accept:"application/json","Content-Type":"application/json"},responseType:"blob"}),t=window.URL.createObjectURL(new Blob([r.data])),n=document.createElement("a");n.href=t,n.setAttribute("download","waybills.pdf"),document.body.appendChild(n),n.click(),n.remove(),i.success("Waybills printed successfully")}catch(r){throw i.error("Failed to print waybills"),d.value=((s=(a=r.response)==null?void 0:a.data)==null?void 0:s.message)||r.message||"Failed to print waybill",r}},ae=async e=>{c.value.orders=!0,d.value=null;try{const a=await te(e);return A.value=a,F.value=e,a}catch(a){throw d.value=a.message||"Failed to load order",a}finally{c.value.orders=!1}},Oe=async e=>{var a,s;c.value.creating=!0,d.value=null;try{const t=(await o.post("/api/v1/orders",e,{headers:{Accept:"application/json","Content-Type":"application/json"}})).data;if(!t.success)throw new Error(t.message||"Failed to create order");return u.value.unshift(t.data),h.value.total+=1,i.success("Order created successfully"),t.data}catch(r){throw i.error("Failed to create order"),d.value=((s=(a=r.response)==null?void 0:a.data)==null?void 0:s.message)||r.message||"Failed to create order",r}finally{c.value.creating=!1}},M=async(e,a)=>{var s,r;c.value.updating=!0,d.value=null;try{const n=(await o.put(`/api/v1/orders/${e}`,a,{headers:{Accept:"application/json","Content-Type":"application/json"}})).data;if(!n.success)throw new Error(n.message||"Failed to update order");const v=u.value.findIndex(p=>p.id===e);return v!==-1&&(u.value[v]=n.data),F.value===e&&(A.value=n.data),n.data}catch(t){throw i.error("Failed to update order"),d.value=((r=(s=t.response)==null?void 0:s.data)==null?void 0:r.message)||t.message||"Failed to update order",t}finally{c.value.updating=!1}},Fe=async e=>{var a,s;c.value.deleting=!0,d.value=null;try{const t=(await o.delete(`/api/v1/orders/${e}`,{headers:{Accept:"application/json"}})).data;if(!t.success)throw new Error(t.message||"Failed to delete order");const n=u.value.findIndex(v=>v.id===e);n!==-1&&(u.value.splice(n,1),h.value.total-=1),i.success("Order deleted successfully")}catch(r){throw i.error("Failed to delete order"),d.value=((s=(a=r.response)==null?void 0:a.data)==null?void 0:s.message)||r.message||"Failed to delete order",r}finally{c.value.deleting=!1}},te=async e=>{var a,s;try{const t=(await o.get(`/api/v1/orders/${e}`,{headers:{Accept:"application/json"}})).data;if(!t.success)throw new Error(t.message||"Failed to fetch order details");return t.data}catch(r){const t=((s=(a=r.response)==null?void 0:a.data)==null?void 0:s.message)||r.message||"Failed to fetch order details";throw new Error(t)}},Ae=async(e,a)=>M(e,{customer:a}),De=async(e,a)=>M(e,{order_items:a}),re=async(e=null)=>{if(c.value.options){console.log("Options already loading, skipping...");return}c.value.options=!0;try{console.log("Fetching dropdown options...");const a=[o.get("/api/v1/statuses").catch(()=>({data:{data:[]}})),o.get("/api/v1/categories").catch(()=>({data:{data:[]}})),o.get("/api/v1/cities").catch(()=>({data:{data:[]}})),o.get("/api/v1/zones").catch(()=>({data:{data:[]}})),o.get("/api/v1/agents").catch(()=>({data:{data:[]}})),o.get("/api/v1/riders").catch(()=>({data:{data:[]}})),o.get("/api/v1/vendors").catch(()=>({data:{data:[]}})),o.get("/api/v1/countries").catch(()=>({data:{data:[]}})),o.get("/api/v1/warehouses").catch(()=>({data:{data:[]}})),o.get("/api/v1/clients").catch(()=>({data:{data:[]}}))];e?a.push(o.get(`/api/v1/vendors/${e}/products`).catch(()=>({data:{success:!1,data:[]}}))):a.push(o.get("/api/v1/products").catch(()=>({data:{success:!1,data:[]}})));const s=T=>!T||!T.data?[]:Array.isArray(T.data)?T.data:Array.isArray(T.data.data)?T.data.data:[],[r,t,n,v,p,Be,qe,Le,Ue,Ne,Me]=await Promise.all(a);I.value=s(r),W.value=s(t),Y.value=s(n),Z.value=s(v),G.value=s(p),H.value=s(Be),J.value=s(qe),X.value=s(Le),Q.value=s(Ue),K.value=s(Ne),V.value=s(Me),console.log("Dropdown options loaded successfully")}catch(a){throw console.error("Failed to fetch dropdown options:",a),a}finally{c.value.options=!1}},be=async e=>{if(F.value=e,q.value=!1,B.value=!0,e){const a=await ae(e);return A.value=a,a}},Ce=()=>{B.value=!0,F.value=null,A.value=null,q.value=!0},Re=()=>{B.value=!1,F.value=null,A.value=null},ke=(e=[])=>{console.debug("openAssignDeliveryDialog called with:",e),P.value=e,_.value="assignDelivery",m.value="Assign Delivery Person",O.value=!0},Ee=(e=[])=>{P.value=e,_.value="assignCallCentre",m.value="Assign Call Centre Agent",O.value=!0},xe=(e=[])=>{P.value=e,_.value="status",m.value="Change Status",O.value=!0},Se=(e=[])=>{P.value=e,_.value="delete",m.value="Delete Orders",O.value=!0},se=()=>{O.value=!1,_.value="",m.value="",P.value=[],Object.keys(U).forEach(e=>{U[e]=""})},je=async e=>{c.value.updating=!0;try{const{type:a,data:s,orders:r}=e,t=Array.isArray(r)&&r.length>0?r:P.value;switch(a){case"assignDelivery":if(!s.deliveryPerson)throw new Error("No delivery person selected");await ze(t,s.deliveryPerson);break;case"assignCallCentre":if(!s.callCentreAgent)throw new Error("No call centre agent selected");await Pe(t,s.callCentreAgent);break;case"status":if(!s.status)throw new Error("No status selected");await Te(t,s.status);break;case"delete":await $e(t);break}se()}catch(a){console.error("Bulk action failed:",a)}finally{c.value.updating=!1}},ze=async(e=[],a)=>{if(!e.length||!a)throw new Error("Orders and deliveryPersonId are required");try{await o.post("/api/v1/orders/assign-rider",{order_ids:e,rider_id:a}),i.success("Rider assigned successfully")}catch(s){throw i.error("Failed to assign rider"),s}},Pe=async(e=[],a)=>{if(!e.length||!a)throw new Error("Orders and agentId are required");try{await o.post("/api/v1/orders/assign-agent",{order_ids:e,agent_id:a}),i.success("Call centre agent assigned successfully")}catch(s){throw i.error("Failed to assign call centre agent"),s}},Te=async(e=[],a)=>{if(!e.length||!a)throw new Error("Orders and status are required");try{await o.post("/api/v1/orders/update-status",{order_ids:e,status:a}),i.success("Order status updated successfully")}catch(s){throw i.error("Failed to update order status"),s}},$e=async(e=[])=>{if(!e.length)throw new Error("No orders selected for deletion");try{await o.post("/api/v1/orders/bulk-delete",{order_ids:e}),Array.isArray(u.value)&&e.forEach(a=>{const s=u.value.findIndex(r=>r.id===a);s!==-1&&(u.value.splice(s,1),h.value.total-=1)}),i.success("Orders deleted successfully")}catch(a){throw i.error("Failed to bulk delete orders"),a}};return{orders:u,loading:c,error:d,notifications:le,dialog:B,bulkActionDialog:O,selectedOrderId:F,selectedOrder:A,initialized:N,isCreateMode:q,orderFilterStatus:D,orderFilterProduct:b,orderFilterZone:C,orderFilterAgent:R,orderFilterRider:k,orderFilterVendor:E,orderFilterCity:x,orderFilterCategory:S,deliveryDateRange:g,statusDateRange:f,createdDateRange:y,orderSearch:j,lastAppliedFilters:$,orderStatusOptions:oe,productOptions:V,categoryOptions:W,cityOptions:Y,zoneOptions:Z,agentOptions:G,riderOptions:H,vendorOptions:J,clientOptions:K,warehouseOptions:Q,countryOptions:X,deliveryStatusOptions:ne,userOptions:ie,statusOptions:I,pagination:h,perPageOptions:ce,getOrderById:ue,confirmedOrders:de,pendingOrders:pe,cancelledOrders:ve,totalRevenue:ge,activeFilterCount:fe,currentFilters:ye,printOrders:me,fetchOrders:L,loadOrder:ae,createOrder:Oe,updateOrder:M,exportOrders:async e=>{if(!(!e||e.length===0))try{const a=await o.post("/api/v1/orders/export",{order_ids:e},{responseType:"blob"}),s=window.URL.createObjectURL(new Blob([a.data])),r=document.createElement("a");r.href=s,r.setAttribute("download","orders.xlsx"),document.body.appendChild(r),r.click(),r.remove(),i.success("Orders exported successfully")}catch(a){throw i.error("Failed to export orders"),a}},updateOrderCustomer:Ae,updateOrderItems:De,deleteOrder:Fe,getOrderDetails:te,fetchDropdownOptions:re,openDialog:be,openCreateDialog:Ce,openAssignDeliveryDialog:ke,openAssignCallCentreDialog:Ee,openBulkStatusDialog:xe,dialogType:_,dialogTitle:m,bulkActionForm:U,openDeleteDialog:Se,closeBulkActionDialog:se,handleBulkAction:je,closeDialog:Re,clearAllFilters:_e,applyFilters:he,changePerPage:we,initialize:async()=>{if(!N.value)try{await Promise.all([re(),L({page:1})]),N.value=!0}catch(e){console.error("Failed to initialize order store:",e)}}}});export{Je as u};
