import{E as qe,r as s,P as $e,j as A,i as o}from"./app-BAMjVpRk.js";import{n as u}from"./toast-CfC9N1LD.js";const Ve=qe("orders",()=>{const y=s(""),h=s(""),B=$e({deliveryPerson:"",callCentreAgent:"",status:"",notes:"",zone:"",city:""}),c=s([]),i=s({orders:!1,options:!1,creating:!1,updating:!1,deleting:!1}),v=s(null),ae=s([]),S=s(!1),w=s(!1),F=s(null),b=s(null),N=s(!1),x=s(!1),C=s(null),D=s(null),k=s(null),m=s(null),R=s(null),j=s(null),E=s(null),T=s(null),p=s([null,null]),g=s([null,null]),f=s([null,null]),_=s(""),re=s([]),L=s([]),M=s([]),V=s([]),W=s([]),Z=s([]),G=s([]),H=s([]),J=s([]),K=s([]),Q=s([]),se=s([]),le=s([]),X=s([]),P=s({current_page:1,last_page:1,per_page:15,total:0,from:0,to:0}),oe=A(()=>e=>c.value.find(t=>t.id===e)),ne=A(()=>c.value.filter(e=>e.status===1)),ie=A(()=>c.value.filter(e=>e.status===0)),ce=A(()=>c.value.filter(e=>e.status===2)),de=A(()=>c.value.reduce((e,t)=>e+parseFloat(t.total_price||0),0)),ue=A(()=>{let e=0;return C.value&&e++,D.value&&e++,k.value&&e++,m.value&&e++,R.value&&e++,j.value&&e++,E.value&&e++,T.value&&e++,p.value&&p.value.length>0&&e++,g.value&&g.value.length>0&&e++,f.value&&f.value.length>0&&e++,_.value&&e++,e}),ve=A(()=>({status:C.value,product:D.value,zone:k.value,agent:m.value,rider:R.value,vendor:j.value,city:E.value,category:T.value,deliveryDateRange:p.value,statusDateRange:g.value,createdDateRange:f.value,search:_.value})),U=async(e={})=>{var t,a;i.value.orders=!0,v.value=null;try{const r=new URLSearchParams;e.page&&r.append("page",e.page),e.per_page&&r.append("per_page",e.per_page),e.status&&r.append("status",e.status),e.vendor_id&&r.append("vendor_id",e.vendor_id),e.city_id&&r.append("city",e.city_id),e.agent_id&&r.append("agent_id",e.agent_id),e.rider_id&&r.append("rider_id",e.rider_id),e.zone_id&&r.append("zone_id",e.zone_id),e.product_id&&r.append("product_id",e.product_id),e.category_id&&r.append("category_id",e.category_id),e.search&&r.append("search",e.search),e.created_from&&r.append("created_from",e.created_from),e.created_to&&r.append("created_to",e.created_to);const n=(await o.get(`/api/v1/orders?${r.toString()}`,{headers:{Accept:"application/json","Content-Type":"application/json"}})).data;if(!n.success)throw new Error(n.message||"Failed to fetch orders");x.value=!1;const d=n.data;return c.value=d.data||[],P.value={current_page:d.current_page||1,last_page:d.last_page||1,itemsPerPage:d.per_page||15,total:d.total||0,from:d.from||0,to:d.to||0},d}catch(r){throw v.value=((a=(t=r.response)==null?void 0:t.data)==null?void 0:a.message)||r.message||"Failed to fetch orders",r}finally{i.value.orders=!1}},O=s([]),pe=async e=>{var t,a;if(!(!e||e.length===0))try{const r=await o.post("/api/v1/bulk-print-waybills",{order_ids:e},{headers:{Accept:"application/json","Content-Type":"application/json"},responseType:"blob"}),l=window.URL.createObjectURL(new Blob([r.data])),n=document.createElement("a");n.href=l,n.setAttribute("download","waybills.pdf"),document.body.appendChild(n),n.click(),n.remove(),u.success("Waybills printed successfully")}catch(r){throw u.error("Failed to print waybills"),v.value=((a=(t=r.response)==null?void 0:t.data)==null?void 0:a.message)||r.message||"Failed to print waybill",r}},Y=async e=>{i.value.orders=!0,v.value=null;try{const t=await I(e);return b.value=t,F.value=e,t}catch(t){throw v.value=t.message||"Failed to load order",t}finally{i.value.orders=!1}},ge=async e=>{var t,a;i.value.creating=!0,v.value=null;try{const l=(await o.post("/api/v1/orders",e,{headers:{Accept:"application/json","Content-Type":"application/json"}})).data;if(!l.success)throw new Error(l.message||"Failed to create order");return c.value.unshift(l.data),P.value.total+=1,u.success("Order created successfully"),l.data}catch(r){throw u.error("Failed to create order"),v.value=((a=(t=r.response)==null?void 0:t.data)==null?void 0:a.message)||r.message||"Failed to create order",r}finally{i.value.creating=!1}},q=async(e,t)=>{var a,r;i.value.updating=!0,v.value=null;try{const n=(await o.put(`/api/v1/orders/${e}`,t,{headers:{Accept:"application/json","Content-Type":"application/json"}})).data;if(!n.success)throw new Error(n.message||"Failed to update order");const d=c.value.findIndex($=>$.id===e);return d!==-1&&(c.value[d]=n.data),F.value===e&&(b.value=n.data),n.data}catch(l){throw u.error("Failed to update order"),v.value=((r=(a=l.response)==null?void 0:a.data)==null?void 0:r.message)||l.message||"Failed to update order",l}finally{i.value.updating=!1}},fe=async e=>{var t,a;i.value.deleting=!0,v.value=null;try{const l=(await o.delete(`/api/v1/orders/${e}`,{headers:{Accept:"application/json"}})).data;if(!l.success)throw new Error(l.message||"Failed to delete order");const n=c.value.findIndex(d=>d.id===e);n!==-1&&(c.value.splice(n,1),P.value.total-=1),u.success("Order deleted successfully")}catch(r){throw u.error("Failed to delete order"),v.value=((a=(t=r.response)==null?void 0:t.data)==null?void 0:a.message)||r.message||"Failed to delete order",r}finally{i.value.deleting=!1}},I=async e=>{var t,a;try{const l=(await o.get(`/api/v1/orders/${e}`,{headers:{Accept:"application/json"}})).data;if(!l.success)throw new Error(l.message||"Failed to fetch order details");return l.data}catch(r){const l=((a=(t=r.response)==null?void 0:t.data)==null?void 0:a.message)||r.message||"Failed to fetch order details";throw new Error(l)}},ye=async(e,t)=>q(e,{customer:t}),he=async(e,t)=>q(e,{order_items:t}),ee=async(e=null)=>{if(i.value.options){console.log("Options already loading, skipping...");return}i.value.options=!0;try{console.log("Fetching dropdown options...");const t=[o.get("/api/v1/statuses").catch(()=>({data:{data:[]}})),o.get("/api/v1/categories").catch(()=>({data:{data:[]}})),o.get("/api/v1/cities").catch(()=>({data:{data:[]}})),o.get("/api/v1/zones").catch(()=>({data:{data:[]}})),o.get("/api/v1/agents").catch(()=>({data:{data:[]}})),o.get("/api/v1/riders").catch(()=>({data:{data:[]}})),o.get("/api/v1/vendors").catch(()=>({data:{data:[]}})),o.get("/api/v1/countries").catch(()=>({data:{data:[]}})),o.get("/api/v1/warehouses").catch(()=>({data:{data:[]}})),o.get("/api/v1/clients").catch(()=>({data:{data:[]}}))];e?t.push(o.get(`/api/v1/vendors/${e}/products`).catch(()=>({data:{success:!1,data:[]}}))):t.push(o.get("/api/v1/products").catch(()=>({data:{success:!1,data:[]}})));const a=z=>!z||!z.data?[]:Array.isArray(z.data)?z.data:Array.isArray(z.data.data)?z.data.data:[],[r,l,n,d,$,Pe,Se,xe,Be,Ne,Ue]=await Promise.all(t);X.value=a(r),M.value=a(l),V.value=a(n),W.value=a(d),Z.value=a($),G.value=a(Pe),H.value=a(Se),Q.value=a(xe),K.value=a(Be),J.value=a(Ne),L.value=a(Ue),console.log("Dropdown options loaded successfully")}catch(t){throw console.error("Failed to fetch dropdown options:",t),t}finally{i.value.options=!1}},we=async e=>{if(F.value=e,x.value=!1,S.value=!0,e){const t=await Y(e);return b.value=t,t}},_e=()=>{S.value=!0,F.value=null,b.value=null,x.value=!0},Oe=()=>{S.value=!1,F.value=null,b.value=null},Ae=()=>{C.value=null,D.value=null,k.value=null,m.value=null,R.value=null,j.value=null,E.value=null,T.value=null,p.value=[],g.value=[],f.value=[],_.value=""},Fe=async()=>{const e={};C.value&&(e.status=C.value),D.value&&(e.product_id=D.value),k.value&&(e.zone_id=k.value),m.value&&(e.agent_id=m.value),R.value&&(e.rider_id=R.value),j.value&&(e.vendor_id=j.value),E.value&&(e.city_id=E.value),T.value&&(e.category_id=T.value),_.value&&(e.search=_.value),p.value&&p.value.length===2&&(e.delivery_from=p.value[0],e.delivery_to=p.value[1]),g.value&&g.value.length===2&&(e.status_from=g.value[0],e.status_to=g.value[1]),f.value&&f.value.length===2&&(e.created_from=f.value[0],e.created_to=f.value[1]),e.page=1,await U(e)},be=async()=>{if(!N.value)try{await Promise.all([ee(),U({page:1})]),N.value=!0}catch(e){console.error("Failed to initialize order store:",e)}},Ce=(e=[])=>{console.debug("openAssignDeliveryDialog called with:",e),O.value=e,y.value="assignDelivery",h.value="Assign Delivery Person",w.value=!0,console.debug("Bulk action dialog opened. State:",{selectedOrders:O.value,dialogType:y.value,dialogTitle:h.value,bulkActionDialog:w.value})},De=(e=[])=>{O.value=e,y.value="assignCallCentre",h.value="Assign Call Centre Agent",w.value=!0},ke=(e=[])=>{O.value=e,y.value="status",h.value="Change Status",w.value=!0},me=(e=[])=>{O.value=e,y.value="delete",h.value="Delete Orders",w.value=!0},te=()=>{w.value=!1,y.value="",h.value="",O.value=[],Object.keys(B).forEach(e=>{B[e]=""})},Re=async e=>{i.value.updating=!0;try{const{type:t,data:a,orders:r}=e,l=Array.isArray(r)&&r.length>0?r:O.value;switch(console.debug("handleBulkAction called with:",{type:t,data:a,orders:l}),t){case"assignDelivery":if(!a.deliveryPerson)throw console.error("No delivery person selected"),new Error("No delivery person selected");console.debug("Assigning delivery person:",a.deliveryPerson,"to orders:",l),await je(l,a.deliveryPerson);break;case"assignCallCentre":if(!a.callCentreAgent)throw console.error("No call centre agent selected"),new Error("No call centre agent selected");console.debug("Assigning call centre agent:",a.callCentreAgent,"to orders:",l),await Ee(l,a.callCentreAgent);break;case"status":if(!a.status)throw console.error("No status selected"),new Error("No status selected");console.debug("Updating status for orders:",l,"with status:",a.status),await Te(l,a.status);break;case"delete":console.debug("Deleting orders:",l),await ze(l);break;default:console.warn("Unknown bulk action type:",t)}te()}catch(t){console.error("Bulk action failed:",t)}finally{i.value.updating=!1}},je=async(e=[],t)=>{if(!e.length||!t)throw new Error("Orders and deliveryPersonId are required");try{await o.post("/api/v1/orders/assign-rider",{order_ids:e,rider_id:t},{headers:{Accept:"application/json","Content-Type":"application/json"}}),console.log("Assigned delivery person:",t,"to orders:",e),u.success("Rider assigned successfully")}catch(a){throw u.error("Failed to assign rider"),console.error("Failed to assign rider:",a),a}},Ee=async(e=[],t)=>{if(!e.length||!t)throw new Error("Orders and agentId are required");try{await o.post("/api/v1/orders/assign-agent",{order_ids:e,agent_id:t},{headers:{Accept:"application/json","Content-Type":"application/json"}}),console.log("Assigned call centre agent:",t,"to orders:",e),u.success("Call centre agent assigned successfully")}catch(a){throw u.error("Failed to assign call centre agent"),console.error("Failed to assign agent:",a),a}},Te=async(e=[],t)=>{if(!e.length||!t)throw new Error("Orders and status are required");try{await o.post("/api/v1/orders/update-status",{order_ids:e,status:t},{headers:{Accept:"application/json","Content-Type":"application/json"}}),console.log("Updated status for orders:",e,"to status:",t),u.success("Order status updated successfully")}catch(a){throw u.error("Failed to update order status"),console.error("Failed to update status:",a),a}},ze=async(e=[])=>{if(!e.length)throw new Error("No orders selected for deletion");try{await o.post("/api/v1/orders/bulk-delete",{order_ids:e},{headers:{Accept:"application/json","Content-Type":"application/json"}}),Array.isArray(c.value)&&e.forEach(t=>{const a=c.value.findIndex(r=>r.id===t);a!==-1&&(c.value.splice(a,1),P.value.total-=1)}),console.log("Deleted orders:",e),u.success("Orders deleted successfully")}catch(t){throw u.error("Failed to bulk delete orders"),console.error("Failed to bulk delete orders:",t),t}};return{orders:c,loading:i,error:v,notifications:ae,dialog:S,bulkActionDialog:w,selectedOrderId:F,selectedOrder:b,initialized:N,isCreateMode:x,orderFilterStatus:C,orderFilterProduct:D,orderFilterZone:k,orderFilterAgent:m,orderFilterRider:R,orderFilterVendor:j,orderFilterCity:E,orderFilterCategory:T,deliveryDateRange:p,statusDateRange:g,createdDateRange:f,orderSearch:_,deliveryDateRange:p,statusDateRange:g,createdDateRange:f,orderSearch:_,orderStatusOptions:re,productOptions:L,categoryOptions:M,cityOptions:V,zoneOptions:W,agentOptions:Z,riderOptions:G,vendorOptions:H,clientOptions:J,warehouseOptions:K,countryOptions:Q,deliveryStatusOptions:se,userOptions:le,statusOptions:X,pagination:P,getOrderById:oe,confirmedOrders:ne,pendingOrders:ie,cancelledOrders:ce,totalRevenue:de,activeFilterCount:ue,currentFilters:ve,printOrders:pe,fetchOrders:U,loadOrder:Y,createOrder:ge,updateOrder:q,updateOrderCustomer:ye,updateOrderItems:he,deleteOrder:fe,getOrderDetails:I,fetchDropdownOptions:ee,openDialog:we,openCreateDialog:_e,openAssignDeliveryDialog:Ce,openAssignCallCentreDialog:De,openBulkStatusDialog:ke,dialogType:y,dialogTitle:h,bulkActionForm:B,openDeleteDialog:me,closeBulkActionDialog:te,handleBulkAction:Re,closeDialog:Oe,clearAllFilters:Ae,applyFilters:Fe,initialize:be}});export{Ve as u};
