import{E as G,i as H,r as f,P as J,j as C,l as a,c as O,o as I,w as n,b as o,a as S,f as v,y as Q,e as X,t as Y}from"./app-OPKBOKwT.js";import{_ as Z}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ee=G("stkpush",{state:()=>({loading:!1,error:null,success:!1,lastRequest:null,lastResponse:null}),getters:{isLoading:s=>s.loading,hasError:s=>!!s.error,errorMessage:s=>s.error,isSuccess:s=>s.success},actions:{async initiateStkPush(s){var _,h;this.loading=!0,this.error=null,this.success=!1,this.lastRequest=s;try{const l=await H.post("/api/v1/payments/mpesa/stk-push",{order_no:s.orderId,phone:s.phone,amount:s.amount,description:s.description||"Courier Payment"});return this.lastResponse=l.data,this.success=!0,l.data}catch(l){throw this.error=((h=(_=l.response)==null?void 0:_.data)==null?void 0:h.message)||l.message||"Failed to initiate STK Push",l}finally{this.loading=!1}},reset(){this.loading=!1,this.error=null,this.success=!1,this.lastRequest=null,this.lastResponse=null}}}),te={__name:"Stkpush",props:{order:{type:Object,default:null}},emits:["stkPushInitiated","success","error"],setup(s,{expose:_,emit:h}){const l=s,V=h,K=ee(),g=f(!1),b=f(null),i=f(null),m=f(""),d=f(!1),t=J({orderNumber:"",orderPhone:"",paymentPhone:"",amount:"",description:""}),x={required:r=>!!r||"This field is required",phone:r=>{if(!r)return!0;const e=k(r);return e.length===12&&e.startsWith("254")||"Invalid phone number format"},amount:r=>r?parseFloat(r)>0||"Amount must be greater than 0":!0},U=C(()=>i.value==="success"?"success":i.value==="error"?"error":(i.value==="loading","info")),E=C(()=>i.value==="success"?"mdi-check-circle":i.value==="error"?"mdi-alert-circle":i.value==="loading"?"mdi-loading mdi-spin":"mdi-information"),k=r=>{let e=r.replace(/\D/g,"");return e.startsWith("254")?e:e.startsWith("0")?"254"+e.substring(1):e.length===9?"254"+e:e},N=async()=>{const{valid:r}=await b.value.validate();if(r){i.value="loading",d.value=!0,m.value="Sending STK push request...";try{const e={orderId:t.orderNumber,phone:k(t.paymentPhone||t.orderPhone||""),amount:parseFloat(t.amount),description:t.description||"Order payment"};V("stkPushInitiated",e),await K.initiateStkPush(e),i.value="success",m.value=`STK push sent successfully to ${k(t.paymentPhone)}. Customer will receive payment prompt shortly.`,V("success",e),setTimeout(()=>{y()},3e3)}catch(e){i.value="error",m.value=e.message||"Failed to send STK push. Please verify the phone number and try again.",V("error",e)}finally{d.value=!1}}},F=()=>{var r,e;t.orderNumber="",t.orderPhone="",t.paymentPhone="",t.amount="",t.description="",i.value=null,m.value="",d.value=!1,(r=b.value)==null||r.reset(),(e=b.value)==null||e.resetValidation()},M=(r=null)=>{var e,p;r?(t.orderNumber=r.order_no||r.id||"",t.orderPhone=r.phone||((e=r.customer)==null?void 0:e.phone)||"",t.amount=r.amount||r.total_price||""):l.order&&(t.orderNumber=l.order.order_no||l.order.id||"",t.orderPhone=l.order.phone||((p=l.order.customer)==null?void 0:p.phone)||"",t.amount=l.order.amount||l.order.total_price||""),g.value=!0},y=()=>{g.value=!1,setTimeout(F,300)};return _({openDialog:M,closeDialog:y}),(r,e)=>{const p=a("v-icon"),q=a("v-spacer"),w=a("v-btn"),j=a("v-card-title"),T=a("v-divider"),P=a("v-text-field"),c=a("v-col"),z=a("v-textarea"),A=a("v-alert"),B=a("v-row"),W=a("v-form"),R=a("v-card-text"),D=a("v-card-actions"),$=a("v-card"),L=a("v-dialog");return I(),O(L,{modelValue:g.value,"onUpdate:modelValue":e[5]||(e[5]=u=>g.value=u),"max-width":"500",persistent:""},{default:n(()=>[o($,null,{default:n(()=>[o(j,{class:"bg-success text-white d-flex align-center pa-4"},{default:n(()=>[o(p,{size:"large",class:"mr-3"},{default:n(()=>e[6]||(e[6]=[v("mdi-cellphone-check")])),_:1,__:[6]}),e[7]||(e[7]=S("div",null,[S("div",{class:"text-h6"},"M-PESA Payment"),S("div",{class:"text-caption opacity-90"}," Send STK Push Request ")],-1)),o(q),o(w,{icon:"mdi-close",variant:"text",size:"small",onClick:y})]),_:1,__:[7]}),o(T),o(R,{class:"pa-6"},{default:n(()=>[o(W,{ref_key:"formRef",ref:b,onSubmit:Q(N,["prevent"])},{default:n(()=>[o(B,{dense:""},{default:n(()=>[o(c,{cols:"12"},{default:n(()=>[o(P,{modelValue:t.orderNumber,"onUpdate:modelValue":e[0]||(e[0]=u=>t.orderNumber=u),label:"Order Number","prepend-inner-icon":"mdi-package-variant",placeholder:"e.g., ORD-2024-001",variant:"outlined",density:"comfortable",rules:[x.required],required:""},null,8,["modelValue","rules"])]),_:1}),o(c,{cols:"12"},{default:n(()=>[o(P,{modelValue:t.orderPhone,"onUpdate:modelValue":e[1]||(e[1]=u=>t.orderPhone=u),label:"Order Phone Number (Optional)","prepend-inner-icon":"mdi-phone",placeholder:"e.g., 0712345678",variant:"outlined",density:"comfortable"},null,8,["modelValue"])]),_:1}),o(c,{cols:"12"},{default:n(()=>[o(P,{modelValue:t.paymentPhone,"onUpdate:modelValue":e[2]||(e[2]=u=>t.paymentPhone=u),label:"Payment Phone Number","prepend-inner-icon":"mdi-cellphone",placeholder:"e.g., 0712345678 or 254712345678",variant:"outlined",density:"comfortable",hint:"The number that will receive the payment prompt","persistent-hint":"",required:""},null,8,["modelValue"])]),_:1}),o(c,{cols:"12"},{default:n(()=>[o(P,{modelValue:t.amount,"onUpdate:modelValue":e[3]||(e[3]=u=>t.amount=u),label:"Amount (KES)",placeholder:"e.g., 1500",type:"number",variant:"outlined",density:"comfortable",rules:[x.required,x.amount],required:""},null,8,["modelValue","rules"])]),_:1}),o(c,{cols:"12"},{default:n(()=>[o(z,{modelValue:t.description,"onUpdate:modelValue":e[4]||(e[4]=u=>t.description=u),label:"Description (Optional)",placeholder:"e.g., Courier delivery payment",variant:"outlined",density:"comfortable",rows:"2","auto-grow":""},null,8,["modelValue"])]),_:1}),i.value?(I(),O(c,{key:0,cols:"12"},{default:n(()=>[o(A,{type:U.value,icon:E.value,variant:"tonal",density:"comfortable"},{default:n(()=>[v(Y(m.value),1)]),_:1},8,["type","icon"])]),_:1})):X("",!0)]),_:1})]),_:1},512)]),_:1}),o(T),o(D,{class:"pa-4"},{default:n(()=>[o(q),o(w,{variant:"outlined",onClick:y,disabled:d.value},{default:n(()=>e[8]||(e[8]=[v(" Cancel ")])),_:1,__:[8]},8,["disabled"]),o(w,{color:"success",variant:"flat",onClick:N,loading:d.value,disabled:d.value,"prepend-icon":"mdi-send"},{default:n(()=>e[9]||(e[9]=[v(" Send Request ")])),_:1,__:[9]},8,["loading","disabled"])]),_:1}),o(R,{class:"bg-grey-lighten-4 text-center pa-3"},{default:n(()=>[o(p,{size:"small",color:"info",class:"mr-1"},{default:n(()=>e[10]||(e[10]=[v("mdi-information")])),_:1,__:[10]}),e[11]||(e[11]=S("span",{class:"text-caption text-medium-emphasis"}," The customer will receive an M-PESA prompt on their phone ",-1))]),_:1,__:[11]})]),_:1})]),_:1},8,["modelValue"])}}},oe=Z(te,[["__scopeId","data-v-579d8b7f"]]),se=Object.freeze(Object.defineProperty({__proto__:null,default:oe},Symbol.toStringTag,{value:"Module"}));export{oe as S,se as a,ee as u};
